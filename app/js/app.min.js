/*! zhoujiaqiang | shilei | liuxiaolin; last modify： 2017-09-15 */
"use strict";var myApp=angular.module("myApp",["ngRoute","ngCookies","ngAnimate","ngTouch","myControllers","myServices","myDirectives"]);myApp.constant("ST",{v:"?v="+(new Date).getTime()}),myApp.config(function($httpProvider,$routeProvider,ST){$httpProvider.defaults.headers.post["Content-Type"]="application/x-www-form-urlencoded; charset=UTF-8",$httpProvider.interceptors.push("myInterceptor"),$routeProvider.when("/index",{templateUrl:"partials/index.html"+ST.v,controller:"IndexCtrl",access:!0}).when("/login",{templateUrl:"partials/login.html"+ST.v,controller:"LoginCtrl",access:!0}).when("/register1",{templateUrl:"partials/register1.html"+ST.v,controller:"Register1Ctrl",access:!0}).when("/register2/:mobile",{templateUrl:"partials/register2.html"+ST.v,controller:"Register2Ctrl",access:!0}).when("/trade",{templateUrl:"partials/trade.html"+ST.v,controller:"TradeCtrl",access:!0,resolve:{initData:function(TradeService){return TradeService.getInitTrade().then(function(res){return 100==res.data.code?res.data.data:null})["catch"](function(){return null})}}}).when("/tradeBuy/:stockCode",{templateUrl:"partials/tradeBuy.html"+ST.v,controller:"TradeBuyCtrl",access:!1}).when("/tradeSell",{templateUrl:"partials/tradeSell.html"+ST.v,controller:"TradeSellCtrl",access:!1}).when("/tradeResult",{templateUrl:"partials/tradeResult.html"+ST.v,controller:"TradeResultCtrl",access:!1}).when("/tradeDetail/:tradeId",{templateUrl:"partials/tradeDetail.html"+ST.v,controller:"TradeDetailCtrl",access:!1}).when("/agreementSigned",{templateUrl:"partials/agreementSigned.html"+ST.v,controller:"AgreementSignedCtrl",access:!0}).when("/agreementTrade",{templateUrl:"partials/agreementTrade.html"+ST.v,controller:"AgreementTradeCtrl",access:!0}).when("/agreementSaletor",{templateUrl:"partials/agreementSaletor.html"+ST.v,controller:"AgreementSaletorCtrl",access:!0}).when("/agreementInvestor",{templateUrl:"partials/agreementInvestor.html"+ST.v,controller:"AgreementInvestorCtrl",access:!0}).when("/agreementRegister",{templateUrl:"partials/agreementRegister.html"+ST.v,controller:"AgreementRegister",access:!0}).when("/mine",{templateUrl:"partials/mine.html"+ST.v,controller:"MineCtrl",access:!0}).when("/mineSearch",{templateUrl:"partials/mineSearch.html"+ST.v,controller:"MineSearchCtrl",access:!0}).when("/mineModify",{templateUrl:"partials/mineModify.html"+ST.v,controller:"MineModifyCtrl",access:!0}).when("/myHome",{templateUrl:"partials/myHome.html"+ST.v,controller:"MyHomeCtrl",access:!1}).when("/myInfo",{templateUrl:"partials/myInfo.html"+ST.v,controller:"MyInfoCtrl",access:!1}).when("/forgetUserPass",{templateUrl:"partials/forgetUserPass.html"+ST.v,controller:"ForgetUserPassCtrl",access:!0}).when("/forgetTradePass",{templateUrl:"partials/forgetTradePass.html"+ST.v,controller:"ResetTradePassCtrl",access:!1}).when("/userPassModify",{templateUrl:"partials/userPassModify.html"+ST.v,controller:"UserPassModifyCtrl",access:!1}).when("/identification",{templateUrl:"partials/identification.html"+ST.v,controller:"IdentificationCtrl",access:!1}).when("/tradePassSet",{templateUrl:"partials/tradePassSet.html"+ST.v,controller:"TradePassSetCtrl",access:!1}).when("/tradePassModify",{templateUrl:"partials/tradePassModify.html"+ST.v,controller:"TradePassModifyCtrl",access:!1}).when("/payType",{templateUrl:"partials/payType.html"+ST.v,controller:"PayTypeCtrl",access:!1}).when("/payBank",{templateUrl:"partials/payBank.html"+ST.v,controller:"PayBankCtrl",access:!1}).when("/payMobile",{templateUrl:"partials/payMobile.html"+ST.v,controller:"PayMobileCtrl",access:!1}).when("/paySuccess",{templateUrl:"partials/paySuccess.html"+ST.v,controller:"PaySuccessCtrl",access:!1}).when("/bankInfo",{templateUrl:"partials/bankInfo.html"+ST.v,controller:"BankInfoCtrl",access:!1}).when("/bankCardList",{templateUrl:"partials/bankCardList.html"+ST.v,controller:"BankCardListCtrl",access:!1}).when("/addBankCard",{templateUrl:"partials/addBankCard.html"+ST.v,controller:"AddBankCardCtrl",access:!1}).when("/modifyBankCard/:bankCardId",{templateUrl:"partials/modifyBankCard.html"+ST.v,controller:"ModifyBankCardCtrl",access:!1}).when("/withdraw",{templateUrl:"partials/withdraw.html"+ST.v,controller:"WithdrawCtrl",access:!1}).when("/fund",{templateUrl:"partials/fund.html"+ST.v,controller:"FundCtrl",access:!1}).when("/notice",{templateUrl:"partials/notice.html"+ST.v,controller:"NoticeCtrl",access:!1}).when("/noticeDetail/:noticeId",{templateUrl:"partials/noticeDetail.html"+ST.v,controller:"NoticeDetailCtrl",access:!1}).when("/help",{templateUrl:"partials/help.html"+ST.v,controller:"HelpCtrl",access:!0}).when("/helpDetail/:helpDetailId",{templateUrl:"partials/helpDetail.html"+ST.v,controller:"HelpDetailCtrl",access:!0}).when("/helpCenter",{templateUrl:"partials/helpCenter.html"+ST.v,controller:"HelpCenterCtrl",access:!1}).when("/helpAsk",{templateUrl:"partials/helpAsk.html"+ST.v,controller:"HelpAskCtrl",access:!1}).when("/guide",{templateUrl:"partials/guide.html"+ST.v,controller:"GuideCtrl",access:!0}).when("/tradeRule",{templateUrl:"partials/tradeRule.html"+ST.v,controller:"TradeRuleCtrl",access:!0}).when("/safe",{templateUrl:"partials/safe.html"+ST.v,controller:"SafeCtrl",access:!0}).when("/aboutUs",{templateUrl:"partials/aboutUs.html"+ST.v,controller:"AboutUsCtrl",access:!0}).when("/introduce",{templateUrl:"partials/introduce.html"+ST.v,controller:"IntroduceCtrl",access:!0}).when("/alipay",{templateUrl:"partials/alipay.html"+ST.v,controller:"AlipayCtrl",access:!1}).when("/alipayDetail",{templateUrl:"partials/alipayDetail.html"+ST.v,controller:"AlipayDetailCtrl",access:!1}).when("/myStrategyGroup",{templateUrl:"partials/myStrategyGroup.html"+ST.v,controller:"MyStrategyGroupCtrl",access:!1}).when("/suspendStocks",{templateUrl:"partials/suspendStocks.html"+ST.v,controller:"SuspendStocksCtrl",access:!1}).when("/article-20160831",{templateUrl:"partials/article-20160831.html"+ST.v,controller:"ArticleCtrl",access:!0}).when("/article-20161021",{templateUrl:"partials/article-20161021.html"+ST.v,controller:"ArticleCtrl",access:!0}).when("/attention",{templateUrl:"partials/attention.html"+ST.v,controller:"AttentionCtrl",access:!1}).when("/discover",{templateUrl:"partials/discover.html"+ST.v,controller:"DiscoverCtrl",access:!0}).when("/oneYuanIntroduce",{templateUrl:"partials/oneYuanIntroduce.html"+ST.v,controller:"OneYuanIntroduceCtrl",access:!0}).when("/oneYuanTrade",{templateUrl:"partials/oneYuanTrade.html"+ST.v,controller:"OneYuanTradeCtrl",access:!1,resolve:{initData:function(TradeService){return TradeService.initOneyuan().then(function(res){return 100==res.data.code?res.data.data:null})["catch"](function(){return null})}}}).when("/oneYuanTradeSell",{templateUrl:"partials/oneYuanTradeSell.html"+ST.v,controller:"OneYuanTradeSellCtrl",access:!1}).when("/oneYuanTradeResult",{templateUrl:"partials/oneYuanTradeResult.html"+ST.v,controller:"OneYuanTradeResultCtrl",access:!1}).when("/aliPayIdentification",{templateUrl:"partials/aliPayIdentification.html"+ST.v,controller:"AliPayIdentificationCtrl",access:!1}).when("/TDTrade",{templateUrl:"partials/TDTrade.html"+ST.v,controller:"TDTradeCtrl",access:!0,resolve:{initData:function(TradeService){return TradeService.initTDTrade().then(function(res){return 100==res.data.code?res.data.data:null})["catch"](function(){return null})}}}).when("/TDTradeBuy",{templateUrl:"partials/TDTradeBuy.html"+ST.v,controller:"TDTradeBuyCtrl",access:!0,resolve:{initData:function(TradeService){return TradeService.initTDTrade().then(function(res){return 100==res.data.code?res.data.data:null})["catch"](function(){return null})}}}).when("/TDTradeSell",{templateUrl:"partials/TDTradeSell.html"+ST.v,controller:"TDTradeSellCtrl",access:!1}).when("/TDTradeResult",{templateUrl:"partials/TDTradeResult.html"+ST.v,controller:"TDTradeResultCtrl",access:!1}).when("/TDTradeDetail/:tradeId",{templateUrl:"partials/TDTradeDetail.html"+ST.v,controller:"TradeDetailCtrl",access:!1}).when("/suspendDetail/:tradeId",{templateUrl:"partials/suspendDetail.html"+ST.v,controller:"TradeDetailCtrl",access:!1}).when("/historyStrategies",{templateUrl:"partials/historyStrategies.html"+ST.v,controller:"historyStrategiesCtrl",access:!1}).when("/strategyDetail",{templateUrl:"partials/strategyDetail.html"+ST.v,controller:"strategyDetailCtrl",access:!1}).when("/TDApply",{templateUrl:"partials/TDApply.html"+ST.v,controller:"TDApplyCtrl",access:!1}).when("/TDApplyConfirm",{templateUrl:"partials/TDApplyConfirm.html"+ST.v,controller:"TDApplyConfirmCtrl",access:!1}).when("/agreementTDInvestor",{templateUrl:"partials/agreementTDInvestor.html"+ST.v,controller:"AgreementInvestorCtrl",access:!0}).when("/agreementTDSaletor",{templateUrl:"partials/agreementTDSaletor.html"+ST.v,controller:"AgreementSaletorCtrl",access:!0}).when("/TDTradeRule",{templateUrl:"partials/TDTradeRule.html"+ST.v,controller:"TradeRuleCtrl",access:!0}).when("/simulateStock",{templateUrl:"partials/simulateStock.html"+ST.v,controller:"SimulateStockCtrl",access:!0}).when("/simulateTrade",{templateUrl:"partials/simulateTrade.html"+ST.v,controller:"SimulateTradeCtrl",access:!1,resolve:{initData:function(SimulateService){return SimulateService.initSimTrade().then(function(res){return 100==res.data.code?res.data.data:900==res.data.code?res.data.resultMsg:null})["catch"](function(){return null})}}}).when("/simulateTradeBuy/:stockCode",{templateUrl:"partials/simulateTradeBuy.html"+ST.v,controller:"SimulateTradeBuyCtrl",access:!1}).when("/simulateTradeSell",{templateUrl:"partials/simulateTradeSell.html"+ST.v,controller:"SimulateTradeSellCtrl",access:!1}).when("/simulateTradeResult",{templateUrl:"partials/simulateTradeResult.html"+ST.v,controller:"SimulateTradeResultCtrl",access:!1}).when("/simulateTradeDetail/:tradeId",{templateUrl:"partials/simulateTradeDetail.html"+ST.v,controller:"SimulateTradeDetailCtrl",access:!1}).when("/extension",{templateUrl:"partials/extension.html"+ST.v,controller:"ExtensionCtrl",access:!0}).when("/phoneBind1",{templateUrl:"partials/phoneBind1.html"+ST.v,controller:"PhoneBind1Ctrl",access:!1}).when("/phoneBind2",{templateUrl:"partials/phoneBind2.html"+ST.v,controller:"PhoneBind2Ctrl",access:!1}).when("/dayGainList",{templateUrl:"partials/dayGainList.html"+ST.v,controller:"DayGainListCtrl",access:!0}).when("/activityCenter",{templateUrl:"partials/activityCenter.html"+ST.v,controller:"ActivityCenterCtrl",access:!0}).when("/actPacket",{templateUrl:"partials/actPacket.html"+ST.v,controller:"ActPacketCtrl",access:!0}).when("/myPacket",{templateUrl:"partials/myPacket.html"+ST.v,controller:"MyPacketCtrl",access:!1}).otherwise({redirectTo:"/index"})}).run(function($rootScope,$location,AuthService){$rootScope.$on("$routeChangeStart",function(evt,next){var key,goURL=next.originalPath;if(next.originalPath&&!next.access){for(key in next.params)goURL=goURL.replace(":"+key,next.params[key]);X.log("-----路由拦截 URL:"+goURL+"-----"),AuthService.auth()?X.log("-----用户已登录，放行-----"):(X.log("-----用户未登录，跳转到登录-----"),evt.preventDefault(),$location.path("/login").search({goURL:goURL}))}else X.log("-----路由放行 URL:"+next.originalPath+"-----")})});var myControllers=angular.module("myControllers",[]);myControllers.controller("IndexCtrl",function($scope,$swipe,$q,$interval,UserService,TradeService,SystemService,StockService,IndexService){function getShowData(){isInQuoteTime=SystemService.isInPeriod("STOCK","quote"),!isHoliday&&isInQuoteTime?IndexService.getTradingInfo().then(function(res){var data=res.data;100==data.code?calTimeColor(data):X.tip(data.resultMsg)})["catch"](function(){X.tip("服务器请求异常")}):calTimeColor(cldtData)}function calTimeColor(data){var cldtList=data.data,id=1;for(var i in data.data)cldtList[i].diffTime=calTime(cldtList[i].tradingTime),cldtList[i].buyPriceDeal=(parseInt(100*cldtList[i].buyPriceDeal)/100).toFixed(2),1==id||4==id||7==id?cldtList[i].status="red":2==id||5==id?cldtList[i].status="blue":3!=id&&6!=id||(cldtList[i].status="yellow"),id++;$scope.cldtList=cldtList}function calTime(time){var diff,localTime=(new Date).getTime(),diffTime=localTime-time;return diff=diffTime<6e4?"1分钟":diffTime<36e5?parseInt(diffTime/6e4)+"分钟":diffTime>36e5&&diffTime<864e5?parseInt(diffTime/36e5)+"小时":parseInt(diffTime/864e5)+"天"}function query(){getStockInfo(),isInQuoteTime=SystemService.isInPeriod("STOCK","quote"),!isHoliday&&isInQuoteTime&&dataIsLoaded&&(dataIsLoaded=!1,X.engine.addTask(getStockInfo,1e3),X.engine.start())}function getStockInfo(){X.log("行情定时器运行中。。。"),StockService.getStockInfo(stockCodes.join(",")).then(function(res){dataIsLoaded=!0;var infoData=res.data;100==infoData.code?processStockInfoData(infoData.data):X.tip(infoData.resultMsg),X.loading.hide()})["catch"](function(){dataIsLoaded=!0,X.tip("服务器请求异常")})}function processStockInfoData(data){$scope.dataLoaded=!0,$scope.defaultList=[];var dataList=[];$.each(stockCodes,function(i,item){var obj=data[item],stockObj={};if(obj){stockObj.stockName=obj.stockName;var lastClosePrice=obj.lastClosePrice,price=obj.newPrice,diff=price-lastClosePrice,rote=diff/lastClosePrice*100;stockObj.price=price.toFixed(2),stockObj.rote=rote.toFixed(2),stockObj.diff=diff.toFixed(2),dataList.push(stockObj)}}),$scope.defaultList=dataList}function getBanner(){UserService.getHeader().then(function(res){var data=res.data;if(100==data.code){var headerData=data.data;getArr(headerData),$scope.ad.id&&$scope.ad.imgUrl&&adPop($scope.ad.id)}else X.tip(data.resultMsg);X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")})}function getArr(data){var arr=[];for(var i in data)arr[i]={id:data[i][0],type:data[i][2],imgUrl:data[i][3],link:data[i][5]||"",btnText:data[i][6]||"",btnLink:data[i][8]||""},1==arr[i].type?banner.push(arr[i]):$scope.ad=arr[i];X.slide.init("mod-slide",banner,$swipe)}function adPop(id){var storage=window.localStorage,AD="AD",adStr=storage.getItem(AD)||"";""!=adStr&&adStr==id||($scope.showAd=!0,storage.setItem(AD,id))}var cldtData,clbdData,banner=[],stockCodes=["SH000001","SZ399001","SZ399006"],isInQuoteTime=!1,isHoliday=!0,dataIsLoaded=!0;$scope.defaultList=[],$scope.dataLoaded=!1,$scope.actType="cpdr",$scope.strategies=[],$scope.users=[],$scope.ad={},$scope.showAd=!1,X.loading.show(),$q.all({tradeInit:TradeService.getInitTrade(),cldt:IndexService.getTradingInfo(),clbd:IndexService.getStrategyWeekData()}).then(function(res){var tradeInitData=res.tradeInit.data;if(cldtData=res.cldt.data,clbdData=res.clbd.data,100==tradeInitData.code&&100==cldtData.code&&100==clbdData.code){var initData=tradeInitData.data;$scope.clbdList=clbdData.data,isHoliday=initData.isHoliday,SystemService.setCurrentTime(initData.nowTime),getShowData(),query()}else 100!=tradeInitData.code?X.tip(tradeInitData.resultMsg):100!=cldtData.code?X.tip(cldtData.resultMsg):100!=clbdData.code&&X.tip(clbdData.resultMsg);X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")}),X.engine.addTask(getShowData,6e4),X.engine.start(),$scope.toDetail=function(obj){if(obj.link){var link=obj.link;if(obj.btnText&&obj.btnLink){var btnText=encodeURIComponent(obj.btnText),btnLink=encodeURIComponent(obj.btnLink);link=link+"?btnText="+btnText+"&btnLink="+btnLink}window.location=link}},getBanner(),$scope.$on("$destroy",function(){X.engine.destroy()})}),myControllers.controller("LoginCtrl",function($rootScope,$interval,$scope,$location,LoginService,AuthService){function timerFn(){timer=$interval(function(){$scope.btnState="disable",""!=$scope.form.username&&""!=$scope.form.password?$scope.btnState="orange":""!=$scope.form.username&&""!=$scope.form.password||($scope.state="")},100)}$scope.goURL=$location.search().goURL||"/myHome";var timer=null;$scope.btnState="",$scope.form={username:"",password:""},$scope.login=function(){""!=$scope.form.username&&""!=$scope.form.password&&(X.loading.show(),LoginService.login($scope.form.username,$scope.form.password).then(function(res){var data=res.data;data.authenticated?($rootScope.isLogin=!0,"/login"==$scope.goURL&&($scope.goURL="/myHome"),AuthService.signIn(data.userId),$location.url($scope.goURL),zhuge.identify(data.userId)):X.tip(data.resultMsg),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")}))},$scope.$on("$destroy",function(){timer&&$interval.cancel(timer)}),timerFn()}),myControllers.controller("Register1Ctrl",function($scope,$interval,$location,RegisterService){function goNextStep(){"disable"!==$scope.btnState&&(X.loading.show(),RegisterService.regNextStep($scope.mobile,$scope.checkCode).then(function(res){var data=res.data;100==data.code?($location.path("/register2/"+$scope.mobile),zhuge.track("注册-开始注册")):X.tip(data.resultMsg),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")}))}function timerFn(){timer=$interval(function(){$scope.state="",$scope.btnState="disable",$scope.mobile.length>0?$scope.state="-orange":""==$scope.mobile&&($scope.state=""),11==$scope.mobile.length&&""!=$scope.checkCode?$scope.btnState="orange":$scope.btnState="disable"},100)}function timerFunc(){timerSec=setInterval(function(){$scope.time>0?$scope.$apply(function(){$scope.time--}):timerSec&&clearTimeout(timerSec)},1e3)}$scope.mobile="",$scope.state="",$scope.btnState="disable",$scope.agreement=!0,$scope.showCodeDialog=!1,$scope.temptimes=Date.now(),$scope.imgCode="";var timer=null;$scope.time=0,$scope.checkCode="",$scope.register=function(){return X.isMobile($scope.mobile)?""==$scope.checkCode?void X.tip("请输入验证码"):4!=$scope.checkCode.length?void X.tip("验证码输入有误"):void goNextStep():void X.tip("请输入正确的手机号码")},$scope.getImgCode=function(){return""==$scope.mobile?(X.tip("请输入手机号码"),!1):X.isMobile($scope.mobile)?($scope.refreshCode(),void($scope.showCodeDialog=!0)):(X.tip("手机号码输入错误"),!1)},$scope.clearMobile=function(){$scope.mobile&&""!=$scope.mobile&&($scope.mobile="")},$scope.closeDialog=function(){$scope.showCodeDialog=!1,$scope.imgCode=""},$scope.refreshCode=function(){$scope.temptimes=Date.now()},$scope.registerCode=function(){return""==$scope.mobile?(X.tip("请输入手机号码"),!1):X.isMobile($scope.mobile)?""==$scope.imgCode?(X.tip("请输入图片验证码"),!1):/^\d{4}$/.test($scope.imgCode)?(X.log($scope.imgCode),void RegisterService.getRegisterCode($scope.mobile,$scope.imgCode).then(function(res){var data=res.data;100==data.code?($scope.time=60,X.tip("验证码已发送至"+$scope.mobile+"，请稍等 !"),timerFunc(),$scope.closeDialog()):101==data.code?($scope.time=data.data.interval,X.tip("验证码已发送至"+$scope.mobile+"，请稍等 !"),timerFunc(),$scope.closeDialog()):X.tip(data.resultMsg)})["catch"](function(){X.tip("服务器请求异常")})):(X.tip("图片验证码输入错误"),4==$scope.imgCode&&$scope.refreshCode(),!1):(X.tip("手机号码输入错误"),!1)};var timerSec=null;$scope.$on("$destroy",function(){timer&&$interval.cancel(timer),timerSec&&$interval.cancel(timerSec)}),timerFn(),timerFunc()}),myControllers.controller("Register2Ctrl",function($scope,$interval,$location,$routeParams,AuthService,RegisterService){function timerFnc(){timer=$interval(function(){$scope.btnState="disable",""!=$scope.checkCode&&""!=$scope.password&&""!=$scope.username?$scope.btnState="orange":$scope.btnState="disable"},100)}var timer=null;$scope.time=0,$scope.password="",$scope.username="",$scope.surepass="",$scope.mobile=$routeParams.mobile||"",""==$scope.mobile&&$location.url("/register1"),$scope.pswType="password",$scope.register=function(){var username=$.trim($scope.username);if(""!=username&&""!=$scope.password&&""!=$scope.checkCode){if(!/^\w{4,16}$/.test($scope.password)||/^\d+$/.test($scope.password)||/^([a-zA-Z]+)$/.test($scope.password))return X.tip("登录密码为6-16位数字和字母组成"),!1;if(X.strLen(username)<4||X.strLen(username)>16)return X.tip("用户名为4-16个字符，中文算2个字符"),!1;if(!/^[0-9a-zA-Z_\u4e00-\u9fa5]+$/.test(username))return X.tip("用户名只允许字母、数字、下划线或中文"),!1;if(!/^\w{6,16}$/.test($scope.password)||/^\d+$/.test($scope.password)||/^([a-zA-Z]+)$/.test($scope.password))return X.tip("登录密码为6-16位数字和字母组成"),!1;if($scope.password!=$scope.surepass)return X.tip("确认密码与密码不一致"),!1;X.loading.show(),RegisterService.doRegister($scope.mobile,$scope.username,$scope.password).then(function(res){var data=res.data;100==data.code?(X.tip("注册成功"),$location.path("/myHome"),zhuge.track("注册-完成注册"),AuthService.signIn(data.userId)):X.tip(data.resultMsg),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")})}},$scope.showPsw=function(){"password"==$scope.pswType?$scope.pswType="text":$scope.pswType="password"},$scope.$on("$destroy",function(){timer&&$interval.cancel(timer)}),timerFnc(),$scope.$on("$destroy",function(){timer&&clearTimeout(timer)})}),myControllers.controller("ForgetUserPassCtrl",function($scope,$interval,$location,PasswordService){function timerFnc(){timer=$interval(function(){$scope.btnState="disable",""!=$scope.mobile&&""!=$scope.checkCode&&""!=$scope.newPass&&""!=$scope.confirmPass?$scope.btnState="orange":$scope.btnState="disable"},100)}function timerFn(){timer=setInterval(function(){$scope.time>0?$scope.$apply(function(){$scope.time--}):timer&&clearTimeout(timer)},1e3)}var timer=null;$scope.time=0,$scope.mobile="",$scope.checkCode="",$scope.newPass="",$scope.confirmPass="",$scope.btnState="disable",$scope.forgetUserPass=function(){if(""!=$scope.mobile&&""!=$scope.newPass&&""!=$scope.confirmPass&&""!=$scope.confirmPass){if(!X.isMobile($scope.mobile))return X.tip("手机号码错误"),!1;if(6!=$scope.checkCode.length)return X.tip("验证码输入错误"),!1;if(!/^\w{6,16}$/.test($scope.newPass)||/^\d+$/.test($scope.newPass)||/^([a-zA-Z]+)$/.test($scope.newPass))return X.tip("登录密码为6-16位数字和字母组成"),!1;if($scope.confirmPass!=$scope.newPass)return X.tip("两次密码输入不一致"),!1;X.loading.show(),PasswordService.resetForgetPassword($scope.mobile,$scope.checkCode,$scope.newPass).then(function(res){var data=res.data;100==data.code?(X.tip("密码重置成功，请重新登录"),$location.path("/login")):X.tip(data.resultMsg),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")})}},$scope.getImgCode=function(){return""==$scope.mobile?(X.tip("请输入手机号码"),!1):X.isMobile($scope.mobile)?($scope.refreshCode(),void($scope.showCodeDialog=!0)):(X.tip("手机号码输入错误"),!1)},$scope.closeDialog=function(){$scope.showCodeDialog=!1,$scope.imgCode=""},$scope.refreshCode=function(){$scope.temptimes=Date.now()},$scope.sendCode=function(){return""==$scope.mobile?(X.tip("请输入手机号码"),!1):X.isMobile($scope.mobile)?""==$scope.imgCode?(X.tip("请输入图片验证码"),!1):/^\d{4}$/.test($scope.imgCode)?(X.loading.show(),void PasswordService.sendForgetCode($scope.mobile,$scope.imgCode).then(function(res){var data=res.data;100==data.code?($scope.closeDialog(),X.tip("验证码已发送至手机，请注意查收"),$scope.time=60,timerFn()):101==data.code?($scope.closeDialog(),X.tip("验证码已发送至手机，请注意查收"),$scope.time=data.data.interval,timerFn()):(X.tip(data.resultMsg),$scope.refreshCode()),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")})):(X.tip("图片验证码输入错误"),4==$scope.imgCode&&$scope.refreshCode(),!1):(X.tip("手机号码输入错误"),!1)},$scope.$on("$destroy",function(){timer&&$interval.cancel(timer)}),timerFnc(),$scope.getCheckCode=function(){return X.isMobile($scope.mobile)?void PasswordService.sendForgetCode($scope.mobile).then(function(res){var data=res.data;100==data.code?($scope.time=60,X.tip("验证码已发送至手机，请注意查收"),timerFn()):101==data.code?($scope.time=data.data.interval,timerFn()):X.tip(data.resultMsg)})["catch"](function(){X.tip("服务器请求异常")}):(X.tip("请输入正确的手机号码"),!1)},$scope.$on("$destroy",function(){timer&&clearTimeout(timer)})}),myControllers.controller("IdentificationCtrl",function($scope,$interval,$location,UserService){function timerFnc(){timer=$interval(function(){""!=$scope.name&&""!=$scope.IDNum?$scope.btnState="orange":$scope.btnState="disable"},100)}$scope.goURL=$location.search().goURL||"/myInfo",$scope.name="",$scope.IDNum="",$scope.btnState="disable";var timer=null;$scope.certification=function(){if(""!=$scope.name&&""!=$scope.IDNum){if(!X.isChinaName($scope.name))return X.tip("请输入正确的姓名"),!1;if(!X.isIdentityNumber($scope.IDNum))return X.tip("身份证号码错误"),!1;X.loading.show(),UserService.realName($scope.name,$scope.IDNum).then(function(res){var data=res.data;100==data.code?(X.tip("实名认证成功"),$location.url($scope.goURL)):X.tip(data.resultMsg),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")})}},$scope.$on("$destroy",function(){timer&&$interval.cancel(timer)}),timerFnc()}),myControllers.controller("UserPassModifyCtrl",function($scope,$interval,$location,PasswordService,AuthService){function timerFnc(){timer=$interval(function(){""!=$scope.oldPassword&&""!=$scope.newPassword&&""!=$scope.surePassword?$scope.btnState="orange":$scope.btnState="disable"},100)}$scope.oldPassword="",$scope.newPassword="",$scope.surePassword="",$scope.btnState="disable";var timer=null;$scope.changePass=function(){if(""!=$scope.oldPassword&&""!=$scope.newPassword&&""!=$scope.surePassword){if(!/^\w{6,16}$/.test($scope.newPassword)||/^\d+$/.test($scope.newPassword)||/^([a-zA-Z]+)$/.test($scope.newPassword))return X.tip("密码为6-16位数字和字母组成"),!1;if($scope.surePassword!=$scope.newPassword)return X.tip("新密码与确认密码不一致"),!1;if($scope.newPassword==$scope.oldPassword)return X.tip("新密码不能与原始密码相同"),!1;X.loading.show(),PasswordService.loginPwdModify($scope.oldPassword,$scope.newPassword).then(function(res){var data=res.data;100==data.code?(X.tip("密码修改成功，请重新登录"),AuthService.signOut(),$location.path("/login")):X.tip(data.resultMsg),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")})}},$scope.$on("$destroy",function(){timer&&$interval.cancel(timer)}),timerFnc()}),myControllers.controller("TradePassSetCtrl",function($scope,$interval,$location,PasswordService){function timerFnc(){timer=$interval(function(){""!=$scope.password&&""!=$scope.surePassword?$scope.btnState="orange":$scope.btnState="disable"},100)}$scope.goURL=$location.search().goURL||"/myInfo",$scope.password="",$scope.surePassword="",$scope.btnState="disable";var timer=null;$scope.tradePassSet=function(){if(""!=$scope.password&&""!=$scope.surePassword){if(!/^\d{6}$/.test($scope.password))return X.tip("提现密码为6位数字"),!1;if($scope.password!=$scope.surePassword)return X.tip("两次密码不一致"),!1;X.loading.show(),PasswordService.PwdSet($scope.password,$scope.surePassword).then(function(res){var data=res.data;100==data.code?(X.tip("提现密码设置成功"),$location.url($scope.goURL)):X.tip(data.resultMsg),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")})}},$scope.$on("$destroy",function(){timer&&$interval.cancel(timer)}),timerFnc()}),myControllers.controller("TradePassModifyCtrl",function($scope,$interval,$location,PasswordService){function timerFnc(){timer=$interval(function(){""!=$scope.oldPwd&&""!=$scope.newPwd&&""!=$scope.surePwd?$scope.btnState="orange":$scope.btnState="disable"},100)}$scope.oldPwd="",$scope.newPwd="",$scope.surePwd="",$scope.btnState="disable";var timer=null;$scope.tradePassModify=function(){if(""!=$scope.oldPwd&&""!=$scope.newPwd&&""!=$scope.surePwd){if(!/^\d{6}$/.test($scope.oldPwd))return X.tip("原始提现密码为6位数字"),!1;if(!/^\d{6}$/.test($scope.newPwd))return X.tip("提现密码为6位数字"),!1;if($scope.surePwd!=$scope.newPwd)return X.tip("新密码与确认密码不一致"),!1;if($scope.newPwd==$scope.oldPwd)return X.tip("新密码不能与原始密码相同"),!1;X.loading.show(),PasswordService.PwdModify($scope.newPwd,$scope.oldPwd).then(function(res){var data=res.data;100==data.code?(X.tip("提现密码修改成功"),$location.path("/myInfo")):X.tip(data.resultMsg),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")})}},$scope.$on("$destroy",function(){timer&&$interval.cancel(timer)}),timerFnc()}),myControllers.controller("ResetTradePassCtrl",function($scope,$interval,$location,$q,PasswordService,UserService){function timerFnc(){time=$interval(function(){""!=$scope.checkCode&&""!=$scope.password&&""!=$scope.surePassword?$scope.btnState="orange":$scope.btnState="disable"},100)}function timerFn(){timer=setInterval(function(){$scope.time>0?$scope.$apply(function(){$scope.time--}):timer&&clearTimeout(timer)},1e3)}var timer=null;$scope.goURL=$location.search().goURL||"/myInfo",$scope.mobile="",$scope.hideMobile="",$scope.checkCode="",$scope.password="",$scope.surePassword="",$scope.time=0;var time=null;$scope.btnState="disable",X.loading.show(),$q.all({userInfo:UserService.getUserInfo()}).then(function(res){var userInfoData=res.userInfo.data;100==userInfoData.code?($scope.mobile=userInfoData.data.loginMobileNoHidden,$scope.hideMobile=userInfoData.data.loginMobile):X.tip(userInfoData.resultMsg),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")}),$scope.resetTradePassInfo=function(){if(""!=$scope.checkCode&&""!=$scope.password&&""!=$scope.surePassword){if($scope.checkCode.length<6)return X.tip("验证码输入有误"),!1;if(!/^\d{6}$/.test($scope.password))return X.tip("提现密码为6位数字"),!1;if($scope.surePassword!=$scope.password)return X.tip("提现密码与确认密码不符"),!1;X.loading.show(),PasswordService.resetWithdrawPwd($scope.password,$scope.checkCode).then(function(res){var resetWithdrawPwdData=res.data;100==resetWithdrawPwdData.code?(X.tip("提现密码修改成功"),$location.url($scope.goURL)):X.tip(resetWithdrawPwdData.resultMsg),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")})}},$scope.$on("$destroy",function(){time&&$interval.cancel(time)}),timerFnc(),$scope.getPasswordCode=function(){PasswordService.sendPasswordCode($scope.mobile).then(function(res){var data=res.data;100==data.code?($scope.time=60,X.tip("验证码已发送至手机，请注意查收"),timerFn()):101==data.code?($scope.time=data.data.interval,timerFn()):X.tip(data.resultMsg)})["catch"](function(){X.tip("服务器请求异常")})},$scope.$on("$destroy",function(){timer&&clearTimeout(timer)})}),myControllers.controller("MyHomeCtrl",function($scope,$q,$location,UserService,TradeService,SystemService){function bootURL(url){$scope.$apply(function(){$location.url(url)})}$scope.user={},$scope.bankCards=[];var inDYTipTime,DYTip=!1;X.loading.show(),$q.all({userInfo:UserService.getUserInfo(),balance:UserService.getBalance(),bankCards:UserService.getBankCards(),DY:TradeService.getWaitPayDeferForRemind()}).then(function(res){var userInfoData=res.userInfo.data,balanceData=res.balance.data,bankCardsData=res.bankCards.data,DYData=res.DY.data;100==userInfoData.code&&100==balanceData.code&&100==bankCardsData.code&&100==DYData.code?($scope.user=userInfoData.data,$scope.user.balance=balanceData.data.balance,$scope.balance=parseInt(Math.round(1e4*$scope.user.balance)/100)/100,$scope.balance=X.money($scope.balance),$scope.bankCards=bankCardsData.data,0!=DYData.data&&(DYTip=!0)):100!=userInfoData.code?X.tip(userInfoData.resultMsg):100!=balanceData.code?X.tip(balanceData.resultMsg):100!=bankCardsData.code&&X.tip(bankCardsData.resultMsg),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")}),$scope.doWithdraw=function(){return $scope.user.named?0==$scope.user.balance?void X.tip("您的账户没有可提金额"):$scope.bankCards.length?$scope.user.withdrawPw?(inDYTipTime=SystemService.isInDYTipPeriod(),DYTip?void X.dialog.confirm("温馨提示：请您确认是否已经将今日递延<br/>费留在余额中等待扣款，如果继续操作可<br/>能会造成操盘中策略因递延费不足被平仓",{sureBtn:"确定",notify:function(nt){1==nt&&bootURL("/withdraw")}}):void $location.path("/withdraw")):void X.dialog.confirm("您还未设置提现密码",{sureBtn:"马上设置",notify:function(nt){1==nt&&bootURL("/tradePassSet?goURL=/withdraw")}}):void X.dialog.confirm("提款前请先添加提款银行卡",{sureBtn:"添加银行卡",notify:function(nt){1==nt&&bootURL("/addBankCard?goURL=/myHome")}}):void X.dialog.confirm("您还未实名认证，请先实名认证",{notify:function(nt){1==nt&&bootURL("/identification?goURL=/myHome")}})}}),myControllers.controller("MyInfoCtrl",function($scope,$rootScope,$q,$location,LoginService,UserService,AuthService,SystemService){function signOut(){X.loading.show(),LoginService.logout().then(function(res){var data=res.data;100==data.code?(AuthService.signOut(),$location.url("/index")):X.tip(data.resultMsg),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")})}$scope.user={},$scope.bankCards=[],X.loading.show(),$q.all({userInfo:UserService.getUserInfo(),bankCards:UserService.getBankCards()}).then(function(res){var userInfoData=res.userInfo.data,bankCardsData=res.bankCards.data;100==userInfoData.code&&100==bankCardsData.code?($scope.user=userInfoData.data,$scope.bankCards=bankCardsData.data,$scope.cellPhone=SystemService.cellPhoneNumber()):100!=userInfoData.code?X.tip(userInfoData.resultMsg):100!=bankCardsData.code&&X.tip(bankCardsData.resultMsg),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")}),$scope.logout=function(){X.dialog.confirm("确定要退出当前账号吗？",{
notify:function(nt){1==nt&&signOut()}})},$scope.goCheckAli=function(){X.dialog.confirm("使用支付宝进行首次入金操作后，即可自动<br>绑定支付宝账号。",{sureBtn:"去充值",notify:function(nt){1==nt&&$scope.$apply(function(){$location.url("/alipay?backURL=/myInfo")})}})},$scope.telTip=function(){X.dialog.alert('如需要更换或解绑支付宝账号，请 <br>联系客服电话 <a class="txt-blue" href='+$scope.cellPhone.cellPhoneATag+">"+$scope.cellPhone.cellPhone+"</a>")}}),myControllers.controller("NoticeCtrl",function($scope,$q,$location,NoticeService){$scope.items=[],$scope.pageIndex=1,$scope.totalPage=1,$scope.getNoticeList=function(page){var pageSize=10;X.loading.show(),NoticeService.getNoticeList(page,pageSize).then(function(res){var data=res.data;if(100==data.code){var noticeData=data.data;$scope.pageIndex=noticeData.pageIndex,$scope.totalPage=noticeData.totalPage,1==page?$scope.items=noticeData.items:$scope.items=$scope.items.concat(noticeData.items)}else X.tip(data.resultMsg);X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")})},$scope.getNoticeList($scope.pageIndex)}),myControllers.controller("NoticeDetailCtrl",function($scope,$q,$location,$sce,$routeParams,NoticeService){var noticeId=$routeParams.noticeId;return noticeId?($scope.notice={},X.loading.show(),void $q.all({noticeDetail:NoticeService.getNoticeById(noticeId)}).then(function(res){var noticeDetail=res.noticeDetail.data;100==noticeDetail.code?($scope.notice=noticeDetail.data,$scope.notice.noticeContent=$sce.trustAsHtml(noticeDetail.data.noticeContent)):X.tip(noticeDetail.resultMsg),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")})):(X.tip("公告ID不能为空"),void $location.path("/notice"))}),myControllers.controller("HelpCtrl",function($scope,$location,$sce){$scope.showHeader=!0,$scope.status="&#xe608;";var source=$location.search().source;source&&"IOSAPP"==source&&($scope.showHeader=!1),$scope.toHelpCenter=function(){$scope.showHeader?$location.path("/helpCenter"):window.location="jumpCenter::suggestion"},$scope.helpObjs={QA0001:{status:!1,content:$sce.trustAsHtml("<p>1、点买人发起点买后，若60秒内匹配投资人失败，则点买失败，相关资金退还到点买人账户中。</p><p>2、盘中涨幅≥8%或跌幅 ≤-8%时，投资人有权不执行点买人的点买指令，直至股票涨跌幅回落到（-8%,+8%）区间，投资人方接受并执行点买人的点买指令。</p><p>3、当股票进入《点买风险股名单》时，投资人也有权不执行点买人的点买指令。</p><p>4、当日点买人选择的股票触及过跌停，投资人也有权不接受点买指令。</p><p>5、单股最大持仓点买金额为30万，超出就无法再点买该股。</p><p>6、超过当天可点买次数，无法购买。</p>")},QA0002:{status:!1,content:$sce.trustAsHtml("<p>由于行情波动过大，点卖时会造成部分成交，只有全部成交后，才会结算该策略。</p>")},QB0001:{status:!1,content:$sce.trustAsHtml("<p>一般清算完后马上会到账户余额里，但是难免出现异常数据时，为了保证成交数据的正确性，我们会人工核实一遍数据，会造成清算时间一定的延迟。</p>")},QB0002:{status:!1,content:$sce.trustAsHtml("<p>若由于系统、接口等问题造成清算出错，我们会在核实数据后对用户该笔交易做资金修正。</p>")},QC0001:{status:!1,content:$sce.trustAsHtml("<p>目前WAP页面仅支持快捷支付充值方式</p>")},QC0002:{status:!1,content:$sce.trustAsHtml("<p>快捷充值，立马到账。</p>")},QC0003:{status:!1,content:$sce.trustAsHtml("<p>目前提款数量多，一般处理时间需要1-2个工作日左右，节假日可能会出现延迟。</p>")}},$scope.showDetail=function(id,item){}}),myControllers.controller("HelpDetailCtrl",function($scope,$location,$sce,$routeParams){$scope.showHeader=!0;var source=$location.search().source;source&&"IOSAPP"==source&&($scope.showHeader=!1);var detailId=$routeParams.helpDetailId,helpObjs={QA0001:{title:"为什么我点买失败？",content:$sce.trustAsHtml("<p>1、点买人发起点买后，若60秒内匹配投资人失败，则点买失败，相关资金退还到点买人账户中。</p><p>2、盘中涨幅≥8%或跌幅 ≤-8%时，投资人有权不执行点买人的点买指令，直至股票涨跌幅回落到（-8%,+8%）区间，投资人方接受并执行点买人的点买指令。</p><p>3、当股票进入《点买风险股名单》时，投资人也有权不执行点买人的点买指令。</p><p>4、当日点买人选择的股票触及过跌停，投资人也有权不接受点买指令。</p><p>5、单股最大持仓点买金额为30万，超出就无法再点买该股。</p><p>6、超过当天可点买次数，无法购买。</p>")},QA0002:{title:"为什么点卖时会部分成交，怎么结算？",content:$sce.trustAsHtml("<p>由于行情波动过大，点卖时会造成部分成交，只有全部成交后，才会结算该策略。</p>")},QB0001:{title:"点卖清算后资金何时返还账户余额？",content:$sce.trustAsHtml("<p>一般清算完后马上会到账户余额里，但是难免出现异常数据时，为了保证成交数据的正确性，我们会人工核实一遍数据，会造成清算时间一定的延迟。</p>")},QB0002:{title:"若清算时出现明显差错怎么办？",content:$sce.trustAsHtml("<p>若由于系统、接口等问题造成清算出错，我们会在核实数据后对用户该笔交易做资金修正。</p>")},QC0001:{title:"怎么充值？",content:$sce.trustAsHtml("<p>目前WAP页面仅支持快捷支付充值方式</p>")},QC0002:{title:"充值到账速度快吗？",content:$sce.trustAsHtml("<p>快捷充值，立马到账。</p>")},QC0003:{title:"提款到账速度快吗？",content:$sce.trustAsHtml("<p>目前提款数量多，一般处理时间需要1-2个工作日左右，节假日可能会出现延迟。</p>")}};$scope.helpObj=helpObjs[detailId]}),myControllers.controller("HelpCenterCtrl",function($scope,UserService){var pageSize=6;$scope.helpList=[],$scope.currPage=1,$scope.totalPage=1,$scope.getHelpList=function(page){X.loading.show(),UserService.getMsgPage(page,pageSize).then(function(res){var msgListData=res.data;if(100==msgListData.code){var data=msgListData.data;$scope.helpList=$scope.helpList.concat(data.items),$scope.currPage=data.pageIndex,$scope.totalPage=data.totalPage}else X.tip(msgListData.resultMsg);X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")})},$scope.getHelpList(1)}),myControllers.controller("HelpAskCtrl",function($scope,$location,UserService){$scope.types=["请选择留言类型","账户充值及提款问题","点买点卖问题","结算问题","我要投诉","意见反馈","其他问题"],$scope.type="请选择留言类型",$scope.content="",$scope.postMsg=function(){return"请选择留言类型"==$scope.type?void X.tip("请选择留言类型"):X.strLen($scope.content)<1||X.strLen($scope.content)>300?void X.tip("留言内容不符合规范"):(X.loading.show(),void UserService.postMsg($scope.type,"",$scope.content).then(function(res){var data=res.data;100==data.code?(X.tip("留言成功"),$location.path("/helpCenter")):X.tip(data.resultMsg),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")}))}}),myControllers.controller("TradeCtrl",function($scope,$q,$sce,$location,$routeParams,$interval,initData,StockService,TradeService,SystemService){function init(){getStockInfo(!0),X.engine.addTask(getStockInfo,1e3),X.engine.start()}function checkRiskStock(){for(var i=0;i<riskStocks.length;i++){var item=riskStocks[i];if(stockCode==item.stockCode){$scope.isRiskStock=!0;break}}}function confirmMineType(){""==mineListStr?$scope.mineType="add":$scope.mineType=mineListStr.indexOf(stockCode)==-1?"add":"delete"}function drawSLine(slineData){if(QUOTE_DATA){slineData=slineData||[];var lastTime,data={};slineData.forEach(function(obj,i){lastTime=X.formatDate(obj.time,"hm")-0,data[lastTime]={current:X.toFloat(obj.price),volume:X.toFloat(obj.volume),time:lastTime}}),slineChart=new X.Sline({wrap:"sline-wrap-"+$scope.uuid}),slineChart.draw({data:data,quoteTime:lastTime,close:QUOTE_DATA.yesterdayPrice,high:QUOTE_DATA.highPrice,low:QUOTE_DATA.lowPrice,limitUp:QUOTE_DATA.limitUpPrice,limitDown:QUOTE_DATA.limitDownPrice,period:SystemService.getRealPeriod("STOCK",lastTime),isStock:!0,isIntl:!1,code:stockCode})}}function drawKLine(klineData,type){klineData=klineData||[];var data=[];klineData.forEach(function(o,i){data[i]={time:8==o.time.length?o.time:X.formatDate(o.time,"YMD"),open:o.open,close:o.last,high:o.high,low:o.low,price:o.price}}),klineChart||(klineChart=new X.Kline({wrap:"kline-wrap-"+$scope.uuid})),klineChart.draw(data),"kline"==type?CACHE_KLINE=data:"weekKline"==type?CACHE_WEEKKLINE=data:CACHE_MONTHKLINE=data}function newSlineQuoteData(quote){var price=0==quote.newPrice?quote.yesterdayPrice:quote.newPrice,o={current:price,volume:0,time:X.formatDate(quote.time,"hm")-0};slineChart&&slineChart.perDraw(o,{quoteTime:o.time,close:quote.yesterdayPrice,high:quote.highPrice,low:quote.lowPrice,limitUp:quote.limitUpPrice,limitDown:quote.limitDownPrice,period:SystemService.getRealPeriod("STOCK",o.time),isStock:!0,code:stockCode})}function newKlineQuoteData(quote){if(0!=quote.newPrice&&CACHE_KLINE&&CACHE_KLINE.length){var o={time:X.formatDate(quote.time,"YMD"),open:quote.openPrice,close:quote.yesterdayPrice,high:quote.highPrice,low:quote.lowPrice,price:quote.newPrice};if("kline"==$scope.actType){var last=CACHE_KLINE[CACHE_KLINE.length-1];last.time===o.time?CACHE_KLINE[CACHE_KLINE.length-1]=o:CACHE_KLINE.push(o),klineChart&&klineChart.draw(CACHE_KLINE)}else if("weekKline"==$scope.actType){var last=CACHE_WEEKKLINE[CACHE_WEEKKLINE.length-1];last.time===o.time?CACHE_WEEKKLINE[CACHE_WEEKKLINE.length-1]=o:CACHE_WEEKKLINE.push(o),klineChart&&klineChart.draw(CACHE_WEEKKLINE)}else if("monthKline"==$scope.actType){var last=CACHE_MONTHKLINE[CACHE_MONTHKLINE.length-1];last.time===o.time?CACHE_MONTHKLINE[CACHE_MONTHKLINE.length-1]=o:CACHE_MONTHKLINE.push(o),klineChart&&klineChart.draw(CACHE_MONTHKLINE)}}}function getStockSline(){StockService.getSLine(stockCode).then(function(res){var data=res.data;100==data.code?drawSLine(data.data):X.tip(data.resultMsg)})["catch"](function(){X.tip("服务器请求异常")})}function getStockKline(current){var http;"kline"==current?http=StockService.getKLine(stockCode):"weekKline"==current?http=StockService.getWMKline(stockCode,current):"monthKline"==current&&(http=StockService.getWMKline(stockCode,current)),http.then(function(res){var data=res.data;100==data.code?drawKLine(data.data,current):X.tip(data.resultMsg)})["catch"](function(){X.tip("服务器请求异常")})}function getStockInfo(flag){X.log("行情定时器运行中。。。"),isTrade?(isInTradeTime=SystemService.isInPeriod("STOCK","trade"),isInTradeTime?$scope.isRiskStock?$scope.btn={className:"disabled",btnText:"立即点买",disabled:!0}:QUOTE_DATA&&0==QUOTE_DATA.newPrice?$scope.btn={className:"disabled",btnText:"立即点买",disabled:!0}:$scope.btn={className:"orange",btnText:"立即点买",disabled:!1}:$scope.btn={className:"disabled",btnText:"非点买时段",disabled:!0}):(isInTradeTime=!1,$scope.btn={className:"disabled",btnText:"暂停交易",disabled:!0});var isInQuoteTime=SystemService.isInPeriod("STOCK","quote");flag||isInQuoteTime||$scope.$apply(),dataIsLoad&&isInQuoteTime&&(dataIsLoad=!1,StockService.getStockInfo(stockCode).then(function(res){dataIsLoad=!0;var data=res.data;100==data.code?processStockInfoData(data.data[stockCode]):X.tip(data.resultMsg)})["catch"](function(){X.tip("服务器请求异常")}))}function processStockInfoData(data){var newPrice=data.newPrice,lastClosePrice=data.lastClosePrice,isStop=0==newPrice,style="",dealNum="",dealPrice="",diff=0,rate=0;isStop||(diff=newPrice-lastClosePrice,rate=diff/lastClosePrice*100,diff=diff.toFixed(2),rate=rate.toFixed(2),style=newPrice>lastClosePrice?"txt-red":newPrice<lastClosePrice?"txt-green":"txt-white",dealNum=processNum(data,"todayDealNum"),dealPrice=processNum(data,"todayDealPrice")),$scope.stock={stockLabel:data.stockLabel,stockName:data.stockName,price:newPrice,lastClosePrice:lastClosePrice,isStop:isStop,diff:diff,rate:rate,style:style,dealNum:dealNum,dealPrice:dealPrice,openPrice:data.openPrice,highPrice:data.highPrice,lowPrice:data.lowPrice,limitDownPrice:parseFloat(data.limitDownPrice),limitUpPrice:parseFloat(data.limitUpPrice),amplitude:data.amplitude,todayDealNum:data.todayDealNum,todayDealPrice:data.todayDealPrice,buyPrice:isStop?[0,0,0,0,0]:data.buyPrice,buyNum:isStop?[0,0,0,0,0]:data.buyNum,sellPrice:isStop?[0,0,0,0,0]:data.sellPrice,sellNum:isStop?[0,0,0,0,0]:data.sellNum},QUOTE_DATA={commodityTitle:"STOCK",contractNo:data.stockLabel,time:data.time,openPrice:data.openPrice,yesterdayPrice:data.lastClosePrice,highPrice:data.highPrice,lowPrice:data.lowPrice,newPrice:data.newPrice,limitDownPrice:X.toFloat(data.limitDownPrice),limitUpPrice:X.toFloat(data.limitUpPrice)},newSlineQuoteData(QUOTE_DATA),newKlineQuoteData(QUOTE_DATA)}function processNum(data,type){var num=data[type],unit="todayDealNum"==type?"手":"元";return num>1e8?(num/1e8).toFixed(2)+"亿"+unit:num>1e4?(num/1e4).toFixed(2)+"万"+unit:num+unit}if(null==initData)return void X.tip("初始化信息加载错误，请重试");var strRisk=JSON.parse(initData.strRisk),defaultStock=strRisk.defaultStock.value,priceRisk=strRisk.priceRisk.value.split(","),holiday=SystemService.parseHoliday(initData.holidays),tradeTime=SystemService.parsePeriod(strRisk.tradingTimeLimit.value),isTrade="1"!=strRisk.bussmannSwitch.value;SystemService.setCurrentTime(initData.nowTime),SystemService.setCurrentCurrencyType("CNY"),SystemService.setHoliday(holiday),SystemService.setTradePeriod(tradeTime);var QUOTE_DATA,CACHE_KLINE,CACHE_WEEKKLINE,CACHE_MONTHKLINE,storage=window.localStorage,STOCKCODE="STOCKCODE",MINELIST="MINELIST",stockCodeFromIndex=$location.search().stock,stockCode=stockCodeFromIndex||storage.getItem(STOCKCODE)||defaultStock||"SH600570",mineListStr=storage.getItem(MINELIST)||"",isInTradeTime=!1,dataIsLoad=!0,riskStocks=[],slineChart=null,klineChart=null,DYTip=!1,inDYTipTime=!1;$scope.stockType="T+1",$scope.stockTypes={trade:"T+1",TDTrade:"T+D"},$scope.uuid=SystemService.uuid(),$scope.isRiskStock=!1,$scope.showMenu=!1,$scope.mineType="add",$scope.actType="sline",$scope.stopTimer=!1,$scope.stock={},$scope.btn={className:"disabled",btnText:"数据加载中",disabled:!0},X.loading.show(),$q.all({trade:TradeService.getRiskStock(),info:StockService.getStockInfo(stockCode),DY:TradeService.getWaitPayDeferForRemind()}).then(function(res){var infoData=res.info.data,tradeData=res.trade.data,DYData=res.DY.data;100==tradeData.code&&100==infoData.code&&100==DYData.code?(riskStocks=tradeData.data,confirmMineType(),checkRiskStock(),processStockInfoData(infoData.data[stockCode]),init(),$scope.changeTab("sline"),0!=DYData.data&&(DYTip=!0)):100!=tradeData.code?X.tip(tradeData.resultMsg):100!=infoData.code&&X.tip(infoData.resultMsg),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")}),$scope.changeTab=function(current){$scope.actType=current,"sline"!=current||slineChart?("kline"!=current||CACHE_KLINE)&&("weekKline"!=current||CACHE_WEEKKLINE)?"monthKline"!=current||CACHE_MONTHKLINE||getStockKline(current):getStockKline(current):getStockSline(),"kline"==current&&CACHE_KLINE?drawKLine(CACHE_KLINE,current):"weekKline"==current&&CACHE_WEEKKLINE?drawKLine(CACHE_WEEKKLINE,current):"monthKline"==current&&CACHE_MONTHKLINE&&drawKLine(CACHE_MONTHKLINE,current)},$scope.toTrade=function(){if(inDYTipTime=SystemService.isInDYTipPeriod(),!QUOTE_DATA)return!1;if(0==QUOTE_DATA.newPrice)return X.dialog.alert("停牌股暂时无法进行买卖"),!1;if($scope.isRiskStock)return X.dialog.alert("该股今日为禁买股，请选择其他股票交易"),!1;var currPrice=QUOTE_DATA.newPrice,closePrice=QUOTE_DATA.yesterdayPrice,diff=currPrice-closePrice,rote=(diff/closePrice*100).toFixed(2);return rote>X.toFloat(priceRisk[1])||rote<X.toFloat(priceRisk[0])?(X.dialog.alert("该股今日点买风险较高，暂无投资人接收交易合作"),!1):DYTip?void X.dialog.confirm("温馨提示：请您确认是否已经将今日递延<br/>费留在余额中等待扣款，如果继续操作可<br/>能会造成操盘中策略因递延费不足被平仓",{sureBtn:"确定",notify:function(nt){1==nt&&$scope.$apply(function(){$location.path("/tradeBuy/"+stockCode)})}}):void $location.path("/tradeBuy/"+stockCode)},$scope.addOrDelMine=function(stockCode,stockName){if(!stockCode||!stockName)return!1;var maxLen=20,mineListStr=storage.getItem(MINELIST)||"",mineArr=[];if(""==mineListStr||mineListStr.indexOf(stockCode)==-1){if(""!=mineListStr&&(mineArr=mineListStr.split(";")),mineArr.length>=maxLen)return void X.dialog.alert("自选最多添加"+maxLen+"条记录");mineArr.push(stockCode+","+stockName),storage.setItem(MINELIST,mineArr.join(";")),$scope.mineType="delete"}else{mineArr=mineListStr.split(";");for(var i=0;i<mineArr.length;i++)mineArr[i].indexOf(stockCode)!=-1&&mineArr.splice(i,1);storage.setItem(MINELIST,mineArr.join(";")),$scope.mineType="add"}},$scope.$on("$destroy",function(){X.engine.destroy()})}),myControllers.controller("TradeBuyCtrl",function($scope,$q,$routeParams,$location,TradeService,StockService,UserService,PacketService,SystemService){function initValidate(){$scope.user.named||X.dialog.confirm("您还未实名认证，请先实名认证",{notify:function(nt){1==nt&&$scope.$apply(function(){$location.url("/identification?goURL=/tradeBuy/"+stockCode)}),0==nt&&$scope.$apply(function(){window.history.back()})}})}function trade(){var postData={token:token,money:$scope.money,lever:lowRateList[$scope.lowIndex].value,quitLoss:$scope.lowMoney,quitGain:$scope.highMoney,principal:$scope.principal,serviceCharge:$scope.serviceCharge,stockCode:stockCode,volumeOrder:$scope.stockCount,useTip:$scope.useTip};$scope.btn={className:"disabled",btnText:"数据处理中",disabled:!0},X.loading.show(),TradeService.createTrade(postData).then(function(res){var data=res.data;100==data.code?(X.tip("策略发起成功"),zhuge.track("交易",{"名称":"A股"}),$location.path("/tradeSell")):(token=data.data.token,X.tip(data.resultMsg),$scope.btn={className:"orange",btnText:"提交",disabled:!1}),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")})}function checkRiskStock(){for(var i=0;i<riskStocks.length;i++){var item=riskStocks[i];if(stockCode==item.stockCode)return!0}return!1}function processServiceCharge(money){money>=1e4?$scope.serviceCharge=parseInt(Math.round(money/1e4*serviceCharge*1e4)/1e4*100)/100:$scope.serviceCharge=parseInt(Math.round(littleServiceCharge/1e4*money*1e4)/100)/100,$scope.usTipBalance=Math.min($scope.serviceCharge,$scope.tipBalance)}function processStockCount(money){var count=money/($scope.stock.stockPrice*tradingCountRatio)/100|0;count=100*count,$scope.stockCount=count,$scope.moneyUseRate=parseInt(Math.round(count*$scope.stock.stockPrice/money*100*1e6)/1e4)/100}function processHigh(money){$scope.highMoneyList=[],$.each(highRateList,function(i,item){$scope.highMoneyList.push(X.toInt(money*item))})}function processLow(money){$scope.lowMoneyList=[],$.each(lowRateList,function(i,obj){$scope.lowMoneyList.push(X.toInt(X.toInt(-money/obj.value)*obj.rote))})}function initStockData(data){$scope.stock.stockCode=data.stockLabel,$scope.stock.stockName=data.stockName,$scope.stock.stockPrice=data.newPrice,$scope.stock.stockClose=data.lastClosePrice}function initTradeData(data){var buyCount=data.buyCount,balance=data.balance;isHoliday=data.isHoliday;var tradingDeferCharge=data.tradingDeferCharge,unHanldDeferCharge=data.unHanldDeferCharge,unHanldHoldDeferCharge=data.unHanldHoldDeferCharge,risk=JSON.parse(data.strRisk);maxStockCount=risk.maxStockCount.value,serviceCharge=risk.serviceCharge.value-0,deferCharge=risk.deferCharge.value,tradingCountRatio=risk.tradingCountRatio.value,maxMoneyOneStock=risk.maxMoneyOneStock.value,priceRisk=risk.priceRisk.value.split(","),token=data.token;var maxCountOneDay=risk.maxCountOneDay.value,tradingMoneyList=risk.tradingMoneyList.value,quitGainRatioList=risk.quitGainRatioList.value,levers=risk.levers.levers;$scope.risk=risk,$scope.balance=balance,$scope.isHoliday=isHoliday,$scope.canBuyCount=maxCountOneDay-buyCount>0?maxCountOneDay-buyCount:0,$scope.tradingDeferCharge=tradingDeferCharge||0,$scope.unHanldDeferCharge=unHanldDeferCharge||0,$scope.unHanldHoldDeferCharge=unHanldHoldDeferCharge||0,isSignAgreement=data.signAgreement;var holiday=SystemService.parseHoliday(data.holidays),tradeTime=SystemService.parsePeriod(risk.tradingTimeLimit.value);isTrade="1"!=risk.bussmannSwitch.value,SystemService.setCurrentTime(data.nowTime),SystemService.setCurrentCurrencyType("CNY"),SystemService.setHoliday(holiday),SystemService.setTradePeriod(tradeTime),initTradeMoney(tradingMoneyList),initHighRate(quitGainRatioList),initLowRate(levers),$scope.chooseMoney($scope.currentIndex,$scope.tradeMoneyList[$scope.currentIndex].value),$scope.money<1e4&&(littleServiceCharge=risk.serviceChargeForLittleMoney.value-0,littleDeferCharge=risk.deferChargeForLittleMoney.value-0),0==$scope.canBuyCount?$scope.btn={className:"disabled",btnText:"今日点买次数已用完",disabled:!0}:$scope.btn={className:"orange",btnText:"提交",disabled:!1}}function initTradeMoney(tradingMoneyStr){tradingMoneyStr&&($scope.tradeMoneyList=[],tradeMoneyList=tradingMoneyStr.split(","),$.each(tradeMoneyList,function(i,m){$scope.tradeMoneyList.push({value:m,text:X.sketchNumber(m)})}))}function initHighRate(quitGainRatioListStr){quitGainRatioListStr&&($scope.highMoneyList=[],highRateList=quitGainRatioListStr.split(","))}function initLowRate(levers){lowRateList=[],$.each(levers,function(i,item){var rote=item.quitLossLineRatio.value,value=item.value;lowRateList.push({rote:rote,value:value})})}var stockCode=$routeParams.stockCode,stockCodeReg=/^(SZ|SH)\d{6,}$/;if(!stockCode||!stockCodeReg.test(stockCode))return void $location.path("/trade");var stockBuyMoney,litDeferCharge,isTrade,token="",tradeMoneyList=[],highRateList=[],lowRateList=[],serviceCharge=0,deferCharge=0,priceRisk=[-8,8],maxMoneyOneStock=1e5,maxStockCount=1e4,tradingCountRatio=1,riskStocks=[],initTime=Date.now(),isSignAgreement=!1,littleServiceCharge=0,littleDeferCharge=0,litServiceCharge=0,isHoliday=!0;$scope.stock={},$scope.trade={},$scope.risk={},$scope.currentIndex=0,$scope.highIndex=0,$scope.lowIndex=0,$scope.money=0,$scope.highMoney=0,$scope.lowMoney=0,$scope.tradeMoneyList=[],$scope.highMoneyList=[],$scope.lowMoneyList=[],$scope.principal=0,$scope.serviceCharge=0,$scope.stockCount=0,$scope.canBuyCount=0,$scope.isHoliday=!0,$scope.user={},$scope.btn={className:"disabled",btnText:"数据加载中",disabled:!0},$scope.tipBalance=0,$scope.usTipBalance=0,$scope.useTip=!0,X.loading.show(),$q.all({userInfo:UserService.getUserInfo(),stock:StockService.getStockInfo(stockCode),trade:TradeService.getInitTrade(),stockStatisticsInfo:TradeService.getStockStatisticsInfo(stockCode),tradeRisk:TradeService.getRiskStock(),packet:PacketService.getPacketFundInfoData()}).then(function(res){var userInfoData=res.userInfo.data,stockData=res.stock.data,stockStatisticsInfoData=res.stockStatisticsInfo.data,tradeData=res.trade.data,tradeRiskData=res.tradeRisk.data,packetData=res.packet.data;100==userInfoData.code&&100==stockData.code&&100==tradeData.code&&100==stockStatisticsInfoData.code&&100==tradeRiskData.code?($scope.user=userInfoData.data,$scope.tipBalance=packetData.data.tipBalance,0==$scope.tipBalance&&($scope.useTip=!1),riskStocks=tradeRiskData.data,stockBuyMoney=stockStatisticsInfoData.data.money||0,initStockData(stockData.data[stockCode]),initTradeData(tradeData.data),$scope.chooseMoney($scope.currentIndex,$scope.tradeMoneyList[$scope.currentIndex].value),initValidate()):100!=userInfoData.code?X.tip(userInfoData.resultMsg):100!=stockData.code?X.tip(stockData.resultMsg):100!=tradeData.code?X.tip(tradeData.resultMsg):100!=tradeRiskData.code&&X.tip(tradeRiskData.resultMsg),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")}),$scope.toTrade=function(){if(!isTrade)return X.dialog.alert("暂停交易"),!1;if(!SystemService.isInPeriod("STOCK","trade"))return X.dialog.alert("当前为非点买时段，无法发起策略"),!1;if(0==$scope.stock.stockPrice)return X.dialog.alert("停牌股无法进行交易<br>请更换其他能够正常交易的股票"),!1;if(checkRiskStock())return X.dialog.alert("【"+$scope.stock.stockName+"】今日点买风险较高，暂无投资人接收交易合作"),!1;var currPrice=$scope.stock.stockPrice,closePrice=$scope.stock.stockClose,diff=currPrice-closePrice,rote=(diff/closePrice*100).toFixed(2);if(rote>X.toFloat(priceRisk[1])||rote<X.toFloat(priceRisk[0]))return X.dialog.alert("该股今日点买风险较高，暂无投资人接收交易合作"),!1;var canBuyMoney=maxMoneyOneStock-stockBuyMoney;if(canBuyMoney<0&&(canBuyMoney=0),$scope.money>canBuyMoney)return X.dialog.alert("个股持仓累计金额最多"+maxMoneyOneStock+"元，当前还可点买"+canBuyMoney+"元"),!1;var now=Date.now(),min=1;if(now-initTime>60*min*1e3)return X.dialog.alert("由于股票价格实时变化，您未在"+60*min+"秒内发起策略，这将导致数据波动较大，请重新获取数据，尽快提交",{title:"系统提示",notify:function(){window.location.reload()}}),!1;if($scope.stockCount>maxStockCount)return X.dialog.alert("单股最高可购买数量为"+maxStockCount+"股"),!1;var needMoney=$scope.principal+$scope.serviceCharge+$scope.unHanldDeferCharge;if($scope.useTip&&(needMoney=parseInt(Math.round(1e4*(needMoney-$scope.usTipBalance)))/1e4),$scope.balance<needMoney){var msg=$scope.unHanldDeferCharge>0?"账户历史策略未缴纳递延费共"+$scope.unHanldDeferCharge+"元<br>":"";return X.dialog.confirm(msg+"当前余额不足，<br>请充值后再发起策略。",{sureBtn:"去充值",notify:function(nt){1==nt&&$scope.$apply(function(){$location.url("/payType?goURL=/tradeBuy/"+stockCode)})}}),!1}return isSignAgreement?void($scope.unHanldDeferCharge>0?X.dialog.confirm("账户历史策略未缴纳递延费共"+$scope.unHanldDeferCharge+"元，需缴纳后才能发起新策略。<br>确定支付吗？",{notify:function(nt){1==nt&&trade()}}):trade()):($location.url("/agreementSigned?goURL=/tradeBuy/"+stockCode),!1)},$scope.tips=function(title,msg){X.dialog.info(title,msg)};var littleMoney=0;$scope.chooseMoney=function(index,money){$scope.currentIndex=index,$scope.money=money,$scope.money<1e4&&(litServiceCharge=parseInt(Math.round(littleServiceCharge/1e4*$scope.money*1e4)/100)/100,litDeferCharge=parseInt(Math.round(littleDeferCharge/1e4*$scope.money*1e4)/100)/100,littleMoney=$scope.money),$scope.serviceChargeTips="交易综合费包含第一天的交易费，第二天的递延费。每万元点买金交易综合费为"+serviceCharge+"元，每万元点买金递延费为"+deferCharge+"元/天。"+littleMoney/1e4+"万元交易综合费为"+litServiceCharge+"元，递延费为"+litDeferCharge+"元/天。",processHigh(money),processLow(money),$scope.chooseHigh(0,$scope.highMoneyList[0]),$scope.chooseLow(0,$scope.lowMoneyList[0]),processServiceCharge(money),processStockCount(money)},$scope.chooseHigh=function(index,money){$scope.highIndex=index,$scope.highMoney=money},$scope.chooseLow=function(index,money){$scope.lowIndex=index,$scope.lowMoney=money,$scope.principal=X.toInt($scope.money/lowRateList[index].value)}}),myControllers.controller("TradeSellCtrl",function($scope,$q,$interval,$location,TradeService,StockService,SystemService){function startTimer(){isOK=!0,getData(),timer=$interval(function(){X.log("点卖定时器运行中。。。"),$scope.isInTradeTime=SystemService.isInPeriod("STOCK","trade"),$scope.isInJJPeriod=SystemService.isInJJPeriod(),(first||!$scope.isHoliday&&$scope.isInTradeTime&&isOK)&&(isOK=!1,showOrHideDYFWrap(),getData())},1e3)}function showOrHideDYFWrap(){$scope.isInDYFShowTime=SystemService.isInPeriod("DEFER","quote")}function initTodayStartTime(serverTime){serverTime=serverTime||Date.now();var now=new Date(serverTime),yyyy=now.getFullYear(),MM=now.getMonth(),dd=now.getDate(),today=new Date(yyyy,MM,dd,0,0,0);$scope.todayStartTime=today.getTime()}function getData(){var http;http=first?TradeService.getSaleStrategyByPage():TradeService.getSaleStrategyOfMemcache(),first=!1,http.then(function(res){var data=res.data;if(100==data.code){tradeData=data.data;var stocks=getNeedStocks(tradeData.dataList);""!=stocks&&stocks||(X.loading.hide(),$scope.dataList=[]),StockService.getStockInfo(stocks).then(function(res){var data=res.data;100==data.code?(quoteData=data.data,processData()):initNoDataQuote()})["catch"](function(){X.tip("服务器请求异常")})}else X.tip(data.resultMsg)})["catch"](function(){X.tip("服务器请求异常")})}function sale(tradeID,isAlwaysClose){return $scope.isInTradeTime?(X.loading.show(),void TradeService.closeStrategy(tradeID,isAlwaysClose).then(function(res){var data=res.data;100==data.code?X.tip("点卖策略成功"):X.tip(data.resultMsg),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")})):void X.tip("非交易时间不能交易")}function initNoDataQuote(){$scope.dataIsLoad=!0,isOK=!0,X.loading.hide();var dataList=tradeData.dataList;$.each(dataList,function(i,item){item.quotePrice=0,item.lastClosePrice=0,item.profit=0}),$scope.dataList=dataList}function processData(){if($scope.dataIsLoad=!0,isOK=!0,X.loading.hide(),null==tradeData||null==quoteData)return void($scope.dataList=[]);$scope.unHanldHoldDeferCharge=tradeData.unHanldHoldDeferCharge,$scope.tradingDeferCharge=tradeData.tradingDeferCharge;var dataList=tradeData.dataList;$.each(dataList,function(i,item){var quote=quoteData[item.stockCode];item.quotePrice=quote?quote.newPrice:0,item.lastClosePrice=quote.lastClosePrice,0!=item.buyPriceDeal&&0!=item.quotePrice&&0!=item.volumeHold?item.profit=(item.quotePrice-item.buyPriceDeal)*item.volumeHold:item.profit=(item.lastClosePrice-item.buyPriceDeal)*item.volumeHold}),$scope.dataList=dataList}function getNeedStocks(dataList){var stocksObj={},stocks="",arr=[];$.each(dataList,function(i,item){stocksObj[item.stockCode]=item.stockCode});for(var key in stocksObj)arr.push(key);return stocks=arr.length>0?arr.join(","):""}function buyOutDialog(trade,type){TradeService.takeOverInitiate(trade.id).then(function(res){var data=res.data;if(100==data.code){$scope.deferMoney=Math.round(100*data.data)/100,$scope.currentTrade=trade,$scope.showDBBG=!0,$scope.holdStrategyMoney=trade.lastClosePrice*trade.volumeHold,$scope.stockName=trade.stockName;var lossPrincipal=trade.lossPrincipal||0;$scope.lossPrincipal=Math.round(100*lossPrincipal)/100,2==type?($scope.paySum=Math.round(100*(trade.buyPriceDeal*trade.volumeHold+$scope.deferMoney))/100,$scope.showBuyOutMenu=!0,$scope.showQuitType=!1):($scope.paySum=$scope.lossPrincipal,$scope.showQuitType=!0,$scope.showBuyOutMenu=!1)}else X.tip(data.resultMsg)})["catch"](function(){X.tip("服务器异常")})}function clearTimer(){timer&&($interval.cancel(timer),timer=void 0)}var timer,first=!0,tradeData=null,quoteData=null,isOK=!1,DYTip=!1;$scope.tradeState={1:"等待接单",2:"正在委托买入",3:"正在委托买入",4:"点卖",5:"正在委托卖出",6:"正在委托卖出",7:"正在清算",8:"已清算"},$scope.dataList=[],$scope.dataMap={},$scope.unHanldHoldDeferCharge=0,$scope.tradingDeferCharge=0,$scope.dataIsLoad=!1,$scope.isInTradeTime=!1,$scope.isInJJPeriod=!0,$scope.isInDYFShowTime=!1,$scope.isHoliday=!0,$scope.todayStartTime=0,$scope.stockType="T+1",$scope.stockTypes={trade:"T+1",TDTrade:"T+D"},$scope.showMenu=!1,X.loading.show(),$q.all({trade:TradeService.getInitTrade(),DY:TradeService.getWaitPayDeferForRemind()}).then(function(res){var tradeData=res.trade.data,DYData=res.DY.data;if(100==tradeData.code&&100==DYData.code){var data=tradeData.data,strRisk=JSON.parse(data.strRisk);$scope.isHoliday=data.isHoliday;var holiday=SystemService.parseHoliday(data.holidays),tradeTime=SystemService.parsePeriod(strRisk.tradingTimeLimit.value);SystemService.setCurrentTime(data.nowTime),SystemService.setCurrentCurrencyType("CNY"),SystemService.setHoliday(holiday),SystemService.setTradePeriod(tradeTime),$scope.isInTradeTime=SystemService.isInPeriod("STOCK","trade"),$scope.isInJJPeriod=SystemService.isInJJPeriod(),0!=DYData.data&&(DYTip=!0),initTodayStartTime(data.nowTime),startTimer()}else X.tip(tradeData.resultMsg)})["catch"](function(){X.tip("服务器请求异常")}),$scope.sale=function(trade){var html='<div class="mod-sale-confirm-wrap">';html+='<div class="item">股票名称:<span class="fr">'+trade.stockName+"</span></div>",html+='<div class="item">股票代码:<span class="fr">'+trade.stockCode.substr(-6)+"</span></div>",html+='<div class="item">委托价格:<span class="fr">市价</span></div>',html+='<div class="item">卖出数量:<span class="fr">'+trade.volumeHold+"股</span></div>",html+='<div class="item">持仓天数:<span class="fr">'+trade.holdDays+"天</span></div>",html+=trade.profit>0?'<div class="item">浮动盈亏:<span class="fr txt-red">+'+trade.profit.toFixed(2)+"元</span></div>":trade.profit<0?'<div class="item">浮动盈亏:<span class="fr txt-green">'+trade.profit.toFixed(2)+"元</span></div>":'<div class="item">浮动盈亏:<span class="fr">'+trade.profit.toFixed(2)+"元</span></div>",html+='<div class="item"><label><input id="agreeDefer" type="checkbox" checked> 是否递延指令</label></div>',html+='<div class="txt-grey txt-s12">注：点卖指令可能因跌停导致无法成交，默认至下一个交易日挂单交易。浮动盈亏仅供参考，具体以实际成交为准。</div>',html+="</div>",X.dialog.confirm(html,{title:"点卖确认",notify:function(nt){if(1==nt){var agreeDefer=document.getElementById("agreeDefer");sale(trade.id,agreeDefer.checked)}}})},$scope.showArrears=function(money){var html="已逾期递延费："+money+"元。<br>请尽快补缴，以免策略被接管。";X.dialog.alert(html)},$scope.showPartDeal=function(trade){var list=trade.tradingRecordList,volumeDeal=trade.volumeHold,table="";table+="<table>",table+='<tr><td>成交时间</td><td>数量</td><td class="txt-right">价格</td></tr>';for(var i=0;i<list.length;i++){var obj=list[i];table+="<tr><td>"+X.formatDate(new Date(obj.time),"Y-M-D")+"</td><td>"+obj.amount+'</td><td class="txt-right">'+obj.price.toFixed(2)+"</td></tr>",volumeDeal+=obj.amount}table+="</table>";var tipHtml='<div class="info">行情波动过大，造成部分成交，原持有数量'+volumeDeal+"股，现剩余"+trade.volumeHold+"股，请处理剩余数量，以便结算！</div>";X.dialog.alert('<div class="mod-part-deal-wrap">'+tipHtml+table+"</div>")},$scope.showBuyOutMenu=!1,$scope.showDBBG=!1,$scope.buyOut=function(trade,type){if(trade&&type)return DYTip&&2==type?void X.dialog.confirm("温馨提示：请您确认是否已经将今日递延<br/>费留在余额中等待扣款，如果继续操作可<br/>能会造成操盘中策略因递延费不足被平仓",{sureBtn:"确定",notify:function(nt){1==nt&&$scope.$apply(function(){$scope.showDBBG=!0,buyOutDialog(trade,type)})}}):void buyOutDialog(trade,type)},$scope.confirmBuyOrQuit=function(takeOverType){X.loading.show(),TradeService.takeOverStrategy($scope.currentTrade.id,takeOverType,$scope.paySum).then(function(res){var data=res.data;100==data.code?1==takeOverType?X.tip("放弃策略成功"):X.tip("买断策略成功"):X.tip(data.resultMsg),$scope.cancelOperate(),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")})},$scope.cancelOperate=function(){$scope.showDBBG=!1,$scope.showBuyOutMenu=!1},$scope.$on("$destroy",function(){clearTimer()})}),myControllers.controller("TradeResultCtrl",function($scope,$location,$q,TradeService){var pageSize=10;$scope.settleList=[],$scope.currPage=1,
$scope.totalPage=1,$scope.stockType="T+1",$scope.stockTypes={trade:"T+1",TDTrade:"T+D"},$scope.showMenu=!1,$scope.getSettleList=function(page){X.loading.show(),TradeService.getSettleStrategyByPage(page,pageSize).then(function(res){var settleListData=res.data;if(100==settleListData.code){var data=settleListData.data;$scope.currPage=data.pageIndex,$scope.totalPage=data.totalPage;var list=data.dataList;1==page?$scope.settleList=list:$scope.settleList=$scope.settleList.concat(list)}else X.tip(settleListData.resultMsg);X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")})},$scope.getSettleList($scope.currPage),$scope.toDetail=function(tradeID){$location.url("/tradeDetail/"+tradeID)}}),myControllers.controller("TDTradeCtrl",function($scope,$q,$location,$sce,initData,TradeService,PacketService,StockService,SystemService){function confirmMineType(){""==mineListStr?$scope.mineType="add":$scope.mineType=mineListStr.indexOf(stockCode)==-1?"add":"delete"}function checkRiskStock(){for(var i=0;i<riskStocks.length;i++){var item=riskStocks[i];if(stockCode==item.stockCode){$scope.isRiskStock=!0;break}}}function processStockInfoData(data){var newPrice=data.newPrice,lastClosePrice=data.lastClosePrice,isStop=isStopStock=0==newPrice,style="",dealNum="",dealPrice="",diff=0,rate=0;isStop||(diff=newPrice-lastClosePrice,rate=diff/lastClosePrice*100,diff=diff.toFixed(2),rate=rate.toFixed(2),style=newPrice>lastClosePrice?"txt-red":newPrice<lastClosePrice?"txt-green":"txt-white",dealNum=processNum(data,"todayDealNum"),dealPrice=processNum(data,"todayDealPrice")),$scope.stock={stockLabel:data.stockLabel,stockName:data.stockName,price:parseInt(100*newPrice)/100,lastClosePrice:lastClosePrice,isStop:isStop,diff:diff,rate:rate,style:style,dealNum:dealNum,dealPrice:dealPrice,openPrice:data.openPrice,highPrice:data.highPrice,lowPrice:data.lowPrice,limitDownPrice:parseFloat(data.limitDownPrice),limitUpPrice:parseInt(100*data.limitUpPrice)/100,amplitude:data.amplitude,todayDealNum:data.todayDealNum,todayDealPrice:data.todayDealPrice,buyPrice:isStop?[0,0,0,0,0]:data.buyPrice,buyNum:isStop?[0,0,0,0,0]:data.buyNum,sellPrice:isStop?[0,0,0,0,0]:data.sellPrice,sellNum:isStop?[0,0,0,0,0]:data.sellNum},QUOTE_DATA={commodityTitle:"STOCK",contractNo:data.stockLabel,time:data.time,openPrice:data.openPrice,yesterdayPrice:data.lastClosePrice,highPrice:data.highPrice,lowPrice:data.lowPrice,newPrice:data.newPrice,limitDownPrice:X.toFloat(data.limitDownPrice),limitUpPrice:X.toFloat(data.limitUpPrice)},newSlineQuoteData(QUOTE_DATA),newKlineQuoteData(QUOTE_DATA)}function init(){if(showLastDayTip(),null!=$scope.scheme){var tradingCount=Math.floor(Math.round($scope.stock.price*tradingCountRatio*1e4)/100)/100,num=100*Math.floor($scope.scheme.availableMoney/tradingCount/100);$scope.stockNumObj.max=num<100?100:num>maxStockCount?maxStockCount:num}getStockInfo(!0),X.engine.addTask(getStockInfo,1e3),X.engine.start()}function showLastDayTip(){if(null!=$scope.scheme&&$scope.scheme.availableDays<3){var schemeId=$scope.scheme.id,tipMsg=[],tipRecord=storage.getItem("SCHEME_LAST_DAY_TIP"),today=X.formatDate(new Date,"Y-M-D"),tipKey="{{"+schemeId+":"+today+"}}";null==tipRecord?($scope.showSchemeLastDayTip=!0,storage.setItem("SCHEME_LAST_DAY_TIP",tipKey)):(tipMsg=tipRecord.split(";"),tipMsg.indexOf(tipKey)==-1&&($scope.showSchemeLastDayTip=!0,tipMsg.push(tipKey),storage.setItem("SCHEME_LAST_DAY_TIP",tipMsg.join(";"))))}}function getStockSline(){StockService.getSLine(stockCode).then(function(res){var data=res.data;100==data.code?drawSLine(data.data):X.tip(data.resultMsg)})["catch"](function(){X.tip("服务器请求异常")})}function getStockKline(current){var http;"kline"==current?http=StockService.getKLine(stockCode):"weekKline"==current?http=StockService.getWMKline(stockCode,current):"monthKline"==current&&(http=StockService.getWMKline(stockCode,current)),http.then(function(res){var data=res.data;100==data.code?drawKLine(data.data,current):X.tip(data.resultMsg)})["catch"](function(){X.tip("服务器请求异常")})}function drawSLine(slineData){if(QUOTE_DATA){slineData=slineData||[];var lastTime,data={};slineData.forEach(function(obj,i){lastTime=X.formatDate(obj.time,"hm")-0,data[lastTime]={current:X.toFloat(obj.price),volume:X.toFloat(obj.volume),time:lastTime}}),slineChart=new X.Sline({wrap:"sline-wrap-"+$scope.uuid}),slineChart.draw({data:data,quoteTime:lastTime,close:QUOTE_DATA.yesterdayPrice,high:QUOTE_DATA.highPrice,low:QUOTE_DATA.lowPrice,limitUp:QUOTE_DATA.limitUpPrice,limitDown:QUOTE_DATA.limitDownPrice,period:SystemService.getRealPeriod("STOCK",lastTime),isStock:!0,isIntl:!1,code:stockCode})}}function drawKLine(klineData,type){klineData=klineData||[];var data=[];klineData.forEach(function(o,i){data[i]={time:8==o.time.length?o.time:X.formatDate(o.time,"YMD"),open:o.open,close:o.last,high:o.high,low:o.low,price:o.price}}),klineChart||(klineChart=new X.Kline({wrap:"kline-wrap-"+$scope.uuid})),klineChart.draw(data),"kline"==type?CACHE_KLINE=data:"weekKline"==type?CACHE_WEEKKLINE=data:CACHE_MONTHKLINE=data}function getStockInfo(flag){X.log("行情定时器运行中。。。"),isTrade?(isInTradeTime=SystemService.isInPeriod("STOCK","trade"),isInTradeTime?$scope.isRiskStock?$scope.btn={className:"disabled",btnText:"立即点买",disabled:!0}:QUOTE_DATA&&0==QUOTE_DATA.newPrice?$scope.btn={className:"disabled",btnText:"立即点买",disabled:!0}:$scope.btn={className:"orange",btnText:"立即点买",disabled:!1}:$scope.btn={className:"disabled",btnText:"非点买时段",disabled:!0}):(isInTradeTime=!1,$scope.btn={className:"disabled",btnText:"暂停交易",disabled:!0});var isInQuoteTime=SystemService.isInPeriod("STOCK","quote");flag||isInQuoteTime||$scope.$apply(),dataIsLoad&&isInQuoteTime&&(dataIsLoad=!1,StockService.getStockInfo(stockCode).then(function(res){dataIsLoad=!0;var data=res.data;100==data.code?processStockInfoData(data.data[stockCode]):X.tip(data.resultMsg)})["catch"](function(){X.tip("服务器请求异常")}))}function processNum(data,type){var num=data[type],unit="todayDealNum"==type?"手":"元";return num>1e8?(num/1e8).toFixed(2)+"亿"+unit:num>1e4?(num/1e4).toFixed(2)+"万"+unit:num+unit}function newSlineQuoteData(quote){var price=0==quote.newPrice?quote.yesterdayPrice:quote.newPrice,o={current:price,volume:0,time:X.formatDate(quote.time,"hm")-0};slineChart&&slineChart.perDraw(o,{quoteTime:o.time,close:quote.yesterdayPrice,high:quote.highPrice,low:quote.lowPrice,limitUp:quote.limitUpPrice,limitDown:quote.limitDownPrice,period:SystemService.getRealPeriod("STOCK",o.time),isStock:!0,code:stockCode})}function newKlineQuoteData(quote){if(0!=quote.newPrice&&CACHE_KLINE&&CACHE_KLINE.length){var o={time:X.formatDate(quote.time,"YMD"),open:quote.openPrice,close:quote.yesterdayPrice,high:quote.highPrice,low:quote.lowPrice,price:quote.newPrice};if("kline"==$scope.actType){var last=CACHE_KLINE[CACHE_KLINE.length-1];last.time===o.time?CACHE_KLINE[CACHE_KLINE.length-1]=o:CACHE_KLINE.push(o),klineChart&&klineChart.draw(CACHE_KLINE)}else if("weekKline"==$scope.actType){var last=CACHE_WEEKKLINE[CACHE_WEEKKLINE.length-1];last.time===o.time?CACHE_WEEKKLINE[CACHE_WEEKKLINE.length-1]=o:CACHE_WEEKKLINE.push(o),klineChart&&klineChart.draw(CACHE_WEEKKLINE)}else if("monthKline"==$scope.actType){var last=CACHE_MONTHKLINE[CACHE_MONTHKLINE.length-1];last.time===o.time?CACHE_MONTHKLINE[CACHE_MONTHKLINE.length-1]=o:CACHE_MONTHKLINE.push(o),klineChart&&klineChart.draw(CACHE_MONTHKLINE)}}}if(null==initData)return void X.tip("初始化信息加载错误，请重试");var strRisk=JSON.parse(initData.strRisk),defaultStock=strRisk.defaultStock?strRisk.defaultStock.value:0,serviceCharge=strRisk.serviceCharge.value,maxStockCount=parseInt(strRisk.maxStockCount.value),priceRisk=strRisk.priceRisk.value.split(","),tradingCountRatio=(initData.balance,strRisk.tradingCountRatio.value),holiday=SystemService.parseHoliday(initData.holidays),tradeTime=SystemService.parsePeriod(strRisk.tradingTimeLimit.value),isTrade=!strRisk.bussmannSwitch||"1"!=strRisk.bussmannSwitch.value;SystemService.setCurrentTime(initData.nowTime),SystemService.setCurrentCurrencyType("CNY"),SystemService.setHoliday(holiday),SystemService.setTradePeriod(tradeTime);var QUOTE_DATA,CACHE_KLINE,CACHE_WEEKKLINE,CACHE_MONTHKLINE,storage=window.localStorage,STOCKCODE="STOCKCODE",MINELIST="MINELIST",stockCode=storage.getItem(STOCKCODE)||defaultStock||"SH600570",mineListStr=storage.getItem(MINELIST)||"",isInTradeTime=!1,isStopStock=!1,dataIsLoad=!0,riskStocks=[],slineChart=null,klineChart=null;$scope.stockType="T+D",$scope.stockTypes={trade:"T+1",TDTrade:"T+D"},$scope.stock={},$scope.uuid=SystemService.uuid(),$scope.isRiskStock=!1,$scope.showMenu=!1,$scope.mineType="add",$scope.actType="sline",$scope.stopTimer=!1,$scope.stock={},$scope.btn={className:"disabled",btnText:"数据加载中",disabled:!0},$scope.showSchemeLastDayTip=!1,$scope.isLogin=!1,$scope.scheme=null,$scope.serviceCharge=0,$scope.totalStockMoney=0,$scope.stockNumObj={max:100,curr:100,min:100,canMax:!1,canMin:!1},$scope.tipBalance=0,$scope.usTipBalance=0;var vm=$scope.vm={};vm.useTip=!0,X.loading.show(),$q.all({trade:TradeService.getRiskStock(),info:StockService.getStockInfo(stockCode),scheme:TradeService.getHoldingScheme(),packet:PacketService.getPacketFundInfoData()}).then(function(res){var infoData=res.info.data,tradeData=res.trade.data,schemeData=res.scheme.data,packetData=res.packet.data;100==schemeData.code?($scope.isLogin=!0,$scope.scheme=schemeData.data,$scope.scheme.availableMoney=schemeData.data.availableMoney,$scope.scheme.currentMarketValue=$scope.scheme.marketValue+$scope.scheme.suspendedValue):900==schemeData.code?($scope.isLogin=!0,$scope.scheme=null):405==schemeData.code?($scope.isLogin=!1,$scope.scheme=null):X.tip(schemeData.resultMsg),100==tradeData.code&&100==infoData.code&&100==packetData.code?(riskStocks=tradeData.data,$scope.tipBalance=packetData.data.tipBalance,0==$scope.tipBalance&&(vm.useTip=!1),confirmMineType(),checkRiskStock(),processStockInfoData(infoData.data[stockCode]),init(),$scope.changeTab("sline")):100!=tradeData.code?X.tip(tradeData.resultMsg):100!=infoData.code?X.tip(infoData.resultMsg):100!=packetData.code&&X.tip(packetData.resultMsg),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")}),$scope.changeTab=function(current){$scope.actType=current,"sline"!=current||slineChart?("kline"!=current||CACHE_KLINE)&&("weekKline"!=current||CACHE_WEEKKLINE)?"monthKline"!=current||CACHE_MONTHKLINE||getStockKline(current):getStockKline(current):getStockSline(),"kline"==current&&CACHE_KLINE?drawKLine(CACHE_KLINE,current):"weekKline"==current&&CACHE_WEEKKLINE?drawKLine(CACHE_WEEKKLINE,current):"monthKline"==current&&CACHE_MONTHKLINE&&drawKLine(CACHE_MONTHKLINE,current)},$scope.addOrDelMine=function(stockCode,stockName){if(!stockCode||!stockName)return!1;var maxLen=20,mineListStr=storage.getItem(MINELIST)||"",mineArr=[];if(""==mineListStr||mineListStr.indexOf(stockCode)==-1){if(""!=mineListStr&&(mineArr=mineListStr.split(";")),mineArr.length>=maxLen)return void X.dialog.alert("自选最多添加"+maxLen+"条记录");mineArr.push(stockCode+","+stockName),storage.setItem(MINELIST,mineArr.join(";")),$scope.mineType="delete"}else{mineArr=mineListStr.split(";");for(var i=0;i<mineArr.length;i++)mineArr[i].indexOf(stockCode)!=-1&&mineArr.splice(i,1);storage.setItem(MINELIST,mineArr.join(";")),$scope.mineType="add"}},$scope.changeStockNum=function(curr){curr=100*parseInt(curr/100),(isNaN(curr)||curr<0)&&(curr=0),$scope.stockNumObj.curr=curr,$scope.stockNumObj.canMax=!0,$scope.stockNumObj.canMin=!0,$scope.stockNumObj.curr>=$scope.stockNumObj.max&&($scope.stockNumObj.curr=$scope.stockNumObj.max,$scope.stockNumObj.canMax=!1),$scope.stockNumObj.curr<=$scope.stockNumObj.min&&($scope.stockNumObj.curr=$scope.stockNumObj.min,$scope.stockNumObj.canMin=!1);var realPrice=$scope.stock.price*tradingCountRatio;realPrice>$scope.stock.limitUpPrice&&(realPrice=$scope.stock.limitUpPrice),$scope.totalStockMoney=Math.round(Math.floor(Math.round(1e4*realPrice)/100)/100*$scope.stockNumObj.curr);var stockServiceUnit=$scope.totalStockMoney/1e4;stockServiceUnit<1&&(stockServiceUnit=1),$scope.serviceCharge=Math.floor(Math.round(stockServiceUnit*serviceCharge*1e4)/100)/100},$scope.toTrade=function(){if(!isTrade)return X.dialog.alert("暂停交易"),!1;if(!SystemService.isInPeriod("STOCK","trade"))return X.dialog.alert("当前为非点买时段，无法发起策略"),!1;if(isStopStock)return X.dialog.alert("停牌股无法进行交易<br>请更换其他能够正常交易的股票"),!1;if(!$scope.isLogin)return $location.url("/login?goURL=/TDTrade"),!1;if($scope.isRiskStock)return X.dialog.alert("【"+$scope.stock.stockName+"】今日点买风险较高，暂无投资人接收交易合作"),!1;var currPrice=$scope.stock.price,closePrice=$scope.stock.lastClosePrice,diff=currPrice-closePrice,rote=(diff/closePrice*100).toFixed(2);return rote>X.toFloat(priceRisk[1])||rote<X.toFloat(priceRisk[0])?(X.dialog.alert("该股今日点买风险较高，暂无投资人接收交易合作"),!1):null==$scope.scheme?($location.url("/TDApply"),!1):void $location.url("/TDTradeBuy")},$scope.jumpToSG=function(){$location.url("/myStrategyGroup")},$scope.$on("$destroy",function(){X.engine.destroy()})}),myControllers.controller("TDTradeBuyCtrl",function($scope,$q,$routeParams,$location,$sce,initData,TradeService,PacketService,StockService,SystemService){function confirmMineType(){""==mineListStr?$scope.mineType="add":$scope.mineType=mineListStr.indexOf(stockCode)==-1?"add":"delete"}function checkRiskStock(){for(var i=0;i<riskStocks.length;i++){var item=riskStocks[i];if(stockCode==item.stockCode){$scope.isRiskStock=!0;break}}}function processStockInfoData(data){var newPrice=data.newPrice,lastClosePrice=data.lastClosePrice,isStop=isStopStock=0==newPrice,style="",dealNum="",dealPrice="",diff=0,rate=0;isStop||(diff=newPrice-lastClosePrice,rate=diff/lastClosePrice*100,diff=diff.toFixed(2),rate=rate.toFixed(2),style=newPrice>lastClosePrice?"txt-red":newPrice<lastClosePrice?"txt-green":"txt-white",dealNum=processNum(data,"todayDealNum"),dealPrice=processNum(data,"todayDealPrice")),$scope.stock={stockLabel:data.stockLabel,stockName:data.stockName,price:parseInt(100*newPrice)/100,lastClosePrice:lastClosePrice,isStop:isStop,diff:diff,rate:rate,style:style,dealNum:dealNum,dealPrice:dealPrice,openPrice:data.openPrice,highPrice:data.highPrice,lowPrice:data.lowPrice,limitDownPrice:parseFloat(data.limitDownPrice),limitUpPrice:parseInt(100*data.limitUpPrice)/100,amplitude:data.amplitude,todayDealNum:data.todayDealNum,todayDealPrice:data.todayDealPrice,buyPrice:isStop?[0,0,0,0,0]:data.buyPrice,buyNum:isStop?[0,0,0,0,0]:data.buyNum,sellPrice:isStop?[0,0,0,0,0]:data.sellPrice,sellNum:isStop?[0,0,0,0,0]:data.sellNum},QUOTE_DATA={commodityTitle:"STOCK",contractNo:data.stockLabel,time:data.time,openPrice:data.openPrice,yesterdayPrice:data.lastClosePrice,highPrice:data.highPrice,lowPrice:data.lowPrice,newPrice:data.newPrice,limitDownPrice:X.toFloat(data.limitDownPrice),limitUpPrice:X.toFloat(data.limitUpPrice)}}function init(){if(showLastDayTip(),null!=$scope.scheme){var tradingCount=Math.floor(Math.round($scope.stock.price*tradingCountRatio*1e4)/100)/100,num=100*Math.floor($scope.scheme.availableMoney/tradingCount/100);$scope.stockNumObj.max=num<100?100:num>maxStockCount?maxStockCount:num}getStockInfo(!0),X.engine.addTask(getStockInfo,1e3),X.engine.start()}function showLastDayTip(){if(null!=$scope.scheme&&$scope.scheme.availableDays<3){var schemeId=$scope.scheme.id,tipMsg=[],tipRecord=storage.getItem("SCHEME_LAST_DAY_TIP"),today=X.formatDate(new Date,"Y-M-D"),tipKey="{{"+schemeId+":"+today+"}}";null==tipRecord?($scope.showSchemeLastDayTip=!0,storage.setItem("SCHEME_LAST_DAY_TIP",tipKey)):(tipMsg=tipRecord.split(";"),tipMsg.indexOf(tipKey)==-1&&($scope.showSchemeLastDayTip=!0,tipMsg.push(tipKey),storage.setItem("SCHEME_LAST_DAY_TIP",tipMsg.join(";"))))}}function getStockInfo(flag){X.log("行情定时器运行中。。。"),isTrade?(isInTradeTime=SystemService.isInPeriod("STOCK","trade"),isInTradeTime?$scope.isRiskStock?$scope.btn={className:"disabled",btnText:"提交",disabled:!0}:QUOTE_DATA&&0==QUOTE_DATA.newPrice?$scope.btn={className:"disabled",btnText:"提交",disabled:!0}:$scope.btn={className:"orange",btnText:"提交",disabled:!1}:$scope.btn={className:"disabled",btnText:"非点买时段",disabled:!0}):(isInTradeTime=!1,$scope.btn={className:"disabled",btnText:"暂停交易",disabled:!0});var isInQuoteTime=SystemService.isInPeriod("STOCK","quote");flag||isInQuoteTime||$scope.$apply(),dataIsLoad&&isInQuoteTime&&(dataIsLoad=!1,StockService.getStockInfo(stockCode).then(function(res){dataIsLoad=!0;var data=res.data;100==data.code?processStockInfoData(data.data[stockCode]):X.tip(data.resultMsg)})["catch"](function(){X.tip("服务器请求异常")}))}function processNum(data,type){var num=data[type],unit="todayDealNum"==type?"手":"元";return num>1e8?(num/1e8).toFixed(2)+"亿"+unit:num>1e4?(num/1e4).toFixed(2)+"万"+unit:num+unit}function trade(){$scope.btn={className:"disabled",btnText:"数据处理中",disabled:!0},X.loading.show(),TradeService.strategyCreate($scope.scheme.id,$scope.totalStockMoney,$scope.serviceCharge,stockCode,$scope.stockNumObj.curr,vm.useTip).then(function(res){var data=res.data;100==data.code?(X.tip("策略发起成功"),zhuge.track("交易",{"名称":"A股"}),$location.path("/TDTradeSell")):(X.tip(data.resultMsg),$scope.btn={className:"orange",btnText:"提交",disabled:!1}),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")})}if(null==initData)return void X.tip("初始化信息加载错误，请重试");$scope.stock=$routeParams.stock,$scope.scheme=$routeParams.scheme;var strRisk=JSON.parse(initData.strRisk),defaultStock=strRisk.defaultStock?strRisk.defaultStock.value:0,serviceCharge=strRisk.serviceCharge.value,maxStockCount=parseInt(strRisk.maxStockCount.value),priceRisk=strRisk.priceRisk.value.split(","),tradingCountRatio=(initData.balance,strRisk.tradingCountRatio.value),holiday=SystemService.parseHoliday(initData.holidays),tradeTime=SystemService.parsePeriod(strRisk.tradingTimeLimit.value),isTrade=!strRisk.bussmannSwitch||"1"!=strRisk.bussmannSwitch.value;SystemService.setCurrentTime(initData.nowTime),SystemService.setCurrentCurrencyType("CNY"),SystemService.setHoliday(holiday),SystemService.setTradePeriod(tradeTime);var QUOTE_DATA,storage=window.localStorage,STOCKCODE="STOCKCODE",MINELIST="MINELIST",stockCode=storage.getItem(STOCKCODE)||defaultStock||"SH600570",mineListStr=storage.getItem(MINELIST)||"",isInTradeTime=!1,isStopStock=!1,dataIsLoad=!0,riskStocks=[];$scope.stockType="T+D",$scope.stockTypes={trade:"T+1",TDTrade:"T+D"},$scope.stock={},$scope.uuid=SystemService.uuid(),$scope.isRiskStock=!1,$scope.showMenu=!1,$scope.mineType="add",$scope.stopTimer=!1,$scope.stock={},$scope.btn={className:"disabled",btnText:"数据加载中",disabled:!0},$scope.showSchemeLastDayTip=!1,$scope.isLogin=!1,$scope.scheme=null,$scope.serviceCharge=0,$scope.totalStockMoney=0,$scope.stockNumObj={max:100,curr:100,min:100,canMax:!1,canMin:!1},$scope.tipBalance=0,$scope.usTipBalance=0;var vm=$scope.vm={};vm.useTip=!0,X.loading.show(),$q.all({trade:TradeService.getRiskStock(),info:StockService.getStockInfo(stockCode),scheme:TradeService.getHoldingScheme(),packet:PacketService.getPacketFundInfoData()}).then(function(res){var infoData=res.info.data,tradeData=res.trade.data,schemeData=res.scheme.data,packetData=res.packet.data;100==schemeData.code?($scope.isLogin=!0,$scope.scheme=schemeData.data,$scope.scheme.availableMoney=schemeData.data.availableMoney,$scope.scheme.currentMarketValue=$scope.scheme.marketValue+$scope.scheme.suspendedValue):900==schemeData.code?($scope.isLogin=!0,$scope.scheme=null):405==schemeData.code?($scope.isLogin=!1,$scope.scheme=null):X.tip(schemeData.resultMsg),100==tradeData.code&&100==infoData.code&&100==packetData.code?(riskStocks=tradeData.data,$scope.tipBalance=packetData.data.tipBalance,0==$scope.tipBalance&&(vm.useTip=!1),confirmMineType(),checkRiskStock(),processStockInfoData(infoData.data[stockCode]),init(),$scope.changeStockNum($scope.stockNumObj.curr)):100!=tradeData.code?X.tip(tradeData.resultMsg):100!=infoData.code?X.tip(infoData.resultMsg):100!=packetData.code&&X.tip(packetData.resultMsg),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")}),$scope.changeStockNum=function(curr){curr=100*parseInt(curr/100),(isNaN(curr)||curr<0)&&(curr=0),$scope.stockNumObj.curr=curr,$scope.stockNumObj.canMax=!0,$scope.stockNumObj.canMin=!0,$scope.stockNumObj.curr>=$scope.stockNumObj.max&&($scope.stockNumObj.curr=$scope.stockNumObj.max,$scope.stockNumObj.canMax=!1),$scope.stockNumObj.curr<=$scope.stockNumObj.min&&($scope.stockNumObj.curr=$scope.stockNumObj.min,$scope.stockNumObj.canMin=!1);var realPrice=$scope.stock.price*tradingCountRatio;realPrice>$scope.stock.limitUpPrice&&(realPrice=$scope.stock.limitUpPrice),$scope.totalStockMoney=Math.round(Math.floor(Math.round(1e4*realPrice)/100)/100*$scope.stockNumObj.curr);var stockServiceUnit=$scope.totalStockMoney/1e4;stockServiceUnit<1&&(stockServiceUnit=1),$scope.serviceCharge=Math.floor(Math.round(stockServiceUnit*serviceCharge*1e4)/100)/100},$scope.toTrade=function(){if(!isTrade)return X.dialog.alert("暂停交易"),!1;if(!SystemService.isInPeriod("STOCK","trade"))return X.dialog.alert("当前为非点买时段，无法发起策略"),!1;if(isStopStock)return X.dialog.alert("停牌股无法进行交易<br>请更换其他能够正常交易的股票"),!1;if(!$scope.isLogin)return $location.url("/login?goURL=/TDTradeBuy"),!1;if($scope.isRiskStock)return X.dialog.alert("【"+$scope.stock.stockName+"】今日点买风险较高，暂无投资人接收交易合作"),!1;var currPrice=$scope.stock.price,closePrice=$scope.stock.lastClosePrice,diff=currPrice-closePrice,rote=(diff/closePrice*100).toFixed(2);if(rote>X.toFloat(priceRisk[1])||rote<X.toFloat(priceRisk[0]))return X.dialog.alert("该股今日点买风险较高，暂无投资人接收交易合作"),!1;if(null==$scope.scheme)return $location.url("/TDApply"),!1;if($scope.stockNumObj.curr>maxStockCount)return X.dialog.alert("单股最高可购买数量为"+maxStockCount+"股"),!1;var needMoney=$scope.totalStockMoney;return vm.useTip&&($scope.usTipBalance=Math.min($scope.serviceCharge,$scope.tipBalance)),$scope.scheme.availableMoney<needMoney?(X.dialog.alert("策略组余额不足，您可以到“个人中心-我的策略组”追加点买金额"),!1):null!=$scope.scheme&&0==$scope.scheme.availableDays?(X.dialog.alert("您的T+D点买策略组即将到期，不允许买入"),!1):void trade()},$scope.jumpToSG=function(){$location.url("/myStrategyGroup")},$scope.$on("$destroy",function(){X.engine.destroy()})}),myControllers.controller("TDTradeSellCtrl",function($scope,$sce,$q,$interval,TradeService,StockService,SystemService){function initTodayStartTime(serverTime){serverTime=serverTime||Date.now();var now=new Date(serverTime),yyyy=now.getFullYear(),MM=now.getMonth(),dd=now.getDate(),today=new Date(yyyy,MM,dd,0,0,0);$scope.todayStartTime=today.getTime()}function getData(){var http;http=first?TradeService.TDGetSaleStrategy():TradeService.TDGetSaleStrategyOfMemcache(),first=!1,$q.all({trade:http}).then(function(res){var traData=res.trade.data;if(X.loading.hide(),100==traData.code){tradeData=traData.data,tradeData.length||($scope.showNoData=!0);var stocks=getNeedStocks(tradeData);if(""==stocks||!stocks)return $scope.dataList=[],void($scope.dataIsLoad=!0);StockService.getStockInfo(stocks).then(function(res){var data=res.data;100==data.code?(quoteData=data.data,processData()):initNoDataQuote(tradeData)})["catch"](function(){X.tip("服务器请求异常")})}else $scope.showNoData=!0})["catch"](function(){X.tip("服务器请求异常")})}function processData(){if($scope.dataIsLoad=!0,isOK=!0,null==tradeData||null==quoteData)return $scope.dataList=[],void($scope.showNoData=!0);var dataList=tradeData;total=0,dataList.forEach(function(item){var quote=quoteData[item.stockCode];item.quotePrice=quote.newPrice,item.lastClosePrice=quote.lastClosePrice,item.dealTime>$scope.todayStartTime?item.showSellBtn=!1:item.showSellBtn=!0,0!=item.buyPriceDeal&&0!=item.quotePrice&&0!=item.volumeHold?(item.profit=(item.quotePrice-item.buyPriceDeal)*item.volumeHold,item.quotePrice=quote.newPrice):item.profit=(item.lastClosePrice-item.buyPriceDeal)*item.volumeHold,item.status>3&&(total+=item.profit),item.dealTime=X.formatDate(item.dealTime,"Y-M-D h:m:s")}),$scope.allGain=total,$scope.dataList=dataList}function sale(tradeID,isAlwaysClose){return $scope.isInTradeTime?(X.loading.show(),void TradeService.closeStrategy(tradeID,isAlwaysClose).then(function(res){var data=res.data;100==data.code?(getData(),X.tip("点卖策略成功")):X.tip(data.resultMsg),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")})):void X.tip("非交易时间不能交易")}function initNoDataQuote(data){$scope.dataIsLoad=!0,isOK=!0,X.loading.hide();var dataList=data;$.each(dataList,function(i,item){item.quotePrice=0,item.lastClosePrice=0,item.profit=0,item.status>3&&(total+=item.profit),item.dealTime=X.formatDate(item.dealTime,"Y-M-D h:m:s")}),$scope.allGain=total,$scope.dataList=dataList}function buyOutDialog(trade,type){$scope.currentTrade=trade,$scope.showDBBG=!0;var holdStrategyMoney=trade.lastClosePrice*trade.volumeHold,costMoney=trade.money;$scope.holdStrategyMoney=parseInt(Math.round(1e4*holdStrategyMoney)/100)/100,$scope.costMoney=parseInt(Math.round(1e4*costMoney)/100)/100,$scope.stockName=trade.stockName,2==type?($scope.paySum=$scope.costMoney,$scope.showBuyOutMenu=!0):($scope.paySum=parseInt(Math.round(costMoney/($scope.leverRatio+1)*1e4)/100)/100,$scope.showQuitType=!0)}function getNeedStocks(dataList){var stocksObj={},stocks="",arr=[];$.each(dataList,function(i,item){stocksObj[item.stockCode]=item.stockCode});for(var key in stocksObj)arr.push(key);return arr.length>0&&(stocks=arr.join(",")),stocks}function startTimer(){isOK=!0,getData(),timer=$interval(function(){X.log("点卖定时器运行中。。。"),$scope.isInTradeTime=SystemService.isInPeriod("STOCK","trade"),$scope.isInJJPeriod=SystemService.isInJJPeriod(),(first||!$scope.isHoliday&&$scope.isInTradeTime&&isOK)&&(isOK=!1,getData())},1e3)}function clearTimer(){timer&&($interval.cancel(timer),timer=void 0)}var timer,first=!0,tradeData=null,marketData=null,quoteData=null,isOK=!1,DYTip=!1;$scope.tradeState={1:"等待接单",2:"正在委托买入",3:"正在委托买入",4:"点卖",5:"正在委托卖出",6:"正在委托卖出",7:"正在清算",8:"已清算"},$scope.dataList=[],$scope.dataIsLoad=!1,$scope.isInTradeTime=!1,$scope.isInJJPeriod=!0,$scope.isHoliday=!0,$scope.todayStartTime=0,$scope.showCondition=!1,$scope.stockType="T+D",$scope.allGain=0,$scope.currMarketMoney=0,$scope.suspendStockArr=[],$scope.showRemainDays=!1,$scope.quiLossMoney=0,$scope.showNoData=!1,$scope.showSellBtn=!1,$scope.hold=null,$scope.stockTypes={trade:"T+1",TDTrade:"T+D"},$scope.showMenu=!1,X.loading.show(),$q.all({trade:TradeService.initTDTrade(),hold:TradeService.getHoldingScheme(),market:TradeService.getStrategyMarketValue(),DY:TradeService.getWaitPayDeferForRemind()}).then(function(res){var tradeData=res.trade.data,holdData=res.hold.data,marData=res.market.data,DYData=res.DY.data;if($scope.hold=holdData.data,X.loading.hide(),100==tradeData.code&&100==holdData.code&&100==marData.code&&100==DYData.code){var data=tradeData.data;marketData=marData.data;var strRisk=JSON.parse(data.strRisk),holiday=SystemService.parseHoliday(data.holidays),tradeTime=SystemService.parsePeriod(strRisk.tradingTimeLimit.value);SystemService.setCurrentTime(data.nowTime),SystemService.setCurrentCurrencyType("CNY"),SystemService.setHoliday(holiday),SystemService.setTradePeriod(tradeTime);var holidays=data.holidays,today=X.formatDate(data.nowTime,"Y-M-D");holidays.indexOf(today)==-1&&($scope.isHoliday=!1),$scope.isInTradeTime=SystemService.isInPeriod("STOCK","trade"),$scope.isInJJPeriod=SystemService.isInJJPeriod(),$scope.leverRatio=holdData.data.leverRatio;var marketArr=marketData.split(";");$scope.currentMarketMoney=holdData.data.marketValue+holdData.data.suspendedValue,$scope.canUseMoney=holdData.data.availableMoney;var allMoney=holdData.data.money,quitLossRatio=strRisk.quitLossRatio.value-0,deferConditionRatio=strRisk.deferConditionRatio.value-0;$scope.quiLossMoney=(allMoney*quitLossRatio/100).toFixed(0),$scope.canDeferMoney=(allMoney*deferConditionRatio/100).toFixed(0),$scope.currMoney=marketArr[0]-0+(marketArr[1]-0)+(marketArr[2]-0),0!=DYData.data&&(DYTip=!0),initTodayStartTime(data.nowTime),startTimer()}else $scope.canUseMoney=0,$scope.showNoData=!0,100!=tradeData.code?X.tip(tradeData.resultMsg):100!=holdData.code?X.tip(holdData.resultMsg):100!=marData.code&&X.tip(marData.resultMsg)})["catch"](function(){X.tip("服务器请求异常")}),$scope.showDeferCondition=function(){$scope.showCondition=!$scope.showCondition},$scope.sale=function(trade){var html='<div class="mod-sale-confirm-wrap">';html+='<div class="item">股票名称:<span class="fr">'+trade.stockName+"</span></div>",html+='<div class="item">股票代码:<span class="fr">'+trade.stockCode.substr(-6)+"</span></div>",html+='<div class="item">委托价格:<span class="fr">市价</span></div>',html+='<div class="item">卖出数量:<span class="fr">'+trade.volumeHold+"股</span></div>",html+='<div class="item">持仓天数:<span class="fr">'+trade.holdDays+"天</span></div>",html+=trade.profit>0?'<div class="item">浮动盈亏:<span class="fr txt-red">+'+trade.profit.toFixed(2)+"元</span></div>":trade.profit<0?'<div class="item">浮动盈亏:<span class="fr txt-green">'+trade.profit.toFixed(2)+"元</span></div>":'<div class="item">浮动盈亏:<span class="fr">'+trade.profit.toFixed(2)+"元</span></div>",html+='<div class="item"><label><input id="agreeDefer" type="checkbox" checked> 是否递延指令</label></div>',html+='<div class="txt-grey txt-s12">注：点卖指令可能因跌停导致无法成交，默认至下一个交易日挂单交易。浮动盈亏仅供参考，具体以实际成交为准。</div>',html+="</div>",X.dialog.confirm(html,{title:"点卖确认",notify:function(nt){if(1==nt){var agreeDefer=document.getElementById("agreeDefer");sale(trade.id,agreeDefer.checked)}}})};var total=0;$scope.showBuyOutMenu=!1,$scope.showDBBG=!1,$scope.buyOut=function(trade,type){if(trade&&type)return DYTip&&2==type?void X.dialog.confirm("温馨提示：请您确认是否已经将今日递延<br/>费留在余额中等待扣款，如果继续操作可<br/>能会造成操盘中策略因递延费不足被平仓",{sureBtn:"确定",notify:function(nt){1==nt&&$scope.$apply(function(){buyOutDialog(trade,type)})}}):void buyOutDialog(trade,type)},$scope.confirmBuyOrQuit=function(takeOverType){X.loading.show(),TradeService.takeOverStrategy($scope.currentTrade.id,takeOverType,$scope.paySum).then(function(res){var data=res.data;100==data.code?1==takeOverType?X.tip("放弃策略成功"):X.tip("买断策略成功"):X.tip(data.resultMsg),$scope.cancelOperate(),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")})},$scope.cancelOperate=function(){$scope.showBuyOutMenu=!1,$scope.showDBBG=!1,$scope.showQuitType=!1,$scope.showRemainDays=!1},$scope.showPartDeal=function(trade){var list=trade.tradingRecordList,volumeDeal=trade.volumeHold,table="";table+="<table>",table+='<tr><td>成交时间</td><td>数量</td><td class="txt-right">价格</td></tr>';for(var i=0;i<list.length;i++){var obj=list[i];table+="<tr><td>"+X.formatDate(new Date(obj.time),"Y-M-D")+"</td><td>"+obj.amount+'</td><td class="txt-right">'+obj.price.toFixed(2)+"</td></tr>",volumeDeal+=obj.amount}table+="</table>";var tipHtml='<div class="info">行情波动过大，造成部分成交，原持有数量'+volumeDeal+"股，现剩余"+trade.volumeHold+"股，请处理剩余数量，以便结算！</div>";X.dialog.alert('<div class="mod-part-deal-wrap">'+tipHtml+table+"</div>")},$scope.$on("$destroy",function(){clearTimer()})}),myControllers.controller("TDTradeResultCtrl",function($scope,$location,SystemService,$interval,$q,TradeService){function getData(){TradeService.getHoldingScheme().then(function(res){var data=res.data;if($scope.hold=data.data,100==data.code){if(data.data){var currMarketMoney=data.data.marketValue,suspendedValue=data.data.suspendedValue;$scope.currentMarketMoney=currMarketMoney+suspendedValue,$scope.canUseMoney=data.data.availableMoney.toFixed(2)}}else X.tip(data.resultMsg)})["catch"](function(){X.tip("服务器请求异常")})}$scope.settleList=[],$scope.currPage=1,$scope.totalPage=1,$scope.stockType="T+D",$scope.hold=null,$scope.stockTypes={trade:"T+1",TDTrade:"T+D"},$scope.showMenu=!1;var pageSize=10;$scope.getSettleList=function(page){X.loading.show(),TradeService.TDGetSettleStrategyByPage(page,pageSize).then(function(res){var settleData=res.data;if(100==settleData.code){X.loading.hide();var data=settleData.data;if(data){$scope.currPage=data.pageIndex,$scope.totalPage=data.totalPage;var list=data.dataList;1==page?$scope.settleList=list:$scope.settleList=$scope.settleList.concat(list)}}else X.tip(settleData.resultMsg);getData()})["catch"](function(){X.tip("服务器请求异常")})},$scope.getSettleList($scope.currPage),$scope.toDetail=function(tradeID){$location.url("/TDTradeDetail/"+tradeID)}}),myControllers.controller("SuspendStocksCtrl",function($scope,$q,$location,$interval,StockService,TradeService,SystemService){
function getSusList(){X.loading.show(),TradeService.getTakeOverStrategy().then(function(res){var susData=res.data;if(100==susData.code){if(suspendData=susData.data,!suspendData)return void($scope.showNoData=!0);if(stocks=getNeedStocks(suspendData),""==stocks)return void($scope.suspendList=[]);var dataList=suspendData,stocksArr=stocks.split(",");stocksArr.forEach(function(stock){ref[stock]=[],dataList.forEach(function(item){item.stockCode==stock&&ref[stock].push(dataList.indexOf(item))})}),getStockInfo(),X.loading.hide()}else X.tip(susData.resultMsg)})["catch"](function(){X.tip("服务器请求异常")})}function getStockInfo(){X.loading.show(),StockService.getStockInfo(stocks).then(function(res){var data=res.data;if(100==data.code){if(quoteData=data.data,null==suspendData)return void($scope.suspendList=[]);if(suspendData.forEach(function(item){if(null==quoteData)item.quotePrice=0,item.lastClosePrice=0;else{var quote=quoteData[item.stockCode];item.quotePrice=quote.newPrice||0,item.lastClosePrice=quote.lastClosePrice||0}item.holdMarketSum=item.quotePrice*item.volumeHold,item.profit=(item.quotePrice-item.buyPriceDeal)*item.volumeHold,0!=item.quotePrice?hasNewPriceCode[item.stockCode]=item.stockCode:item.holdMarketSum=item.lastClosePrice*item.volumeHold}),hasNewPriceCode=={})return;for(var key in hasNewPriceCode)hasNewPriceStocks.push(key);hasNewPriceStocks.length>0&&(newPriceStocks=hasNewPriceStocks.join(",")),startTimer(),$scope.suspendList=suspendData}else initNoDataQuote(suspendData);X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")})}function initNoDataQuote(data){$scope.dataIsLoad=!0,X.loading.hide();var dataList=data;$.each(dataList,function(i,item){item.quotePrice=0,item.holdMarketSum=0,item.lastClosePrice=0}),$scope.suspendList=dataList}function getNewPriceStockInfo(){var dataList=suspendData;""!=newPriceStocks&&StockService.getStockInfo(newPriceStocks).then(function(res){var data=res.data;if(100==data.code){var quoteData=data.data;if(ref!={}){for(var key in ref){var quote=quoteData[key];quote&&quote.stockLabel==key&&ref[key].forEach(function(index){dataList[index].quotePrice=quote.newPrice,dataList[index].holdMarketSum=quote.newPrice*dataList[index].volumeHold})}$scope.suspendList=dataList}}else X.tip(data.resultMsg)})["catch"](function(){X.tip("服务器请求异常")})}function getNeedStocks(suspendData){var stocks="",stocksObj={},arr=[];suspendData.forEach(function(item){stocksObj[item.stockCode]=item.stockCode});for(var key in stocksObj)arr.push(key);return arr.length>0&&(stocks=arr.join(",")),stocks}function sale(tradeID,isAlwaysClose){return $scope.isInTradeTime?(X.loading.show(),void TradeService.closeStrategy(tradeID,isAlwaysClose).then(function(res){var data=res.data;100==data.code?(X.tip("点卖策略成功"),window.location.reload()):X.tip(data.resultMsg),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")})):void X.tip("非交易时间不能交易")}function initTodayStartTime(serverTime){serverTime=serverTime||Date.now();var now=new Date(serverTime),yyyy=now.getFullYear(),MM=now.getMonth(),dd=now.getDate(),today=new Date(yyyy,MM,dd,0,0,0);$scope.todayStartTime=today.getTime()}function startTimer(){getNewPriceStockInfo(),timer=$interval(function(){X.log("点卖定时器运行中。。。"),$scope.isInTradeTime=SystemService.isInPeriod("STOCK","trade"),!$scope.isHoliday&&$scope.isInTradeTime&&getNewPriceStockInfo()},1e3)}function clearTimer(){timer&&($interval.cancel(timer),timer=void 0)}var timer,suspendData=null,tradeData=null,TDTradeData=null,quoteData=null;$scope.showNoData=!1,$scope.isInTradeTime=!1,$scope.isHoliday=!0,$scope.TDIsHoliday=!0,$scope.todayStartTime=0,$scope.suspendList=[],$scope.tradeState={1:"等待接单",2:"正在委托买入",3:"正在委托买入",4:"点卖",5:"正在委托卖出",6:"正在委托卖出",7:"正在清算",8:"已清算"},X.loading.show(),$q.all({trade:TradeService.getInitTrade(),TDTrade:TradeService.initTDTrade()}).then(function(res){var traData=res.trade.data,TDTraData=res.TDTrade.data;if(100==traData.code&&100==TDTraData.code){tradeData=traData.data,TDTradeData=TDTraData.data;var strRisk=JSON.parse(tradeData.strRisk),TDStrRisk=JSON.parse(TDTradeData.strRisk);$scope.isHoliday=tradeData.isHoliday;var holiday=SystemService.parseHoliday(tradeData.holidays),TDHoliDay=SystemService.parseHoliday(TDTradeData.holidays),tradeTime=SystemService.parsePeriod(strRisk.tradingTimeLimit.value),TDTradeTime=SystemService.parsePeriod(TDStrRisk.tradingTimeLimit.value),TDHoliDays=TDTradeData.holidays;SystemService.setCurrentTime(tradeData.nowTime),SystemService.setCurrentCurrencyType("CNY"),SystemService.setHoliday(holiday),SystemService.setTradePeriod(tradeTime),SystemService.setCurrentTime(TDTradeData.nowTime),SystemService.setCurrentCurrencyType("CNY"),SystemService.setHoliday(TDHoliDay),SystemService.setTradePeriod(TDTradeTime);var today=X.formatDate(TDTradeData.nowTime,"Y-M-D");TDHoliDays.indexOf(today)==-1&&($scope.TDIsHoliday=!1),$scope.isInTradeTime=SystemService.isInPeriod("STOCK","trade"),initTodayStartTime(tradeData.nowTime),getSusList()}else 100!=traData.code?X.tip(traData.resultMsg):100!=TDTraData.code&&X.tip(TDTraData.resultMsg);X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")});var hasNewPriceStocks=[],newPriceStocks="",hasNewPriceCode={},ref={},stocks="";$scope.sale=function(trade){var html='<div class="mod-sale-confirm-wrap">';html+='<div class="item">股票名称:<span class="fr">'+trade.stockName+"</span></div>",html+='<div class="item">股票代码:<span class="fr">'+trade.stockCode.substr(-6)+"</span></div>",html+='<div class="item">委托价格:<span class="fr">市价</span></div>',html+='<div class="item">卖出数量:<span class="fr">'+trade.volumeHold+"股</span></div>",html+='<div class="item">持仓天数:<span class="fr">'+trade.holdDays+"天</span></div>",html+=trade.profit>0?'<div class="item">浮动盈亏:<span class="fr txt-red">+'+trade.profit.toFixed(2)+"元</span></div>":trade.profit<0?'<div class="item">浮动盈亏:<span class="fr txt-green">'+trade.profit.toFixed(2)+"元</span></div>":'<div class="item">浮动盈亏:<span class="fr">'+trade.profit.toFixed(2)+"元</span></div>",html+='<div class="item"><label><input id="agreeDefer" type="checkbox" checked> 是否递延指令</label></div>',html+='<div class="txt-grey txt-s12">注：点卖指令可能因跌停导致无法成交，默认至下一个交易日挂单交易。浮动盈亏仅供参考，具体以实际成交为准。</div>',html+="</div>",X.dialog.confirm(html,{title:"点卖确认",notify:function(nt){if(getSusList(),1==nt){var agreeDefer=document.getElementById("agreeDefer");sale(trade.id,agreeDefer.checked)}}})},$scope.showPartDeal=function(trade){var list=trade.tradingRecordList,volumeDeal=trade.volumeHold,table="";table+="<table>",table+='<tr><td>成交时间</td><td>数量</td><td class="txt-right">价格</td></tr>';for(var i=0;i<list.length;i++){var obj=list[i];table+="<tr><td>"+X.formatDate(new Date(obj.time),"Y-M-D")+"</td><td>"+obj.amount+'</td><td class="txt-right">'+obj.price.toFixed(2)+"</td></tr>",volumeDeal+=obj.amount}table+="</table>";var tipHtml='<div class="info">行情波动过大，造成部分成交，原持有数量'+volumeDeal+"股，现剩余"+trade.volumeHold+"股，请处理剩余数量，以便结算！</div>";X.dialog.alert('<div class="mod-part-deal-wrap">'+tipHtml+table+"</div>")},$scope.reFresh=function(){window.location.reload()},$scope.toDetail=function(item){8==item.status&&$location.url("/suspendDetail/"+item.id+"?schemeId="+item.schemeId)},$scope.$on("$destroy",function(){clearTimer(),X.engine.destroy()})}),myControllers.controller("TradeDetailCtrl",function($scope,$q,$routeParams,$location,TradeService){var tradeId=$routeParams.tradeId;return $scope.schemeId=$location.search().schemeId,$scope.sort=$location.search().sort,/^\d+$/.test(tradeId)?($scope.trade={},X.loading.show(),void $q.all({tradeInfo:TradeService.getSettleStrategyById(tradeId)}).then(function(res){var tradeInfoData=res.tradeInfo.data;100==tradeInfoData.code?$scope.trade=tradeInfoData.data:X.tip(tradeInfoData.resultMsg),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")})):void $location.path("/index")}),myControllers.controller("AgreementSignedCtrl",function($scope,$location,UserService){var storage=window.localStorage,stockCode=storage.getItem("STOCKCODE")||"",goURL=$location.search().goURL;$scope.goURL="/trade",stockCode&&""!=stockCode&&($scope.goURL="/tradeBuy/"+stockCode),goURL&&""!=goURL&&($scope.goURL=goURL),$scope.singAgreement=function(){var agree=document.getElementById("agreement");return agree.checked?(X.loading.show(),void UserService.signAgreement().then(function(res){var data=res.data;100==data.code?$location.url($scope.goURL):X.tip(data.resultMsg),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")})):(X.tip("请先同意签署相关协议"),!1)}}),myControllers.controller("AgreementInvestorCtrl",function($scope,$q,$location,TradeService){function init(){tradeID&&(X.loading.show(),TradeService.getAgreementStrategyById(tradeID).then(function(res){var data=res.data;100==data.code&&($scope.tradeInfo=data.data),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")}))}$scope.showHeader=!0;var source=$location.search().source;source&&"IOSAPP"==source&&($scope.showHeader=!1);var tradeID=$location.search().tradeID;$scope.schemeId=$location.search().schemeId,$scope.tradeInfo=null,init()}),myControllers.controller("AgreementTradeCtrl",function($scope,$location){$scope.showHeader=!0;var source=$location.search().source;source&&"IOSAPP"==source&&($scope.showHeader=!1)}),myControllers.controller("AgreementSaletorCtrl",function($scope,$location){$scope.showHeader=!0;var source=$location.search().source;source&&"IOSAPP"==source&&($scope.showHeader=!1)}),myControllers.controller("AgreementRegister",function($scope,$location){$scope.showHeader=!0;var source=$location.search().source;source&&"IOSAPP"==source&&($scope.showHeader=!1)}),myControllers.controller("MineCtrl",function($scope,$q,$location,$interval,TradeService,StockService,SystemService){function process(){stockCodes=["SH000001","SZ399001","SZ399006"];var mineArr=mineListStr&&""!=mineListStr?mineListStr.split(";"):[];$.each(mineArr,function(i,item){var itemArr=item.split(",");stockCodes.push(itemArr[0])}),query()}function query(){getStockInfo(),timer=$interval(function(){X.log("自选定时器运行中。。。"),isInQuoteTime=SystemService.isInPeriod("STOCK","quote"),!isHoliday&&isInQuoteTime&&dataIsLoaded&&(dataIsLoaded=!1,getStockInfo())},1e3)}function clearTimer(){timer&&$interval.cancel(timer)}function getStockInfo(){StockService.getStockInfo(stockCodes.join(",")).then(function(res){dataIsLoaded=!0;var infoData=res.data;100==infoData.code?processStockInfoData(infoData.data):X.tip(infoData.resultMsg),X.loading.hide()})["catch"](function(){dataIsLoaded=!0,X.tip("服务器请求异常")})}function processStockInfoData(data){$scope.dataLoaded=!0,$scope.mineList=[],$scope.defaultList=[];var dataList=[];$.each(stockCodes,function(i,item){var obj=data[item],stockObj={};if(obj){stockObj.stockCode=obj.stockLabel,stockObj.stockName=obj.stockName,stockObj.stockClass=obj.stockLabel.substr(0,2);var lastClosePrice=obj.lastClosePrice,price=obj.newPrice,diff=price-lastClosePrice,rote=diff/lastClosePrice*100;stockObj.closePrice=lastClosePrice.toFixed(2),stockObj.price=price.toFixed(2),stockObj.rote=rote.toFixed(2),stockObj.diff=diff.toFixed(2),dataList.push(stockObj)}}),$scope.mineList=dataList.splice(3),$scope.defaultList=dataList}var timer,MINELIST="MINELIST",STOCKCODE="STOCKCODE",storage=window.localStorage,mineListStr=storage.getItem(MINELIST)||"",stockCodes=[],isInQuoteTime=!1,isHoliday=!0,dataIsLoaded=!0;$scope.mineList=[],$scope.defaultList=[],$scope.dataLoaded=!1,X.loading.show(),$q.all({tradeInit:TradeService.getInitTrade()}).then(function(res){var tradeInitData=res.tradeInit.data;if(100==tradeInitData.code){var initData=tradeInitData.data;isHoliday=initData.isHoliday,SystemService.setCurrentTime(initData.nowTime),process()}else X.tip(tradeInitData.resultMsg)})["catch"](function(){X.tip("服务器请求异常")}),$scope.sureStock=function(stockCode){storage.setItem(STOCKCODE,stockCode),$location.url("/trade?backURL=/mine")},$scope.$on("$destroy",function(){clearTimer()})}),myControllers.controller("MineSearchCtrl",function($q,$scope,$location,dateFilter,StockService,SystemService,TradeService){function initStock(){if(stockListString){stockListObj=JSON.parse(stockListString);var lastTime=X.toInt(stockListObj.version);serverTime>=timeFlag&&lastTime<timeFlag||serverTime<timeFlag&&timeFlag-lastTime>864e5?getAllStockList():stockList=parseStockListStr(stockListObj.stocks)}else getAllStockList();initHistory()}function init(){getRiskStock(),processMineList()}function processMineList(){var mineListStr=storage.getItem(MINELIST)||"";mineListStr&&(mineList=mineListStr.split(";"))}function getRiskStock(){X.loading.show(),TradeService.getRiskStock().then(function(res){100==res.data.code?(riskStocks=res.data.data,initStock()):X.tip(res.data.resultMsg),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")})}function checkRiskStock(stockCode){for(var i=0;i<riskStocks.length;i++){var item=riskStocks[i];if(stockCode==item.stockCode)return!0}return!1}function initHistory(){if(""!=history){var historyList=history.split(";"),stockHistoryList=[];$.each(historyList,function(i,item){if(item){isRiskStock=!1;var itemArr=item.split(","),obj={code:itemArr[0],name:itemArr[1],pinyin:itemArr[2],isRisk:checkRiskStock(itemArr[0]),type:confirmType(itemArr[0])};stockHistoryList.push(obj)}}),$scope.stockHistoryList=stockHistoryList}}function confirmType(stockCode){if(!mineList.length)return"add";var i,mineItem;for(i=0;i<mineList.length;i++)if(mineItem=mineList[i],mineItem.indexOf(stockCode)!=-1)return"delete";return"add"}function addHistory(stockCode,stockName,pinyin){var currStock=stockCode+","+stockName+","+pinyin;if(""==history)storage.setItem(STOCKHISTORY,currStock);else{for(var findStock,historyList=history.split(";"),i=0;i<historyList.length;i++){var item=historyList[i];item==currStock&&(findStock=historyList.splice(i,1),i--)}findStock?historyList.unshift(findStock):historyList.unshift(currStock),historyList.length>20&&historyList.splice(20),storage.setItem(STOCKHISTORY,historyList.join(";"))}}function parseStockListStr(stockListString){var arr,itemArr,result=[];return stockListString&&(arr=stockListString.split(";"),$.each(arr,function(i,item){if(item){isRiskStock=!1,itemArr=item.split(",");var obj={code:itemArr[0],name:itemArr[1],pinyin:itemArr[2],isRisk:checkRiskStock(itemArr[0])};result.push(obj)}})),result}function getAllStockList(){X.loading.show(),StockService.getAllStockList().then(function(res){var stockData=res.data;return stockData?(100==stockData.code?(stockListObj=stockData.data,stockList=parseStockListStr(stockListObj.stocks),storage.setItem(STOCKLIST,JSON.stringify(stockListObj))):X.tip(stockData.returnMsg),void X.loading.hide()):void X.tip("服务器请求异常")})["catch"](function(){X.tip("服务器请求异常")})}function search(v){var prop="";/^[\d]*$/g.test(v)?prop="code":/^[a-zA-Z]*$/g.test(v)?(prop="pinyin",v=v.toUpperCase()):prop="name",process(v,prop)}function process(val,prop){if($scope.stockList=[],""!=val&&""!=prop){var i,len=10;for(i=0;i<stockList.length&&!($scope.stockList.length>=len);i++){var stock=stockList[i];stock[prop].indexOf(val)!=-1&&(stock.type=confirmType(stock.code),$scope.stockList.push(stock))}}}var stockListObj,stockList,storage=window.localStorage,STOCKLIST="STOCKLIST",STOCKCODE="STOCKCODE",STOCKHISTORY="STOCKHISTORY",MINELIST="MINELIST",mineList=[],riskStocks=[],isRiskStock=!1,serverTime=SystemService.getCurrentTime(),today=dateFilter(serverTime||Date.now(),"yyyy-MM-dd"),timeFlag=new Date(today+" 09:20:00").getTime(),stockListString=storage.getItem(STOCKLIST)||"",history=storage.getItem(STOCKHISTORY)||"";$scope.goURL=$location.search().goURL||"/mine",$scope.stockList=[],$scope.stockCode="",$scope.stockHistoryList=[],$scope.searchStock=function(){search($scope.stockCode)},$scope.addOrDelMine=function(stockList,index){var stock=stockList[index],stockCode=stock.code,stockName=stock.name,maxLen=20;if(0==mineList.length||mineList.indexOf(stockCode+","+stockName)==-1){if(mineList.length>=maxLen)return void X.dialog.alert("自选最多添加"+maxLen+"条记录");mineList.push(stockCode+","+stockName),storage.setItem(MINELIST,mineList.join(";")),stock.type="delete",X.tip("已添加")}else{for(var i=0;i<mineList.length;i++)mineList[i].indexOf(stockCode)!=-1&&mineList.splice(i,1);storage.setItem(MINELIST,mineList.join(";")),stock.type="add",X.tip("已删除")}},$scope.sureStock=function(stockCode,stockName,pinyin){addHistory(stockCode,stockName,pinyin),storage.setItem(STOCKCODE,stockCode),"/TDTrade"==$scope.goURL?$location.url("/TDTrade"):"/oneYuanTrade"==$scope.goURL?$location.url("/oneYuanTrade"):"/simulateTrade"==$scope.goURL?$location.url("/simulateTrade"):$location.url("/trade")},$scope.clear=function(){$scope.stockCode="",$scope.stockList=[]},$scope.clearHistory=function(){X.dialog.confirm("确认要清空历史记录么？",{notify:function(nt){1==nt&&(storage.removeItem(STOCKHISTORY),history="",$scope.$apply(function(){$scope.stockHistoryList=[]}))}})},$scope.back=function(){$location.url($scope.goURL)},init()}),myControllers.controller("MineModifyCtrl",function($scope){function process(){var mineListStr=storage.getItem(MINELIST)||"";if(""!=mineListStr){$scope.mineList=[],$scope.deleteArr=[];var mineArr=mineListStr.split(";");$.each(mineArr,function(i,item){var itemArr=item.split(",");$scope.mineList.push({stockCode:itemArr[0],stockName:itemArr[1]}),$scope.deleteArr.push("uncheck")})}}function save(){for(var arr=[],i=0;i<$scope.mineList.length;i++){var item=$scope.mineList[i];item&&arr.push(item.stockCode+","+item.stockName)}storage.setItem(MINELIST,arr.join(";"))}var MINELIST="MINELIST",storage=window.localStorage;$scope.deleteArr=[],$scope.mineList=[],$scope["delete"]=function(){var hasChecked=!1,tempDeleteArr=[],tempMineList=[];for(var i in $scope.deleteArr)if("check"==$scope.deleteArr[i]){hasChecked=!0;break}return hasChecked?void X.dialog.confirm("确定要删除吗？",{notify:function(nt){if(1==nt){for(var i in $scope.deleteArr)"uncheck"==$scope.deleteArr[i]&&(tempDeleteArr.push("uncheck"),tempMineList.push($scope.mineList[i]));$scope.$apply(function(){$scope.deleteArr=tempDeleteArr,$scope.mineList=tempMineList,save()})}}}):void X.tip("请至少选择一条记录")},$scope.up=function(index){if(index=index||0,!($scope.mineList.length<1||0==index||index>$scope.mineList.length-1)){var temp=$scope.mineList.splice(index,1)[0];$scope.mineList.unshift(temp),save()}},$scope.check=function(index){$scope.deleteArr[index]="uncheck"==$scope.deleteArr[index]?"check":"uncheck"},process()}),myControllers.controller("FundCtrl",function($scope,$q,$location,PayService){function cancel(id){X.loading.show(),PayService.cancelWithdraw(id).then(function(res){var data=res.data;if(100==data.code){var withDraw=$scope.fundTypeList.withdraw;$scope.getFundDetailList(withDraw.value,withDraw.explain)}else X.tip(data.resultMsg);X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")})}var pageSize=10;$scope.currType=$location.search().type||"all",$scope.currFund=0,$scope.currPage=1,$scope.totalPage=1,$scope.fundTypeList={all:{value:"chargeWithdraw",text:"全部",explain:"all"},charge:{value:"chargeWithdraw",text:"充值",explain:"income"},withdraw:{value:"chargeWithdraw",text:"提现",explain:"outcome"},income:{value:"loan",text:"收入",explain:"income"},outcome:{value:"loan",text:"支出",explain:"outcome"}},$scope.fundList=[],$scope.getFundDetailList=function(action,explain,page){var isNotTypeChanged=!1;action=action||"",page=page||1,action==$scope.fundTypeList[$scope.currType].value&&explain==$scope.fundTypeList[$scope.currType].explain&&(isNotTypeChanged=!0),X.loading.show(),"all"==explain?PayService.getFundAll(action,page,pageSize).then(function(res){var data=res.data;if(100==data.code){var list=data.data.items;$scope.currPage=data.data.pageIndex,$scope.totalPage=data.data.totalPage,isNotTypeChanged&&1!=page?$scope.fundList=$scope.fundList.concat(list):$scope.fundList=list}else X.tip(data.resultMsg);X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")}):PayService.getFundDetail(action,explain,page,pageSize).then(function(res){var data=res.data;if(100==data.code){var list=data.data.items;$scope.currPage=data.data.pageIndex,$scope.totalPage=data.data.totalPage,isNotTypeChanged&&1!=page?$scope.fundList=$scope.fundList.concat(list):$scope.fundList=list}else X.tip(data.resultMsg);X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")})},$scope.confirmFundType=function(currType,page){page=page||1;var type=$scope.fundTypeList[currType].value,explain=$scope.fundTypeList[currType].explain;$scope.currType=currType,$scope.showTypeDialog=!1,$scope.getFundDetailList(type,explain,page)},$scope.showCurrFundDetail=function(fundId){$scope.currFund==fundId?$scope.currFund=0:$scope.currFund=fundId},$scope.cancelWithdraw=function(fundId){X.dialog.confirm("取消提现后金额自动退还到账户余额",{notify:function(nt){1==nt&&cancel(fundId)}})},$scope.confirmFundType($scope.currType,$scope.currPage)}),myControllers.controller("PayTypeCtrl",function($scope,$q,$location){$scope.goURL=$location.search().goURL||"/myHome"}),myControllers.controller("PayBankCtrl",function($scope,$interval,$q,$location,UserService,PayService){function timerFnc(){timer=$interval(function(){""==$scope.money||$scope.money<100?$scope.btnState="disable":$scope.btnState="orange"},100)}function pay(payURL){payForm.setAttribute("action",payURL),payForm.submit()}function toIdenty(){X.dialog.confirm("您还未实名认证，请先实名认证",{notify:function(nt){1==nt&&$scope.$apply(function(){$location.url("/identification?goURL=/payBank")}),0==nt&&$scope.$apply(function(){$location.url("/payType")})}})}var payForm=document.getElementById("payForm");$scope.balance=0,$scope.userInfo={},$scope.money="";var timer=null;$scope.btnState="disable",$scope.$on("$destroy",function(){timer&&$interval.cancel(timer)}),timerFnc(),X.loading.show(),$q.all({userInfo:UserService.getUserInfo(),balance:UserService.getBalance()}).then(function(res){var userInfoData=res.userInfo.data,balanceData=res.balance.data;100==userInfoData.code&&100==balanceData.code?($scope.balance=balanceData.data.balance,$scope.userInfo=userInfoData.data,$scope.userInfo.named?$scope.userInfo.maskName=X.maskName($scope.userInfo.name):toIdenty()):100!=userInfoData.code?X.tip(userInfoData.resultMsg):100!=balanceData.code&&X.tip(balanceData.resultMsg),payForm.removeAttribute("action"),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")}),$scope.pay=function(){if(!$scope.userInfo.named)return void toIdenty();if(""!=$scope.money){if(!X.isMoney($scope.money,!0))return void X.tip("充值金额输入错误");if($scope.money<100)return void X.tip("最低100元起充");if($scope.money>5e3)return void X.tip("单次充值最高5000元");X.loading.show(),PayService.payGateway($scope.money).then(function(res){var data=res.data;100==data.code?pay(data.data):(X.tip(data.resultMsg),X.loading.hide())})["catch"](function(){X.tip("服务器请求异常")})}}}),myControllers.controller("PayMobileCtrl",function($scope,$q,UserService,PasswordService){}),myControllers.controller("PaySuccessCtrl",function($scope,$location){var code=$location.search().code||505,money=$location.search().money||0;$scope.code=code,100==code&&0!=money&&zhuge.track("充值",{"充值金额":money})}),myControllers.controller("WithdrawCtrl",function($scope,$interval,$q,$location,UserService,PayService){function initDefaultBankCard(){if(!$scope.bankCardList.length)return void($scope.selectBankCard=null);$scope.selectBankCard=$scope.bankCardList[0];var i,bank;for(i=0;i<$scope.bankCardList.length;i++)if(bank=$scope.bankCardList[i],0==bank.defaultCard){$scope.selectBankCard=bank;break}}function initValidate(){return $scope.user.named?0==$scope.balance.balance?void X.dialog.alert("您的账户没有可提金额",{notify:function(){bootTurn("/myHome")}}):$scope.bankCardList.length?""==$scope.user.withdrawPw?void X.dialog.confirm("您还未设置提现密码",{notify:function(nt){1==nt&&bootTurn("/tradePassSet?goURL=/withdraw"),0==nt&&bootTurn("/myHome")}}):void(null!=$scope.selectBankCard&&"*"!=$scope.selectBankCard.province&&"*"!=$scope.selectBankCard.city&&"*"!=$scope.selectBankCard.subbranch||X.dialog.confirm("所选提款银行卡信息不完善<br>请先完善该银行卡信息",{notify:function(nt){1==nt&&bootTurn("/bankInfo?goURL=/withdraw"),0==nt&&bootTurn("/myHome")}})):void X.dialog.confirm("提款前请先添加提款银行卡",{notify:function(nt){1==nt&&bootTurn("/addBankCard?goURL=/withdraw"),0==nt&&bootTurn("/myHome")}}):void X.dialog.confirm("您还未实名认证，请先实名认证",{notify:function(nt){1==nt&&bootTurn("/identification?goURL=/withdraw"),0==nt&&bootTurn("/myHome")}})}function bootTurn(url){$scope.$apply(function(){$location.url(url)})}function timerFnc(){timer=$interval(function(){""!=$scope.money&&""!=$scope.password?$scope.btnState="orange":$scope.btnState="disable"},100)}$scope.money="",$scope.cardId="",$scope.password="",$scope.bankCardList=[],$scope.selectBankCard=null,$scope.balance=0,$scope.delaybalance=0,$scope.user={},$scope.userName="",$scope.showDialog=!1;var timer=null;$scope.btnState="disable",X.loading.show(),$q.all({balance:UserService.getBalance(),delaybalance:UserService.getDelayBalance(),bankCards:UserService.getBankCards(),userInfo:UserService.getUserInfo()}).then(function(res){var balanceData=res.balance.data,delaybalanceData=res.delaybalance.data,bankCardData=res.bankCards.data,userInfoData=res.userInfo.data;100==balanceData.code&&100==bankCardData.code&&100==userInfoData.code&&100==delaybalanceData.code?($scope.bankCardList=bankCardData.data,$scope.balance=X.parse2(balanceData.data.balance),$scope.delaybalance=delaybalanceData.data.toFixed(2),$scope.canWithDraw=X.parse2($scope.balance-$scope.delaybalance),$scope.user=userInfoData.data,initDefaultBankCard(),initValidate()):100!=balanceData.code?X.tip(balanceData.resultMsg):100!=delaybalanceData.code?X.tip(delaybalanceData.resultMsg):100!=bankCardData.code?X.tip(bankCardData.resultMsg):100!=userInfoData.code&&X.tip(userInfoData.resultMsg),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")}),$scope.tips=function(title,msg){X.dialog.info(title,msg)},$scope.sureChoose=function(index){$scope.selectBankCard=$scope.bankCardList[index],$scope.showDialog=!1},$scope.checkMoney=function(){return""==$scope.money?(X.tip("请输入提现金额"),!1):X.isMoney($scope.money)?$scope.money<100?(X.tip("提现金额最低100元起提"),!1):$scope.money>$scope.canWithDraw?(X.tip("提现金额超出可提现余额"),!1):""==$scope.password?(X.tip("提现密码不为空！"),!1):/^\d{6}$/.test($scope.password)?null==$scope.selectBankCard?(X.tip("未找到您的提现银行卡信息"),!1):(X.loading.show(),void PayService.doWithdraw($scope.selectBankCard.id,$scope.money,$scope.password).then(function(res){var data=res.data;100==data.code?(X.tip("提现发起成功，等待处理中"),$location.url("/fund?type=withdraw")):X.tip(data.resultMsg),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")})):(X.tip("提现密码为6位数字"),!1):(X.tip("金额输入错误"),!1)},$scope.$on("$destroy",function(){timer&&$interval.cancel(timer)}),timerFnc()}),myControllers.controller("AddBankCardCtrl",function($scope,$interval,$q,$location,UserService,PayService,SystemService){function timerFnc(){timer=$interval(function(){"请选择开户支行"!=$scope.branch&&"请选择市"!=$scope.city&&"请选择省"!=$scope.province&&"请选择银行"!=$scope.bankName&&""!=$scope.bankName&&""!=$scope.province&&""!=$scope.city&&""!=$scope.branch&&""!=$scope.bankCard&&""!=$scope.sureBankCard?$scope.btnState="orange":$scope.btnState="disable"},100)}function initValidate(){$scope.user.named||X.dialog.confirm("您还未实名认证，请先实名认证",{notify:function(nt){1==nt&&bootTurnURL("/identification?goURL=/bankCardList"),0==nt&&bootTurnURL("/myInfo")}})}function bootTurnURL(url){$scope.$apply(function(){$location.url(url)})}function parseBankList(bankList){bankList&&bankList.length&&bankList.forEach(function(item){$scope.bankList[item.code]=item})}var province=SystemService.getProvince(),cities=SystemService.getCities();$scope.goURL=$location.search().goURL||"/bankCardList",$scope.bankList={},$scope.user={},$scope.showBankList=!1,$scope.userName="",$scope.bankCode="",$scope.bankName="请选择银行",$scope.showDialog=!1,$scope.list=[],$scope.provinceId="",$scope.province="请选择省",$scope.city="请选择市",$scope.branch="请选择开户支行",$scope.bankCard="",$scope.sureBankCard="",X.loading.show(),$q.all({bankList:UserService.getBankInfo(),userInfo:UserService.getUserInfo()}).then(function(res){var bankListData=res.bankList.data,userData=res.userInfo.data;100==bankListData.code&&100==userData.code?($scope.user=userData.data,$scope.userName=X.maskName($scope.user.name),parseBankList(bankListData.data),initValidate()):100!=bankListData.code?X.tip(bankListData.resultMsg):100!=userData.code&&X.tip(userData.resultMsg),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")}),$scope.sureChooseBank=function(bankCode){$scope.showBankList=!1,$scope.bankCode=bankCode,$scope.bankName=$scope.bankList[bankCode].bankName,$scope.provinceId="",$scope.province="请选择省",$scope.city="请选择市",$scope.branch="请选择开户支行"},$scope.chooseProvice=function(){if($scope.title="开户省份",$scope.list=[],""==$scope.bankName||"请选择银行"==$scope.bankName)return void X.tip("请选择银行");var i,len=province.length;for(i=0;i<len;i++)$scope.list.push(province[i]);$scope.showDialog=!0},$scope.chooseCity=function(){if($scope.title="开户城市",$scope.list=[],""==$scope.bankName||"请选择银行"==$scope.bankName)return void X.tip("请选择银行");if(""==$scope.province||"请选择省"==$scope.province||""==$scope.provinceId)return void X.tip("请选择开户省份");var i,city,len=cities.length;for(i=0;i<len;i++)city=cities[i],city[0]==$scope.provinceId&&$scope.list.push([city[1],city[2]]);$scope.showDialog=!0},$scope.chooseBranch=function(){return $scope.title="开户支行",$scope.list=[],""==$scope.bankName||"请选择银行"==$scope.bankName?void X.tip("请选择银行"):""==$scope.province||"请选择省"==$scope.province?void X.tip("请选择开户省份"):""==$scope.city||"请选择市"==$scope.city?void X.tip("请选择开户城市"):($scope.showDialog=!0,X.loading.show(),void UserService.getSubBank($scope.bankName,$scope.province,$scope.city).then(function(res){var data=res.data;if(100==data.code){var i,banks=data.data,len=banks.length;for(i=0;i<len;i++)$scope.list.push([0,banks[i]]);$scope.showDialog=!0}else X.tip(data.resultMsg);X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")}))},$scope.sureChoose=function(title,id,name){switch(title){case"开户省份":$scope.province=name,$scope.provinceId=id,$scope.city="请选择市",$scope.branch="请选择开户支行";break;case"开户城市":$scope.city=name,$scope.branch="请选择开户支行";break;case"开户支行":$scope.branch=name}$scope.showDialog=!1},$scope.save=function(){if(""!=$scope.bankName&&"请选择银行"!=$scope.bankName&&""!=$scope.province&&"请选择省"!=$scope.province&&""!=$scope.city&&"请选择市"!=$scope.city&&""!=$scope.branch&&"请选择开户支行"!=$scope.branch&&""!=$scope.bankCard){if(!X.isBankCard($scope.bankCard))return void X.tip("请输入正确的银行卡号");if(""==$scope.sureBankCard)return void X.tip("请输入确认卡号");if($scope.bankCard!=$scope.sureBankCard)return void X.tip("确认卡号与银行卡号不一致");X.loading.show(),UserService.bindBankCard($scope.bankName,$scope.province,$scope.city,$scope.branch,$scope.bankCard).then(function(res){var data=res.data;100==data.code?(X.tip("银行卡添加成功"),$location.url($scope.goURL)):X.tip(data.resultMsg),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")})}};var timer=null;$scope.btnState="disable",$scope.$on("$destroy",function(){timer&&$interval.cancel(timer)}),timerFnc()}),myControllers.controller("ModifyBankCardCtrl",function($scope,$q,$routeParams,$location,UserService,SystemService){function delBankCard(){X.loading.show(),UserService.delBankCard(bankCardId).then(function(res){var data=res.data;100==data.code?(X.tip("银行卡删除成功"),$location.url("/bankCardList")):X.tip(data.resultMsg),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")})}function toIdenty(){X.dialog.confirm("您还未实名认证，请先实名认证",{notify:function(nt){1==nt&&bootTurnURL("/identification?goURL=/myInfo"),0==nt&&bootTurnURL("/myInfo")}})}function initData(){var i,len=province.length;for(i=0;i<len;i++)if($scope.bankCard.province==province[i][1]){$scope.provinceId=province[i][0];break}$scope.province=$scope.bankCard.province,$scope.city=$scope.bankCard.city,$scope.branch=$scope.bankCard.subbranch}function bootTurnURL(url){$scope.$apply(function(){$location.url(url)})}var bankCardId=$routeParams.bankCardId,province=SystemService.getProvince(),cities=SystemService.getCities(),cardIndex=$location.search().cardIndex;$scope.cardColor="card-list-bg"+cardIndex,$scope.goURL=$location.search().goURL||"/bankCardList",$scope.bankCard=null,$scope.user={},$scope.showDialog=!1,$scope.list=[],
$scope.provinceId="",$scope.province="请选择省",$scope.city="请选择市",$scope.branch="请选择开户支行",$scope.sureBankCard="",X.loading.show(),$q.all({bankCard:UserService.getBankCardById(bankCardId),userInfo:UserService.getUserInfo()}).then(function(res){var bankCardData=res.bankCard.data,userData=res.userInfo.data;100==bankCardData.code&&100==userData.code?($scope.user=userData.data,$scope.bankCard=bankCardData.data,""==$scope.user.name?toIdenty():initData()):X.tip(bankCardData.resultMsg),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")}),$scope.chooseProvice=function(){$scope.title="开户省份",$scope.list=[];var i,len=province.length;for(i=0;i<len;i++)$scope.list.push(province[i]);$scope.showDialog=!0},$scope.chooseCity=function(){if($scope.title="开户城市",$scope.list=[],""==$scope.province||"请选择省"==$scope.province||""==$scope.provinceId)return void X.tip("请选择开户省份");var i,city,len=cities.length;for(i=0;i<len;i++)city=cities[i],city[0]==$scope.provinceId&&$scope.list.push([city[1],city[2]]);$scope.showDialog=!0},$scope.chooseBranch=function(){return $scope.title="开户支行",$scope.list=[],""==$scope.province||"请选择省"==$scope.province?void X.tip("请选择开户省份"):""==$scope.city||"请选择市"==$scope.city?void X.tip("请选择开户城市"):($scope.showDialog=!0,X.loading.show(),void UserService.getSubBank($scope.bankCard.bank,$scope.province,$scope.city).then(function(res){var data=res.data;if(100==data.code){var i,banks=data.data,len=banks.length;for(i=0;i<len;i++)$scope.list.push([0,banks[i]]);$scope.showDialog=!0}else X.tip(data.resultMsg);X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")}))},$scope.sureChoose=function(title,id,name){switch(title){case"开户省份":$scope.province=name,$scope.provinceId=id,$scope.city="请选择市",$scope.branch="请选择开户支行";break;case"开户城市":$scope.city=name,$scope.branch="请选择开户支行";break;case"开户支行":$scope.branch=name}$scope.showDialog=!1},$scope.save=function(){return""==$scope.province||"请选择省"==$scope.province?void X.tip("请选择开户省份"):""==$scope.city||"请选择市"==$scope.city?void X.tip("请选择开户城市"):""==$scope.branch||"请选择开户支行"==$scope.branch?void X.tip("请选择开户支行"):(X.loading.show(),void UserService.updateCardInfo($scope.bankCard.id,$scope.bankCard.bank,$scope.province,$scope.city,$scope.branch).then(function(res){var data=res.data;100==data.code?(X.tip("银行卡信息保存成功"),$location.url($scope.goURL)):X.tip(data.resultMsg),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")}))},$scope.setDefaultBankCard=function(){X.loading.show(),UserService.setDefaultBankCard(bankCardId).then(function(res){var data=res.data;100==data.code?(X.tip("默认卡设置成功"),$location.url("/bankCardList")):X.tip(data.resultMsg),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")})},$scope.deleteBankCard=function(){X.dialog.confirm("您确定要删除该银行卡吗？",{notify:function(nt){1==nt&&delBankCard()}})}}),myControllers.controller("BankCardListCtrl",function($scope,$q,$location,UserService){function initValidate(){$scope.user.named||X.dialog.confirm("您还未实名认证，请先实名认证",{notify:function(nt){1==nt&&bootTurnURL("/identification?goURL=/bankCardList"),0==nt&&bootTurnURL("/myInfo")}})}function bootTurnURL(url){$scope.$apply(function(){$location.url(url)})}$scope.bankCards=[],$scope.user={},X.loading.show(),$q.all({bankCards:UserService.getBankCards(),userInfo:UserService.getUserInfo()}).then(function(res){var bankCardData=res.bankCards.data,userData=res.userInfo.data;100==bankCardData.code&&100==userData.code?($scope.user=userData.data,$scope.bankCards=bankCardData.data,initValidate()):X.tip(bankCardData.resultMsg),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")})}),myControllers.controller("BankInfoCtrl",function($scope,$q,$location,UserService,SystemService){function initValidate(){return $scope.user.named?($scope.user.maskName=X.maskName($scope.user.name),null==$scope.bank?void X.dialog.alert("未找到您的银行卡信息",{notify:function(){bootTurnURL("/myHome")}}):($scope.province="*"==$scope.bank.province?"未设置":$scope.bank.province,$scope.city="*"==$scope.bank.city?"未设置":$scope.bank.city,void($scope.branch="*"==$scope.bank.subbranch?"未设置":$scope.bank.subbranch))):void X.dialog.confirm("您还未实名认证，请先实名认证",{notify:function(nt){1==nt&&bootTurnURL("/identification?goURL=/bankInfo"),0==nt&&bootTurnURL("/myInfo")}})}function bootTurnURL(url){$scope.$apply(function(){$location.url(url)})}$scope.goURL=$location.search().goURL||"/myInfo",$scope.bank={},$scope.user={},$scope.userName="",$scope.provinceId="",$scope.province="未设置",$scope.city="未设置",$scope.branch="未设置",$scope.showDialog=!1;var province=SystemService.getProvince(),cities=SystemService.getCities();X.loading.show(),$q.all({bankCardInfo:UserService.getBankCardInfo(),userInfo:UserService.getUserInfo()}).then(function(res){var bankCardData=res.bankCardInfo.data,userData=res.userInfo.data;100==bankCardData.code&&100==userData.code?($scope.user=userData.data,$scope.bank=bankCardData.data,initValidate()):X.tip(bankCardData.resultMsg),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")}),$scope.closeDialog=function(){$scope.showDialog=!1},$scope.chooseProvice=function(){$scope.title="开户省份",$scope.list=[];var i,len=province.length;for(i=0;i<len;i++)$scope.list.push(province[i]);$scope.showDialog=!0},$scope.chooseCity=function(){if($scope.title="开户城市",$scope.list=[],""==$scope.province||"未设置"==$scope.province||""==$scope.provinceId)return void X.tip("请选择开户省份");var i,city,len=cities.length;for(i=0;i<len;i++)city=cities[i],city[0]==$scope.provinceId&&$scope.list.push([city[1],city[2]]);$scope.showDialog=!0},$scope.chooseBranch=function(){return $scope.title="开户支行",$scope.list=[],""==$scope.province||"未设置"==$scope.province?void X.tip("请选择开户省份"):""==$scope.city||"未设置"==$scope.city?void X.tip("请选择开户城市"):($scope.showDialog=!0,X.loading.show(),void UserService.getSubBank($scope.bank.bank,$scope.province,$scope.city).then(function(res){var data=res.data;if(100==data.code){var i,banks=data.data,len=banks.length;for(i=0;i<len;i++)$scope.list.push([0,banks[i]]);$scope.showDialog=!0}else X.tip(data.resultMsg);X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")}))},$scope.sureChoose=function(title,id,name){switch(title){case"开户省份":$scope.province=name,$scope.provinceId=id,$scope.city="未设置",$scope.branch="未设置";break;case"开户城市":$scope.city=name,$scope.branch="未设置";break;case"开户支行":$scope.branch=name}$scope.showDialog=!1},$scope.save=function(){return""==$scope.province||"未设置"==$scope.province?void X.tip("请选择开户省份"):""==$scope.city||"未设置"==$scope.city?void X.tip("请选择开户城市"):""==$scope.branch||"未设置"==$scope.branch?void X.tip("请选择开户支行"):(X.loading.show(),void UserService.updateCardInfo($scope.bank.bank,$scope.province,$scope.city,$scope.branch,$scope.bank.id).then(function(res){var data=res.data;100==data.code?(X.tip("信息保存成功"),$location.url($scope.goURL)):X.tip(data.resultMsg),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")}))}}),myControllers.controller("AlipayCtrl",function($scope,$interval,$q,$location,UserService,PayService,SystemService){function toIdenty(){X.dialog.confirm("您还未实名认证，请先实名认证",{notify:function(nt){1==nt&&$scope.$apply(function(){$location.url("/identification?goURL=/alipay")}),0==nt&&$scope.$apply(function(){window.history.go(-1)})}})}$scope.account="",$scope.money="",$scope.balance=0,$scope.user={},$scope.name="",$scope.param={},$scope.cellPhone="";var timer=null;$scope.btnState="disable",$scope.$on("$destroy",function(){timer&&$interval.cancel(timer)}),X.loading.show(),$q.all({balance:UserService.getBalance(),userInfo:UserService.getUserInfo()}).then(function(res){var balance=res.balance.data,userData=res.userInfo.data;X.clipboard.init("copy-tel"),100==balance.code&&100==userData.code?($scope.balance=balance.data,$scope.user=userData.data,$scope.param.account=userData.data.alipayAccount,$scope.cellPhone=SystemService.cellPhoneNumber(),X.log($scope.cellPhone),""==$scope.user.name?toIdenty():$scope.name=X.maskName($scope.user.name)):100!=balance.code?X.tip(balance.resultMsg):100!=userData.code&&X.tip(userData.resultMsg),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")}),$scope.edit=function(){X.dialog.alert('如需要更换或解绑支付宝账号，请 <br>联系客服电话 <a class="txt-blue" href='+$scope.cellPhone.cellPhoneATag+">"+$scope.cellPhone.cellPhone+"</a>")},$scope.pay=function(){var account=$scope.param.account?$scope.param.account:$scope.user.alipayAccount;if(account&&$scope.param.money){if(account.length<5)return void X.tip("支付宝账号输入错误");if(!X.isMoney($scope.param.money,!0))return void X.tip("充值金额输入错误");if($scope.param.money<1)return void X.tip("充值金额最低1元");if($scope.param.money>1e5)return void X.tip("充值金额最高10万元");X.loading.show(),PayService.alipay($scope.param.money,$scope.param.account).then(function(res){var data=res.data;100==data.code?window.location.href="/app/goAli.html":X.tip(data.resultMsg),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")})}}}),myControllers.controller("AlipayDetailCtrl",function(){X.clipboard.init()}),myControllers.controller("GuideCtrl",function($scope,$location){$scope.showHeader=!0;var source=$location.search().source;source&&"IOSAPP"==source&&($scope.showHeader=!1)}),myControllers.controller("ArticleCtrl",function($scope,$location){$scope.showHeader=!0;var source=$location.search().source;source&&"IOSAPP"==source&&($scope.showHeader=!1);var btnLink=$location.search().btnLink,btnText=$location.search().btnText;btnText&&btnLink&&($scope.btnLink=decodeURIComponent(btnLink),$scope.btnText=decodeURIComponent(btnText)),$scope.to=function(){window.location.href=$scope.btnLink}}),myControllers.controller("TradeRuleCtrl",function($scope,$location){$scope.showHeader=!0;var source=$location.search().source;source&&"IOSAPP"==source&&($scope.showHeader=!1)}),myControllers.controller("SafeCtrl",function($scope,$location){$scope.showHeader=!0;var source=$location.search().source;source&&"IOSAPP"==source&&($scope.showHeader=!1)}),myControllers.controller("AboutUsCtrl",function($scope,$location){$scope.showHeader=!0;var source=$location.search().source;source&&"IOSAPP"==source&&($scope.showHeader=!1)}),myControllers.controller("IntroduceCtrl",function($scope,$location){$scope.showHeader=!0;var source=$location.search().source;source&&"IOSAPP"==source&&($scope.showHeader=!1),$scope.toTrade=function(){$scope.showHeader?$location.path("/trade"):window.location.href="yztz://ycl.yztz.com/trade"}}),myControllers.controller("TDApplyCtrl",function($scope,$q,$location,TradeService,UserService){function init(data){var tradingMoneyList=data.tradingMoneyList.value,deferCharge=data.deferCharge.value,leverValue=data.leverValue.value,holdDayList=data.holdDayList.value,deferConditionRatio=data.deferConditionRatio.value,maxMoneyOneStock=data.maxMoneyOneStock.value,profitShare=data.profitShare.value,quitGainRatio=data.quitGainRatio.value,quitLossRatio=data.quitLossRatio.value;initTradeMoney(tradingMoneyList),initHoldDay(holdDayList),profitShare=100*profitShare;var dealing=100-profitShare;$scope.initData={deferConditionRatio:deferConditionRatio,profitShare:profitShare,quitGainRatio:quitGainRatio,quitLossRatio:quitLossRatio,dealing:dealing,maxMoneyOneStock:X.sketchNumber(maxMoneyOneStock),deferCharge:deferCharge,leverValue:leverValue},$scope.maxMoney=tradeMoneyList[tradeMoneyList.length-1]/1e4}function getDYData(){if("money"==$scope.type){var url="/TDApplyConfirm?holdDays="+$scope.daies+"&&money="+$scope.money;$location.url(url)}else{var reg=/^[1-9]\d*$/;if(!$scope.otherMoney)return X.dialog.alert("请输入您的点买金额"),!1;if(!reg.test($scope.otherMoney))return X.dialog.alert("请输入正确的点买金额"),!1;if($scope.otherMoney>$scope.maxMoney||$scope.otherMoney<1)return X.dialog.alert("点买金额最少1万，最多"+$scope.maxMoney+"万"),!1;var url="/TDApplyConfirm?holdDays="+$scope.daies+"&&money="+1e4*$scope.otherMoney;$location.url(url)}}function initTradeMoney(list){list&&(tradeMoneyList=list.split(","),$.each(tradeMoneyList,function(i,m){$scope.tradeMoneyList.push({value:m,text:X.sketchNumber(m)})}))}function initHoldDay(list){list&&(holdDaysList=list.split(","),$.each(holdDaysList,function(i,m){$scope.holdDaysList.push({day:m,value:m})}))}var tradeMoneyList=[],holdDaysList=[];$scope.type="money",$scope.dayIndex=0,$scope.currentIndex=0,$scope.money=0,$scope.otherMoney="",$scope.daies=0,$scope.tradeMoneyList=[],$scope.holdDaysList=[];var DYTip=!1;X.loading.show(),$q.all({initTrade:TradeService.initTDTrade(),user:UserService.getUserInfo(),DY:TradeService.getWaitPayDeferForRemind()}).then(function(res){var initTd=res.initTrade.data,userInfo=res.user.data,DYData=res.DY.data;if(100==initTd.code&&100==userInfo.code&&100==DYData.code){var initData=initTd.data;$scope.userData=userInfo.data;var risk=JSON.parse(initData.strRisk);0!=DYData.data&&(DYTip=!0),init(risk),$scope.chooseMoney($scope.currentIndex,$scope.tradeMoneyList[$scope.currentIndex].value),$scope.chooseDay($scope.dayIndex,$scope.holdDaysList[$scope.dayIndex].value)}else 100!=initTd.code?X.tip(initTd.resultMsg):100!=userInfo.code&&X.tip(userInfo.resultMsg);X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")}),$scope.to=function(){return $scope.userData.named?DYTip?void X.dialog.confirm("温馨提示：请您确认是否已经将今日递延<br/>费留在余额中等待扣款，如果继续操作可<br/>能会造成操盘中策略因递延费不足被平仓",{sureBtn:"确定",notify:function(nt){1==nt&&$scope.$apply(function(){getDYData()})}}):void getDYData():(X.dialog.confirm("您还未实名认证，请先实名认证",{notify:function(nt){1==nt&&$scope.$apply(function(){$location.url("/identification?goURL=/TDApply")})}}),!1)},$scope.chooseMoney=function(index,money){$scope.currentIndex=index,$scope.money=money},$scope.chooseDay=function(index,day){$scope.dayIndex=index,$scope.daies=day},$scope.tips=function(title,msg){X.dialog.info(title,msg)},$scope.tipHoldDay=function(){var title="持仓时间",hold=$scope.holdDaysList,len=hold.length,msg="持仓时间为"+hold[0].day+"~"+hold[len-1].day+"个交易日，最短"+hold[0].day+"天，最长"+hold[len-1].day+"天。";X.dialog.info(title,msg)},$scope.tipProfitSharing=function(){var title="盈利分成",msg="点买人按盈利的"+$scope.initData.profitShare+"%进行分成，投资人按盈利的"+$scope.initData.dealing+"%进行分成。";X.dialog.info(title,msg)}}),myControllers.controller("TDApplyConfirmCtrl",function($scope,$location,$q,TradeService,UserService){function init(data){var risk=JSON.parse(data.strRisk),balance=data.balance,unHanldDeferCharge=data.unHanldDeferCharge,token=data.token,tradingMoneyList=risk.tradingMoneyList.value,deferCharge=risk.deferCharge.value,holdDayList=risk.holdDayList.value,leverValue=risk.leverValue.value,deferConditionRatio=risk.deferConditionRatio.value,quitGainRatio=risk.quitGainRatio.value,quitLossRatio=risk.quitLossRatio.value,principal=parseInt(money/leverValue),deferredCharge=parseInt(money/1e4*deferCharge*holdDays),totalCharge=principal+deferredCharge,tradeMoneyList=tradingMoneyList.split(",");$scope.initData={deferConditionRatio:deferConditionRatio,quitGainRatio:quitGainRatio,quitLossRatio:quitLossRatio,deferCharge:deferCharge,leverValue:leverValue,holdDays:holdDays,money:parseInt(money),principal:principal,deferredCharge:deferredCharge,totalCharge:totalCharge},$scope.token=token,$scope.balance=X.parse2(balance),$scope.unHanldDeferCharge=unHanldDeferCharge||0,$scope.unHanldDeferCharge=Math.round(100*$scope.unHanldDeferCharge)/100,$scope.needMoney=($scope.initData.totalCharge-$scope.balance).toFixed(2),$scope.maxMoney=parseInt(tradeMoneyList[tradeMoneyList.length-1]);var holdDaysList=holdDayList.split(",");if(holdDaysList.indexOf($scope.initData.holdDays)==-1)return X.dialog.confirm("参数错误，请重新发起",{notify:function(nt){1==nt&&bootURL("/TDApply"),0==nt&&bootURL("/TDTrade?backURL=/index")}}),!1}function createTDTrade(){var postData={token:$scope.token,money:$scope.initData.money,deferConditionRatio:$scope.initData.deferConditionRatio,quitGainRatio:$scope.initData.quitGainRatio,quitLossRatio:$scope.initData.quitLossRatio,principal:$scope.initData.principal,deferCharge:$scope.initData.deferredCharge,holdDays:$scope.initData.holdDays};X.loading.show(),TradeService.createTDTrade(postData).then(function(res){var data=res.data;100==data.code?(X.tip("策略组发起成功"),$location.url("/TDTrade")):501==data.code?X.tip(data.resultMsg):($scope.token=data.data.token,X.tip(data.resultMsg)),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")})}function bootURL(url){$scope.$apply(function(){$location.url(url)})}var holdDays=$location.search().holdDays,money=$location.search().money;$scope.showBalance=!1,$scope.showUnHanldDeferCharge=!1,$scope.showUnHanldBalance=!1;var reg=/^[1-9]\d*$/;return holdDays&&money&&reg.test(holdDays)&&reg.test(money)&&money%1e4==0&&!(money<1e4)?(X.loading.show(),$q.all({initTrade:TradeService.initTDTrade(),user:UserService.getUserInfo()}).then(function(res){var initTd=res.initTrade.data,userInfo=res.user.data;if(100==initTd.code&&100==userInfo.code){var initData=initTd.data;$scope.userData=userInfo.data,init(initData)}else 100!=initTd.code?X.tip(initTd.resultMsg):100!=userInfo.code&&X.tip(userInfo.resultMsg);X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")}),$scope.sub=function(){if($scope.initData.money>$scope.maxMoney)return X.dialog.alert("点买金额最少1万，最多"+$scope.maxMoney/1e4+"万"),!1;if(!$scope.userData.named)return X.dialog.confirm("您还未实名认证，请先实名认证",{notify:function(nt){1==nt&&bootURL("/identification?goURL=/TDApply")}}),!1;if(0==$scope.unHanldDeferCharge&&$scope.initData.totalCharge>$scope.balance)return $scope.showBalance=!0,!1;var unHanldBalnance=$scope.initData.totalCharge+$scope.unHanldDeferCharge;return $scope.unHanldneedMoney=X.parse2(unHanldBalnance-$scope.balance),$scope.unHanldDeferCharge>0&&unHanldBalnance>$scope.balance?($scope.showUnHanldBalance=!0,!1):$scope.unHanldDeferCharge>0&&$scope.balance>=$scope.unHanldDeferCharge?($scope.showUnHanldDeferCharge=!0,!1):void createTDTrade()},void($scope.createT=function(){createTDTrade()})):(X.dialog.confirm("参数错误，请重新发起",{notify:function(nt){1==nt&&bootURL("/TDApply"),0==nt&&bootURL("/TDTrade?backURL=/index")}}),!1)}),myControllers.controller("MyStrategyGroupCtrl",function($scope,$q,$sce,TradeService,$location,SystemService){function holding(){TradeService.getHoldingScheme().then(function(res){var holdingScheme=res.data;if(100==holdingScheme.code){var holdingData=holdingScheme.data;init(holdingData)}else X.tip(holdingScheme.resultMsg);X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")})}function query(data){var risk=JSON.parse(data.strRisk),balance=data.balance,dayList=risk.holdDayList.value,tradingMoneyList=risk.tradingMoneyList.value,tradeMoneyList=tradingMoneyList.split(",");$scope.queryData={deferConditionRatio:risk.deferConditionRatio.value,deferCharge:risk.deferCharge.value,leverValue:risk.leverValue.value},$scope.balance=balance,$scope.days=dayList.split(","),$scope.holdDays=$scope.days[0],$scope.maxMoney=tradeMoneyList[tradeMoneyList.length-1]}function init(data){if(!data)return $scope.initData={money:0,deferCharge:0,serviceCharge:0,lossPrincipal:0,marketValue:0,suspendedValue:0,availableDays:0,availableMoney:0},!1;var money=data.money,deferCharge=data.deferCharge,serviceCharge=data.serviceCharge||0,lossPrincipal=data.lossPrincipal,marketValue=data.marketValue||0,suspendedValue=data.suspendedValue||0,currentProfit=data.currentProfit||0,availableDays=data.availableDays,id=data.id,availableMoney=data.availableMoney,leverRatio=data.leverRatio;$scope.initData={id:id,money:money,deferCharge:deferCharge.toFixed(2),serviceCharge:serviceCharge.toFixed(2),lossPrincipal:lossPrincipal.toFixed(2),marketValue:marketValue.toFixed(2),suspendedValue:suspendedValue.toFixed(2),currentProfit:currentProfit.toFixed(2),availableDays:availableDays,availableMoney:availableMoney,leverRatio:leverRatio}}function getRenewalA(day,id){X.loading.show(),TradeService.extendSchemeInitiate(id,day).then(function(res){var add=res.data;100==add.code&&($scope.extend[day]=add.data),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")})}function getRenewal(days,id){if($scope.initData.availableDays<3)for(var i=0;i<days.length;i++){var day=days[i];getRenewalMoney(day,id)}}function getRenewalMoney(day,id){X.loading.show(),TradeService.extendSchemeInitiate(id,day).then(function(res){var add=res.data;100==add.code?$scope.extend[day]=add.data:X.tip(add.resultMsg),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")})}function getTips(day){$scope.diffBalance=$scope.extend[day]||0,$scope.diffBalance>0?$scope.tipsWord=$sce.trustAsHtml("续期需要履约保证金"+$scope.principalAddDay+"元，退回"+$scope.diffBalance+"元"):0==$scope.diffBalance?$scope.tipsWord=$sce.trustAsHtml(""):$scope.tipsWord=$sce.trustAsHtml("续期需要履约保证金"+$scope.principalAddDay+"元，补交"+-$scope.diffBalance+"元")}function getDeferCharge(money){TradeService.schemeAddMoneyInitiate($scope.initData.id,money).then(function(res){var addMoneyInit=res.data;100==addMoneyInit.code?($scope.addMoneyPrincipal=parseInt(money/$scope.initData.leverRatio),$scope.addMoneyDefer=parseInt(addMoneyInit.data)):($scope.addMoneyPrincipal=0,$scope.addMoneyDefer=0,X.tip(addMoneyInit.resultMsg)),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")})}$scope.showAddMoney=!1,$scope.showAddPrincipal=!1,$scope.showApplyClean=!1,$scope.showAddDay=!1,$scope.extend=[],$scope.initData={},$scope.queryData={},$scope.days=[],$scope.principal=0,$scope.deferr=0,$scope.addMoneynum=1,$scope.holdDays=0;var reg=/^[1-9]\d*$/,DYTip=!1;X.loading.show(),$q.all({initTrade:TradeService.initTDTrade(),hold:TradeService.getHoldingScheme(),DY:TradeService.getWaitPayDeferForRemind()}).then(function(res){var initTd=res.initTrade.data,holdScheme=res.hold.data,DYData=res.DY.data;if(100==initTd.code&&100==holdScheme.code&&100==DYData.code){var initData=initTd.data,holdData=holdScheme.data;init(holdData),query(initData),getRenewalA($scope.days[0],$scope.initData.id),0!=DYData.data&&(DYTip=!0)}else 100!=initTd.code?X.tip(initTd.resultMsg):900==holdScheme.code?($scope.holdData=holdScheme.data,$scope.holdCode=holdScheme.code,$scope.holdTip=holdScheme.resultMsg,init($scope.holdData)):100!=holdScheme.code&&X.tip(holdScheme.resultMsg);X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")}),$scope.loseBlur=function(data){reg.test(data)||($scope.addMon=0),0==$scope.addMon?($scope.showAddMoney=!1,X.dialog.alert("金额错误")):($scope.addMon=1e4*$scope.addMoneynum,getDeferCharge($scope.addMon))},$scope.addMoney=function(){return $scope.holdData||900!=$scope.holdCode?(reg.test($scope.addMoneynum)||($scope.addMoneynum=1),$scope.showAddMoney=!0,$scope.addMon=1e4*$scope.addMoneynum,DYTip?($scope.showAddMoney=!1,void X.dialog.confirm("温馨提示：请您确认是否已经将今日递延<br/>费留在余额中等待扣款，如果继续操作可<br/>能会造成操盘中策略因递延费不足被平仓",{sureBtn:"确定",notify:function(nt){1==nt&&($scope.showAddMoney=!0,getDeferCharge($scope.addMon))}})):(X.loading.show(),void getDeferCharge($scope.addMon))):(X.tip($scope.holdTip),!1)},$scope.addPrincipal=function(){if(!$scope.holdData&&900==$scope.holdCode)return X.tip($scope.holdTip),!1;var ratio=Number($scope.queryData.deferConditionRatio),money=Number($scope.initData.money),market=Number($scope.initData.marketValue),availableMoney=Number($scope.initData.availableMoney),addPrinc=parseInt((ratio+1)/100*money-(market+availableMoney));return addPrinc<0&&(addPrinc=0),$scope.addPrinc=addPrinc,DYTip?void X.dialog.confirm("温馨提示：请您确认是否已经将今日递延<br/>费留在余额中等待扣款，如果继续操作可<br/>能会造成操盘中策略因递延费不足被平仓",{sureBtn:"确定",notify:function(nt){1==nt&&$scope.$apply(function(){$scope.showAddPrincipal=!0})}}):void($scope.showAddPrincipal=!0)},$scope.applyClean=function(){return $scope.holdData||900!=$scope.holdCode?void($scope.showApplyClean=!0):(X.tip($scope.holdTip),!1)},$scope.addDays=function(){return $scope.holdData||900!=$scope.holdCode?$scope.initData.availableDays>=3?(X.dialog.alert("策略组到期前3天才能续期"),!1):(getRenewal($scope.days,$scope.initData.id),$scope.principalAddDay=parseInt(Math.round($scope.initData.money/$scope.queryData.leverValue*100)/100),$scope.deferAddDay=Math.floor(Math.round($scope.initData.money/1e4*$scope.queryData.deferCharge*$scope.holdDays*1e4)/100)/100,getTips($scope.holdDays),$scope.$watch("holdDays",function(){$scope.deferAddDay=Math.floor(Math.round($scope.initData.money/1e4*$scope.queryData.deferCharge*$scope.holdDays*1e4)/100)/100,getTips($scope.holdDays)}),DYTip?void X.dialog.confirm("温馨提示：请您确认是否已经将今日递延<br/>费留在余额中等待扣款，如果继续操作可<br/>能会造成操盘中策略因递延费不足被平仓",{sureBtn:"确定",notify:function(nt){1==nt&&$scope.$apply(function(){$scope.showAddDay=!0})}}):void($scope.showAddDay=!0)):(X.tip($scope.holdTip),!1)},$scope.currentPosition=function(){return $scope.holdData||900!=$scope.holdCode?void $location.url("/TDTradeSell"):(X.tip($scope.holdTip),!1)},$scope.tradeRecode=function(){return $scope.holdData||900!=$scope.holdCode?void $location.url("/TDTradeResult"):(X.tip($scope.holdTip),!1)},$scope.defineAddMoney=function(){var totalPrice=$scope.addMoneyPrincipal+$scope.addMoneyDefer,mon=Math.round($scope.initData.money),totalMoney=$scope.addMon+mon;return reg.test($scope.addMoneynum)?totalMoney>$scope.maxMoney?($scope.showAddMoney=!1,X.dialog.alert("您的点买金额已超出限制"),!1):totalPrice>$scope.balance?($scope.showAddMoney=!1,X.dialog.confirm("当前余额不足，<br>请充值后再发起追加履约保证金。",{sureBtn:"去充值",notify:function(nt){1==nt&&$scope.$apply(function(){$location.url("/payType")})}}),!1):(X.loading.show(),TradeService.addMoney($scope.initData.id,$scope.addMoneyPrincipal,$scope.addMon,$scope.addMoneyDefer).then(function(res){var addMoney=res.data;100==addMoney.code?(holding(),getRenewal($scope.days,$scope.initData.id),X.tip(addMoney.data)):X.tip(addMoney.resultMsg),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")}),void($scope.showAddMoney=!1)):($scope.showAddMoney=!1,X.dialog.alert("金额错误"),!1)},$scope.defineAddPrincipal=function(){if(!reg.test($scope.addPrinc))return X.dialog.alert("金额错误"),$scope.showAddPrincipal=!1,!1;var addPrincipalPrinc=parseInt($scope.addPrinc);return addPrincipalPrinc>$scope.balance?($scope.showAddPrincipal=!1,X.dialog.confirm("当前余额不足，<br>请充值后再发起追加履约保证金。",{sureBtn:"去充值",notify:function(nt){1==nt&&$scope.$apply(function(){$location.url("/payType")})}}),!1):(X.loading.show(),TradeService.addPrincipal($scope.initData.id,addPrincipalPrinc).then(function(res){var principal=res.data;100==principal.code?(holding(),getRenewal($scope.days,$scope.initData.id),X.tip(principal.data)):X.tip(principal.resultMsg),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")}),void($scope.showAddPrincipal=!1))},$scope.defineApplyClean=function(){X.loading.show(),TradeService.applyFinish($scope.initData.id).then(function(res){var applyFin=res.data;100==applyFin.code?(holding(),X.tip(applyFin.data)):X.tip(applyFin.resultMsg),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")}),$scope.showApplyClean=!1},$scope.defineAddDay=function(){X.loading.show(),TradeService.extendScheme($scope.initData.id,$scope.holdDays,$scope.principalAddDay,$scope.diffBalance,$scope.deferAddDay).then(function(res){var extendScheme=res.data;100==extendScheme.code?(X.tip(extendScheme.data),holding(),getRenewal($scope.days,$scope.initData.id)):X.tip(extendScheme.resultMsg),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")}),$scope.showAddDay=!1}}),myControllers.controller("historyStrategiesCtrl",function($scope,$q,$location,TradeService){function getHistorySchemes(page){X.loading.show(),TradeService.getHistorySchemes(page,pageSize).then(function(res){var historySchemes=res.data;if(100==historySchemes.code){var historyData=historySchemes.data;init(historyData)}else X.tip(historySchemes.resultMsg);X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")})}function init(data){var list=data.dataList;$scope.pageIndex=data.pageIndex,$scope.totalPage=data.totalPage,0==list.length&&($scope.showNoData=!0),1==$scope.pageIndex?$scope.historySchemeList=list:$scope.historySchemeList=$scope.historySchemeList.concat(list)}var page=1,pageSize=5;$scope.historySchemeList=[],$scope.showNoData=!1,$scope.getDetailList=function(page){page=page||1,getHistorySchemes(page)},getHistorySchemes(page)}),myControllers.controller("strategyDetailCtrl",function($scope,$q,$location,TradeService){function getStrategyByPage(page){X.loading.show(),TradeService.TDGetSettleStrategyByPage(page,pageSize,id).then(function(res){var strategyDetail=res.data;if(100==strategyDetail.code){var strategyData=strategyDetail.data;init(strategyData)}else X.tip(strategyDetail.resultMsg);X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")})}function init(data){var list=data.dataList;$scope.pageIndex=data.pageIndex,$scope.totalPage=data.totalPage,0==list.length&&($scope.showNoData=!0),1==$scope.pageIndex?$scope.list=list:$scope.list=$scope.list.concat(list)}var id=$location.search().id,page=1,pageSize=10;return id?($scope.getDetailList=function(page){page=page||1,getStrategyByPage(page)},void getStrategyByPage(page)):($scope.showNoData=!0,!1)}),myControllers.controller("OneYuanIntroduceCtrl",function($scope,$location,TradeService){var userType;$scope.showHeader=!0;var source=$location.search().source;source&&"IOSAPP"==source&&($scope.showHeader=!1),$scope.showDialog=!1;var windowHeight=window.screen.height;windowHeight>616&&($(".mod-detail")[0].style.height=windowHeight-230+"px"),source&&"IOSAPP"==source&&windowHeight>616&&($(".mod-detail")[0].style.height=windowHeight-180+"px"),$scope.showCloseDialog=function(){$scope.showDialog=!$scope.showDialog},TradeService.initOneyuan().then(function(res){var initData=res.data;if(100==initData.code){var data=initData.data;userType=data.userType||null}else X.tip(initData.resultMsg)})["catch"](function(){X.tip("服务器请求异常")}),$scope.goBuy=function(){$scope.showHeader?userType?$location.url("/oneYuanTrade"):$location.url("/login?goURL=/oneYuanIntroduce"):window.location.href="yztz://ycl.yztz.com/actTrade"}}),myControllers.controller("OneYuanTradeCtrl",function($scope,$q,$location,$sce,initData,UserService,TradeService,StockService,SystemService){function confirmMineType(){""==mineListStr?$scope.mineType="add":$scope.mineType=mineListStr.indexOf(stockCode)==-1?"add":"delete"}function checkRiskStock(){for(var i=0;i<riskStocks.length;i++){var item=riskStocks[i];if(stockCode==item.stockCode){$scope.isRiskStock=!0;break}}}function processStockInfoData(data){var newPrice=data.newPrice,canBuyNum=2e3/(newPrice*tradingCountRatio)/100|0;canBuyNum=100*canBuyNum;var lastClosePrice=data.lastClosePrice,isStop=isStopStock=0==newPrice,style="",dealNum="",dealPrice="",diff=0,rate=0;isStop||(diff=newPrice-lastClosePrice,rate=diff/lastClosePrice*100,diff=diff.toFixed(2),rate=rate.toFixed(2),style=newPrice>lastClosePrice?"txt-red":newPrice<lastClosePrice?"txt-green":"txt-white",dealNum=processNum(data,"todayDealNum"),dealPrice=processNum(data,"todayDealPrice")),$scope.stock={stockLabel:data.stockLabel,stockName:data.stockName,price:newPrice,lastClosePrice:lastClosePrice,isStop:isStop,diff:diff,rate:rate,style:style,dealNum:dealNum,dealPrice:dealPrice,canBuyNum:canBuyNum,openPrice:data.openPrice,highPrice:data.highPrice,lowPrice:data.lowPrice,limitDownPrice:parseFloat(data.limitDownPrice),limitUpPrice:parseFloat(data.limitUpPrice),amplitude:data.amplitude,todayDealNum:data.todayDealNum,todayDealPrice:data.todayDealPrice,buyPrice:isStop?[0,0,0,0,0]:data.buyPrice,buyNum:isStop?[0,0,0,0,0]:data.buyNum,sellPrice:isStop?[0,0,0,0,0]:data.sellPrice,sellNum:isStop?[0,0,0,0,0]:data.sellNum},QUOTE_DATA={commodityTitle:"STOCK",contractNo:data.stockLabel,time:data.time,openPrice:data.openPrice,yesterdayPrice:data.lastClosePrice,highPrice:data.highPrice,lowPrice:data.lowPrice,newPrice:data.newPrice,limitDownPrice:X.toFloat(data.limitDownPrice),limitUpPrice:X.toFloat(data.limitUpPrice)},newSlineQuoteData(QUOTE_DATA),newKlineQuoteData(QUOTE_DATA)}function init(){getStockInfo(!0),X.engine.addTask(getStockInfo,1e3),X.engine.start()}function getStockSline(){StockService.getSLine(stockCode).then(function(res){var data=res.data;100==data.code?drawSLine(data.data):X.tip(data.resultMsg)})["catch"](function(){X.tip("服务器请求异常")})}function getStockKline(current){var http;"kline"==current?http=StockService.getKLine(stockCode):"weekKline"==current?http=StockService.getWMKline(stockCode,current):"monthKline"==current&&(http=StockService.getWMKline(stockCode,current)),http.then(function(res){var data=res.data;100==data.code?drawKLine(data.data,current):X.tip(data.resultMsg)})["catch"](function(){
X.tip("服务器请求异常")})}function drawSLine(slineData){if(QUOTE_DATA){slineData=slineData||[];var lastTime,data={};slineData.forEach(function(obj,i){lastTime=X.formatDate(obj.time,"hm")-0,data[lastTime]={current:X.toFloat(obj.price),volume:X.toFloat(obj.volume),time:lastTime}}),slineChart=new X.Sline({wrap:"sline-wrap-"+$scope.uuid}),slineChart.draw({data:data,quoteTime:lastTime,close:QUOTE_DATA.yesterdayPrice,high:QUOTE_DATA.highPrice,low:QUOTE_DATA.lowPrice,limitUp:QUOTE_DATA.limitUpPrice,limitDown:QUOTE_DATA.limitDownPrice,period:SystemService.getRealPeriod("STOCK",lastTime),isStock:!0,isIntl:!1,code:stockCode})}}function drawKLine(klineData,type){klineData=klineData||[];var data=[];klineData.forEach(function(o,i){data[i]={time:8==o.time.length?o.time:X.formatDate(o.time,"YMD"),open:o.open,close:o.last,high:o.high,low:o.low,price:o.price}}),klineChart||(klineChart=new X.Kline({wrap:"kline-wrap-"+$scope.uuid})),klineChart.draw(data),"kline"==type?CACHE_KLINE=data:"weekKline"==type?CACHE_WEEKKLINE=data:CACHE_MONTHKLINE=data}function getStockInfo(flag){X.log("行情定时器运行中。。。"),isTrade?(isInTradeTime=SystemService.isInPeriod("STOCK","trade"),isInTradeTime?$scope.isRiskStock?$scope.btn={className:"disabled",btnText:"立即点买",disabled:!0}:QUOTE_DATA&&0==QUOTE_DATA.newPrice?$scope.btn={className:"disabled",btnText:"立即点买",disabled:!0}:$scope.btn={className:"orange",btnText:"立即点买",disabled:!1}:$scope.btn={className:"disabled",btnText:"非点买时段",disabled:!0}):(isInTradeTime=!1,$scope.btn={className:"disabled",btnText:"暂停交易",disabled:!0});var isInQuoteTime=SystemService.isInPeriod("STOCK","quote");flag||isInQuoteTime||$scope.$apply(),dataIsLoad&&isInQuoteTime&&(dataIsLoad=!1,StockService.getStockInfo(stockCode).then(function(res){dataIsLoad=!0;var data=res.data;100==data.code?processStockInfoData(data.data[stockCode]):X.tip(data.resultMsg)})["catch"](function(){X.tip("服务器请求异常")}))}function processNum(data,type){var num=data[type],unit="todayDealNum"==type?"手":"元";return num>1e8?(num/1e8).toFixed(2)+"亿"+unit:num>1e4?(num/1e4).toFixed(2)+"万"+unit:num+unit}function newSlineQuoteData(quote){var price=0==quote.newPrice?quote.yesterdayPrice:quote.newPrice,o={current:price,volume:0,time:X.formatDate(quote.time,"hm")-0};slineChart&&slineChart.perDraw(o,{quoteTime:o.time,close:quote.yesterdayPrice,high:quote.highPrice,low:quote.lowPrice,limitUp:quote.limitUpPrice,limitDown:quote.limitDownPrice,period:SystemService.getRealPeriod("STOCK",o.time),isStock:!0,code:stockCode})}function newKlineQuoteData(quote){if(0!=quote.newPrice&&CACHE_KLINE&&CACHE_KLINE.length){var o={time:X.formatDate(quote.time,"YMD"),open:quote.openPrice,close:quote.yesterdayPrice,high:quote.highPrice,low:quote.lowPrice,price:quote.newPrice};if("kline"==$scope.actType){var last=CACHE_KLINE[CACHE_KLINE.length-1];last.time===o.time?CACHE_KLINE[CACHE_KLINE.length-1]=o:CACHE_KLINE.push(o),klineChart&&klineChart.draw(CACHE_KLINE)}else if("weekKline"==$scope.actType){var last=CACHE_WEEKKLINE[CACHE_WEEKKLINE.length-1];last.time===o.time?CACHE_WEEKKLINE[CACHE_WEEKKLINE.length-1]=o:CACHE_WEEKKLINE.push(o),klineChart&&klineChart.draw(CACHE_WEEKKLINE)}else if("monthKline"==$scope.actType){var last=CACHE_MONTHKLINE[CACHE_MONTHKLINE.length-1];last.time===o.time?CACHE_MONTHKLINE[CACHE_MONTHKLINE.length-1]=o:CACHE_MONTHKLINE.push(o),klineChart&&klineChart.draw(CACHE_MONTHKLINE)}}}function trade(){$scope.btn={className:"disabled",btnText:"数据处理中",disabled:!0},X.loading.show(),TradeService.oneYuanCreate($scope.stock.stockLabel,$scope.stock.canBuyNum,token).then(function(res){var data=res.data;100==data.code?(X.tip("策略发起成功"),zhuge.track("交易",{"名称":"A股"}),$location.url("/oneYuanTradeSell")):(X.dialog.alert(data.resultMsg),token=data.data.token,$scope.btn={className:"orange",btnText:"提交",disabled:!1}),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")})}var userType=initData.userType;if(null==initData)return void X.tip("初始化信息加载错误，请重试");var strRisk=JSON.parse(initData.strRisk),token=initData.token,defaultStock=strRisk.defaultStock?strRisk.defaultStock.value:0,priceRisk=(parseInt(strRisk.maxStockCount.value),strRisk.priceRisk.value.split(",")),balance=initData.balance,tradingCountRatio=strRisk.tradingCountRatio.value,holiday=initData.isHoliday,tradeTime=SystemService.parsePeriod(strRisk.tradingTimeLimit.value);$scope.tradeTime=strRisk.tradingTimeLimit.value;var isTrade=!strRisk.bussmannSwitch||"1"!=strRisk.bussmannSwitch.value;SystemService.setCurrentTime(initData.nowTime),SystemService.setCurrentCurrencyType("CNY"),SystemService.setHoliday(holiday),SystemService.setTradePeriod(tradeTime);var userData,QUOTE_DATA,CACHE_KLINE,CACHE_WEEKKLINE,CACHE_MONTHKLINE,storage=window.localStorage,STOCKCODE="STOCKCODE",MINELIST="MINELIST",stockCode=storage.getItem(STOCKCODE)||defaultStock||"SH600570",mineListStr=storage.getItem(MINELIST)||"",isInTradeTime=!1,isStopStock=!1,dataIsLoad=!0,riskStocks=[],slineChart=null,klineChart=null;$scope.uuid=SystemService.uuid(),$scope.isRiskStock=!1,$scope.showMenu=!1,$scope.mineType="add",$scope.actType="sline",$scope.stopTimer=!1,$scope.stock={},$scope.btn={className:"disabled",btnText:"数据加载中",disabled:!0},X.loading.show(),$q.all({trade:TradeService.getRiskStock(),info:StockService.getStockInfo(stockCode),userInfo:UserService.getUserInfo()}).then(function(res){var infoData=res.info.data,tradeData=res.trade.data;userData=res.userInfo.data,100==tradeData.code&&100==infoData.code?(riskStocks=tradeData.data,confirmMineType(),checkRiskStock(),processStockInfoData(infoData.data[stockCode]),init(),$scope.changeTab("sline")):100!=tradeData.code?X.tip(tradeData.resultMsg):100!=infoData.code&&X.tip(infoData.resultMsg),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")}),$scope.tips=function(title,msg){X.dialog.info(title,msg)},$scope.changeTab=function(current){$scope.actType=current,"sline"!=current||slineChart?("kline"!=current||CACHE_KLINE)&&("weekKline"!=current||CACHE_WEEKKLINE)?"monthKline"!=current||CACHE_MONTHKLINE||getStockKline(current):getStockKline(current):getStockSline(),"kline"==current&&CACHE_KLINE?drawKLine(CACHE_KLINE,current):"weekKline"==current&&CACHE_WEEKKLINE?drawKLine(CACHE_WEEKKLINE,current):"monthKline"==current&&CACHE_MONTHKLINE&&drawKLine(CACHE_MONTHKLINE,current)},$scope.addOrDelMine=function(stockCode,stockName){if(!stockCode||!stockName)return!1;var maxLen=20,mineListStr=storage.getItem(MINELIST)||"",mineArr=[];if(""==mineListStr||mineListStr.indexOf(stockCode)==-1){if(""!=mineListStr&&(mineArr=mineListStr.split(";")),mineArr.length>=maxLen)return void X.dialog.alert("自选最多添加"+maxLen+"条记录");mineArr.push(stockCode+","+stockName),storage.setItem(MINELIST,mineArr.join(";")),$scope.mineType="delete"}else{mineArr=mineListStr.split(";");for(var i=0;i<mineArr.length;i++)mineArr[i].indexOf(stockCode)!=-1&&mineArr.splice(i,1);storage.setItem(MINELIST,mineArr.join(";")),$scope.mineType="add"}},$scope.toTrade=function(){if(null==userType)return $location.url("/login?goURL=/oneYuanTrade"),!1;if(!SystemService.isInPeriod("STOCK","trade"))return X.dialog.alert("当前为非点买时段，无法发起策略"),!1;if($scope.isRiskStock)return X.dialog.alert("【"+$scope.stock.stockName+"】今日点买风险较高，暂无投资人接收交易合作"),!1;var currPrice=$scope.stock.price,closePrice=$scope.stock.lastClosePrice,diff=currPrice-closePrice,rote=(diff/closePrice*100).toFixed(2);return rote>X.toFloat(priceRisk[1])||rote<X.toFloat(priceRisk[0])?(X.dialog.alert("该股今日点买风险较高，暂无投资人接收交易合作"),!1):isStopStock?(X.dialog.alert("停牌股无法进行交易<br>请更换其他能够正常交易的股票"),!1):3==userType?(X.dialog.alert("您已参加过此活动"),!1):4==userType?(X.dialog.alert("您已经参与过A股实盘交易，无法体验"),!1):0==userData.data.named?(X.dialog.confirm("您还未实名认证，请先实名认证",{notify:function(nt){1==nt&&$location.url("/identification?goURL=/oneYuanTrade/")}}),!1):balance<1?(X.dialog.confirm("当前余额不足，<br>请充值后再发起策略。",{sureBtn:"去充值",notify:function(nt){1==nt&&$scope.$apply(function(){$location.url("/payType?goURL=/oneYuanTrade")})}}),!1):isTrade?void trade():(X.dialog.alert("暂停交易"),!1)},$scope.$on("$destroy",function(){X.engine.destroy()})}),myControllers.controller("OneYuanTradeSellCtrl",function($scope,$q,$interval,TradeService,StockService,SystemService){function startTimer(){isOK=!0,getData(),timer=$interval(function(){X.log("点卖定时器运行中。。。"),$scope.isInTradeTime=SystemService.isInPeriod("STOCK","trade"),$scope.isInJJPeriod=SystemService.isInJJPeriod(),(first||!$scope.isHoliday&&$scope.isInTradeTime&&isOK)&&(isOK=!1,getData())},1e3)}function initTodayStartTime(serverTime){serverTime=serverTime||Date.now();var now=new Date(serverTime),yyyy=now.getFullYear(),MM=now.getMonth(),dd=now.getDate(),today=new Date(yyyy,MM,dd,0,0,0);$scope.todayStartTime=today.getTime()}function getData(){var http;http=first?TradeService.oneYuanGetSaleStrategy():TradeService.oneYuanGetSaleStrategyByMemca(),first=!1,http.then(function(res){var data=res.data;if(100==data.code)if(tradeData=data.data,X.loading.hide(),tradeData.dataList.length>0){var stocks=tradeData.dataList[0].stockCode||"";""!=stocks&&stocks||($scope.dataList=[]),StockService.getStockInfo(stocks).then(function(res){var data=res.data;100==data.code?(quoteData=data.data,processData()):initNoDataQuote()})["catch"](function(){X.tip("服务器请求异常")})}else $scope.dataList=[];else X.tip(data.resultMsg)})["catch"](function(){X.tip("服务器请求异常")})}function processData(){if($scope.dataIsLoad=!0,isOK=!0,X.loading.hide(),null==tradeData||null==quoteData)return void($scope.dataList=[]);var dataList=tradeData.dataList;$.each(dataList,function(i,item){var quote=quoteData[item.stockCode];item.quotePrice=quote?quote.newPrice:0,item.lastClosePrice=quote.lastClosePrice,0!=item.buyPriceDeal&&0!=item.quotePrice&&0!=item.volumeHold?item.profit=(item.quotePrice-item.buyPriceDeal)*item.volumeHold:item.profit=(item.lastClosePrice-item.buyPriceDeal)*item.volumeHold}),$scope.dataList=dataList}function sale(tradeID,isAlwaysClose){return $scope.isInTradeTime?(X.loading.show(),void TradeService.oneYuanCloseStrategy(tradeID,isAlwaysClose).then(function(res){var data=res.data;100==data.code?(X.tip("点卖策略成功"),first=!0):X.tip(data.resultMsg),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")})):void X.tip("非交易时间不能交易")}function initNoDataQuote(){$scope.dataIsLoad=!0,isOK=!0,X.loading.hide();var dataList=tradeData.dataList;tradeData.length>0&&$.each(dataList,function(i,item){item.quotePrice=0,item.profit=0}),$scope.dataList=dataList}function clearTimer(){timer&&($interval.cancel(timer),timer=void 0)}var timer,first=!0,tradeData=null,quoteData=null,isOK=!1;$scope.tradeState={1:"等待接单",2:"正在委托买入",3:"正在委托买入",4:"点卖",5:"正在委托卖出",6:"正在委托卖出",7:"正在清算",8:"已清算"},$scope.dataList=[],$scope.dataMap={},$scope.dataIsLoad=!1,$scope.isInTradeTime=!1,$scope.isHoliday=!0,$scope.todayStartTime=0,$scope.showMenu=!1,X.loading.show(),$q.all({trade:TradeService.initOneyuan()}).then(function(res){var tradeData=res.trade.data;if(100==tradeData.code){var data=tradeData.data,strRisk=JSON.parse(data.strRisk);$scope.isHoliday=data.isHoliday;var tradeTime=SystemService.parsePeriod(strRisk.tradingTimeLimit.value);SystemService.setCurrentTime(data.nowTime),SystemService.setCurrentCurrencyType("CNY"),SystemService.setTradePeriod(tradeTime),$scope.isInTradeTime=SystemService.isInPeriod("STOCK","trade"),$scope.isInJJPeriod=SystemService.isInJJPeriod(),initTodayStartTime(data.nowTime),startTimer()}else X.tip(tradeData.resultMsg)})["catch"](function(){X.tip("服务器请求异常")}),$scope.sale=function(trade){var html='<div class="mod-sale-confirm-wrap">';html+='<div class="item">股票名称:<span class="fr">'+trade.stockName+"</span></div>",html+='<div class="item">股票代码:<span class="fr">'+trade.stockCode.substr(-6)+"</span></div>",html+='<div class="item">委托价格:<span class="fr">市价</span></div>',html+='<div class="item">卖出数量:<span class="fr">'+trade.volumeHold+"股</span></div>",html+='<div class="item">持仓天数:<span class="fr">'+trade.holdDays+"天</span></div>",html+=trade.profit>0?'<div class="item">浮动盈亏:<span class="fr txt-red">+'+trade.profit.toFixed(2)+"元</span></div>":trade.profit<0?'<div class="item">浮动盈亏:<span class="fr txt-green">'+trade.profit.toFixed(2)+"元</span></div>":'<div class="item">浮动盈亏:<span class="fr">'+trade.profit.toFixed(2)+"元</span></div>",html+="</div>",X.dialog.confirm(html,{title:"点卖确认",notify:function(nt){if(1==nt){document.getElementById("agreeDefer");sale(trade.id,!1)}}})},$scope.showPartDeal=function(trade){var list=trade.tradingRecordList,volumeDeal=trade.volumeHold,table="";table+="<table>",table+='<tr><td>成交时间</td><td>数量</td><td class="txt-right">价格</td></tr>';for(var i=0;i<list.length;i++){var obj=list[i];table+="<tr><td>"+X.formatDate(new Date(obj.time),"Y-M-D")+"</td><td>"+obj.amount+'</td><td class="txt-right">'+obj.price.toFixed(2)+"</td></tr>",volumeDeal+=obj.amount}table+="</table>";var tipHtml='<div class="info">行情波动过大，造成部分成交，原持有数量'+volumeDeal+"股，现剩余"+trade.volumeHold+"股，请处理剩余数量，以便结算！</div>";X.dialog.alert('<div class="mod-part-deal-wrap">'+tipHtml+table+"</div>")},$scope.$on("$destroy",function(){clearTimer()})}),myControllers.controller("OneYuanTradeResultCtrl",function($scope,$location,$q,TradeService){$scope.settleList=[],$scope.showMenu=!1,$scope.getSettleList=function(){X.loading.show(),TradeService.oneYuanGetSettleStrategy().then(function(res){var settleListData=res.data;if(100==settleListData.code){var data=settleListData.data;$scope.settleList=data}X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")})},$scope.getSettleList(),$scope.toDetail=function(tradeID){$location.url("/tradeDetail/"+tradeID+"?sort=oneYuan")}}),myControllers.controller("AliPayIdentificationCtrl",function($scope,$interval,$location,$q,UserService){function isMoney(data,isPositive){return isPositive?/^\d+(\.\d{0,2})?$/.test(data)&&parseFloat(data)>0:/^(-)?\d+(\.\d{1,2})?$/.test(data)}function timerFnc(){timer=$interval(function(){""!=$scope.alipayAccount&&""!=$scope.tradeAmount&&""!=$scope.tradeNo?$scope.btnState="orange":$scope.btnState="disable"},100)}$scope.alipayAccount="",$scope.tradeAmount="",$scope.tradeNo="",$scope.btnState="disable";var timer=null;$scope.submitAliPay=function(){if(""!=$scope.alipayAccount&&""!=$scope.tradeAmount&&""!=$scope.tradeNo)return $scope.tradeAmount||""==$scope.tradeAmount||($scope.tradeAmount=""),X.isMobile($scope.alipayAccount)||X.isEmail($scope.alipayAccount)?$scope.tradeAmount<1?void X.tip("充值金额最低1元"):isMoney($scope.tradeAmount,!0)?$scope.tradeAmount>1e5?void X.tip("充值金额最高10万元"):$scope.tradeNo.length<12?void X.tip("支付宝订单号错误"):void UserService.bindingAlipayAccount($scope.alipayAccount,$scope.tradeAmount,$scope.tradeNo).then(function(res){var data=res.data;100==data.code?(X.tip("认证成功"),$location.url("/myInfo")):501==data.code&&X.tip(data.resultMsg)})["catch"](function(){X.tip("服务器请求异常")}):void X.tip("充值金额错误"):void X.tip("支付宝账号输入错误")},$scope.$on("$destroy",function(){timer&&$interval.cancel(timer)}),timerFnc()}),myControllers.controller("SimulateStockCtrl",function($scope,$q,$location,$interval,SimulateService){function getSimSpecial(){SimulateService.simSpecial().then(function(res){var simInfo=res.data;if(100==simInfo.code){var simData=simInfo.data;initSimData(simData)}else X.tip(simInfo.resultMsg);X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")})}function initMatchData(data){if(!data)return $scope.NoMatchData=!0,!1;var match=data;$scope.match=match.slice(0,3),$scope.matchNoTop3=match.slice(3)}function initSimData(data){var isLogin=data.authenticatedFlag,strategyUserFlag=data.strategyUserFlag,authenFlag=data.authenFlag,gameStatus=data.gameStatus,gameTime=data.gameTime,resultReleaseTime=data.resultReleaseTime,rowNum=data.rowNum,sysdate=data.sysdate,gameOverDate=data.gameOverDate,userCount=data.userCount||0,simAsset=data.simAsset,timeList=gameTime.split(":"),gameTime=timeList[1];$scope.season=timeList[0],$scope.simData={isLogin:isLogin,strategyUserFlag:strategyUserFlag,authenFlag:authenFlag,gameStatus:gameStatus,gameTime:gameTime,userCount:userCount,rowNum:rowNum,releaseDate:getDate(resultReleaseTime),simAsset:X.formatNumber(simAsset),sysdate:sysdate,gameOverDate:gameOverDate},strategyUserFlag||1!=gameStatus?strategyUserFlag&&1==gameStatus?$scope.btn={className:"disable",btnText:"您已报名",disabled:!0}:strategyUserFlag||2!=gameStatus?strategyUserFlag&&2==gameStatus?$scope.btn={className:"red",btnText:"立即参赛",disabled:!1}:isLogin||strategyUserFlag||3!=gameStatus?strategyUserFlag||3!=gameStatus?strategyUserFlag&&3==gameStatus&&($scope.btn={className:"red",btnText:"比赛已经结束",disabled:!1}):$scope.btn={className:"disable",btnText:"比赛已经结束",disabled:!0}:$scope.btn={className:"red",btnText:"比赛已经结束",disabled:!1}:$scope.btn={className:"red",btnText:"立即报名",disabled:!1}:$scope.btn={className:"red",btnText:"立即报名",disabled:!1},getTime(gameTime),getTimeNoYear(gameTime),timer()}function initRanksData(data){$scope.rankLen=data.length,$scope.ranks=data}function initUserDetail(data){var len=data.length;return 0==len?($scope.showUserDetail=!0,$scope.NoUserDetail=!0,!1):($scope.userDetailList=data,$scope.NoUserDetail=!1,void($scope.showUserDetail=!0))}function getTime(time){var timeList=time.split("—"),startTime=timeList[0],endTime=timeList[1];$scope.startDate=getDate(startTime),$scope.endDate=getDate(endTime)}function getTimeNoYear(time){var timeList=time.split("—"),startTime=timeList[0].split("."),endTime=timeList[1].split(".");$scope.timeNoYear=startTime[1]+"."+startTime[2]+"—"+endTime[1]+"."+endTime[2]}function getDate(d){var time=d.split("."),len=time.length,date=time[len-2]+"月"+time[len-1]+"日";return date}function timer(){$scope.simData.gameOverDate=new Date($scope.simData.gameOverDate);var d=new Date($scope.simData.sysdate),ts=$scope.simData.gameOverDate-d;ts<=0&&(ts=0,clearTimer());var dd=parseInt(ts/1e3/60/60/24,10),hh=parseInt(ts/1e3/60/60%24,10),mm=parseInt(ts/1e3/60%60,10),ss=parseInt(ts/1e3%60,10);dd=checkTime(dd),hh=checkTime(hh),mm=checkTime(mm),ss=checkTime(ss);for(var time=dd+""+hh+mm+ss,iSpan=$("#timer span"),i=0;i<iSpan.length;i++)iSpan[i].innerHTML=time[i];var year=d.getFullYear(),month=d.getMonth(),day=d.getDate(),hour=d.getHours(),min=d.getMinutes(),s=d.getSeconds();$scope.simData.sysdate=new Date(year,month,day,hour,min,s+1)}function checkTime(i){return i<10&&(i="0"+i),i}function clearTimer(){_timer&&($interval.cancel(_timer),_timer=void 0)}$scope.showHeader=!0;var source=$location.search().source;source&&"IOSAPP"==source&&($scope.showHeader=!1);var _timer;$scope.rankIndex=0,$scope.userDetailList=[],$scope.NoMatchData=!1,$scope.showRule=!1,$scope.showUserDetail=!1,$scope.NoUserDetail=!1,$scope.btn={className:"disable",btnText:"立即报名",disabled:!0},X.loading.show(),$q.all({matchInfo:SimulateService.getMatchInfo(),simSpecial:SimulateService.simSpecial(),userRanks:SimulateService.getUserRanks()}).then(function(res){var matchInfo=res.matchInfo.data,simInfo=res.simSpecial.data,ranksInfo=res.userRanks.data;if(100==matchInfo.code&&100==simInfo.code&&100==ranksInfo.code){var matchData=matchInfo.data,simData=simInfo.data,ranksData=ranksInfo.data;initMatchData(matchData),initSimData(simData),initRanksData(ranksData),$scope.showRank($scope.rankIndex)}else 100!=matchInfo.code?X.tip(matchInfo.resultMsg):100!=simInfo.code?X.tip(simInfo.resultMsg):100!=ranksInfo.code&&X.tip(ranksInfo.resultMsg);X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")}),$scope.showRank=function(index){var rank=$scope.ranks[index],rankList=[];$scope.rankIndex=index,$scope.count=rank.count,rankList[0]=rank.userRankDOs[1],rankList[1]=rank.userRankDOs[0],rankList[2]=rank.userRankDOs[2],$scope.rankList=rankList},$scope.showDetail=function(id){SimulateService.getUserDetailInfo(id).then(function(res){var userDetailData=res.data;if(100==userDetailData.code){var userDetail=userDetailData.data;initUserDetail(userDetail)}else $scope.showUserDetail=!0,$scope.NoUserDetail=!0;X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")})},$scope.to=function(){if($scope.showHeader){if(!$scope.simData.isLogin)return $location.url("/login?goURL=/simulateStock"),!1;if(!$scope.simData.authenFlag)return X.dialog.confirm("您还未实名认证，请先实名认证",{notify:function(nt){1==nt&&$scope.$apply(function(){$location.url("/identification?goURL=/simulateStock")})}}),!1;if(!$scope.simData.strategyUserFlag)return X.loading.show(),SimulateService.joinStrategyComp().then(function(res){var strategyData=res.data;100==strategyData.code?(X.dialog.alert("报名成功"),getSimSpecial()):X.tip(strategyData.resultMsg),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")}),!1;$location.url("/simulateTrade")}else window.location.href="yztz://ycl.yztz.com/simTrade"},_timer=$interval(timer,1e3),$scope.$on("$destroy",function(){clearTimer()})}),myControllers.controller("SimulateTradeCtrl",function($scope,$q,$sce,$location,$routeParams,$interval,initData,StockService,TradeService,SystemService,SimulateService){function init(){getStockInfo(!0),X.engine.addTask(getStockInfo,1e3),X.engine.start()}function initSimAsset(){SimulateService.getSimAsset().then(function(res){var data=res.data;100==data.code?($scope.simAsset=data.data.split(";"),"null"==$scope.simAsset[1]&&($scope.simAsset[1]=0)):X.tip(data.resultMsg)})["catch"](function(){X.tip("服务器请求异常")})}function checkRiskStock(){for(var i=0;i<riskStocks.length;i++){var item=riskStocks[i];if(stockCode==item.stockCode){$scope.isRiskStock=!0;break}}}function confirmMineType(){""==mineListStr?$scope.mineType="add":$scope.mineType=mineListStr.indexOf(stockCode)==-1?"add":"delete"}function drawSLine(slineData){if(QUOTE_DATA){slineData=slineData||[];var lastTime,data={};slineData.forEach(function(obj,i){lastTime=X.formatDate(obj.time,"hm")-0,data[lastTime]={current:X.toFloat(obj.price),volume:X.toFloat(obj.volume),time:lastTime}}),slineChart=new X.Sline({wrap:"sline-wrap-"+$scope.uuid}),slineChart.draw({data:data,quoteTime:lastTime,close:QUOTE_DATA.yesterdayPrice,high:QUOTE_DATA.highPrice,low:QUOTE_DATA.lowPrice,limitUp:QUOTE_DATA.limitUpPrice,limitDown:QUOTE_DATA.limitDownPrice,period:SystemService.getRealPeriod("STOCK",lastTime),isStock:!0,isIntl:!1,code:stockCode})}}function drawKLine(klineData,type){klineData=klineData||[];var data=[];klineData.forEach(function(o,i){data[i]={time:8==o.time.length?o.time:X.formatDate(o.time,"YMD"),open:o.open,close:o.last,high:o.high,low:o.low,price:o.price}}),klineChart||(klineChart=new X.Kline({wrap:"kline-wrap-"+$scope.uuid})),klineChart.draw(data),"kline"==type?CACHE_KLINE=data:"weekKline"==type?CACHE_WEEKKLINE=data:CACHE_MONTHKLINE=data}function newSlineQuoteData(quote){var price=0==quote.newPrice?quote.yesterdayPrice:quote.newPrice,o={current:price,volume:0,time:X.formatDate(quote.time,"hm")-0};slineChart&&slineChart.perDraw(o,{quoteTime:o.time,close:quote.yesterdayPrice,high:quote.highPrice,low:quote.lowPrice,limitUp:quote.limitUpPrice,limitDown:quote.limitDownPrice,period:SystemService.getRealPeriod("STOCK",o.time),isStock:!0,code:stockCode})}function newKlineQuoteData(quote){if(0!=quote.newPrice&&CACHE_KLINE&&CACHE_KLINE.length){var o={time:X.formatDate(quote.time,"YMD"),open:quote.openPrice,close:quote.yesterdayPrice,high:quote.highPrice,low:quote.lowPrice,price:quote.newPrice};if("kline"==$scope.actType){var last=CACHE_KLINE[CACHE_KLINE.length-1];last.time===o.time?CACHE_KLINE[CACHE_KLINE.length-1]=o:CACHE_KLINE.push(o),klineChart&&klineChart.draw(CACHE_KLINE)}else if("weekKline"==$scope.actType){var last=CACHE_WEEKKLINE[CACHE_WEEKKLINE.length-1];last.time===o.time?CACHE_WEEKKLINE[CACHE_WEEKKLINE.length-1]=o:CACHE_WEEKKLINE.push(o),klineChart&&klineChart.draw(CACHE_WEEKKLINE)}else if("monthKline"==$scope.actType){var last=CACHE_MONTHKLINE[CACHE_MONTHKLINE.length-1];last.time===o.time?CACHE_MONTHKLINE[CACHE_MONTHKLINE.length-1]=o:CACHE_MONTHKLINE.push(o),klineChart&&klineChart.draw(CACHE_MONTHKLINE)}}}function getStockSline(){StockService.getSLine(stockCode).then(function(res){var data=res.data;100==data.code?drawSLine(data.data):X.tip(data.resultMsg)})["catch"](function(){X.tip("服务器请求异常")})}function getStockKline(current){var http;"kline"==current?http=StockService.getKLine(stockCode):"weekKline"==current?http=StockService.getWMKline(stockCode,current):"monthKline"==current&&(http=StockService.getWMKline(stockCode,current)),http.then(function(res){var data=res.data;100==data.code?drawKLine(data.data,current):X.tip(data.resultMsg)})["catch"](function(){X.tip("服务器请求异常")})}function getStockInfo(flag){X.log("行情定时器运行中。。。"),1==gameTimeStatus?isTrade?(isInTradeTime=SystemService.isInPeriod("STOCK","trade"),isInTradeTime?$scope.isRiskStock?$scope.btn={className:"disabled",btnText:"立即点买",disabled:!0}:QUOTE_DATA&&0==QUOTE_DATA.newPrice?$scope.btn={className:"disabled",btnText:"立即点买",disabled:!0}:$scope.btn={className:"orange",btnText:"立即点买",disabled:!1}:$scope.btn={className:"disabled",btnText:"非点买时段",disabled:!0}):(isInTradeTime=!1,$scope.btn={className:"disabled",btnText:"暂停交易",disabled:!0}):$scope.btn={className:"disabled",btnText:"立即点买",disabled:!0};var isInQuoteTime=SystemService.isInPeriod("STOCK","quote");flag||isInQuoteTime||$scope.$apply(),dataIsLoad&&isInQuoteTime&&(dataIsLoad=!1,StockService.getStockInfo(stockCode).then(function(res){dataIsLoad=!0;var data=res.data;100==data.code?processStockInfoData(data.data[stockCode]):X.tip(data.resultMsg)})["catch"](function(){X.tip("服务器请求异常")}))}function processStockInfoData(data){var newPrice=data.newPrice,lastClosePrice=data.lastClosePrice,isStop=0==newPrice,style="",dealNum="",dealPrice="",diff=0,rate=0;isStop||(diff=newPrice-lastClosePrice,rate=diff/lastClosePrice*100,diff=diff.toFixed(2),rate=rate.toFixed(2),style=newPrice>lastClosePrice?"txt-red":newPrice<lastClosePrice?"txt-green":"txt-white",dealNum=processNum(data,"todayDealNum"),dealPrice=processNum(data,"todayDealPrice")),$scope.stock={stockLabel:data.stockLabel,stockName:data.stockName,price:newPrice,lastClosePrice:lastClosePrice,isStop:isStop,diff:diff,rate:rate,style:style,dealNum:dealNum,dealPrice:dealPrice,openPrice:data.openPrice,highPrice:data.highPrice,lowPrice:data.lowPrice,limitDownPrice:parseFloat(data.limitDownPrice),limitUpPrice:parseFloat(data.limitUpPrice),amplitude:data.amplitude,todayDealNum:data.todayDealNum,todayDealPrice:data.todayDealPrice,buyPrice:isStop?[0,0,0,0,0]:data.buyPrice,buyNum:isStop?[0,0,0,0,0]:data.buyNum,sellPrice:isStop?[0,0,0,0,0]:data.sellPrice,sellNum:isStop?[0,0,0,0,0]:data.sellNum},QUOTE_DATA={commodityTitle:"STOCK",contractNo:data.stockLabel,time:data.time,openPrice:data.openPrice,yesterdayPrice:data.lastClosePrice,highPrice:data.highPrice,lowPrice:data.lowPrice,newPrice:data.newPrice,limitDownPrice:X.toFloat(data.limitDownPrice),limitUpPrice:X.toFloat(data.limitUpPrice)},newSlineQuoteData(QUOTE_DATA),newKlineQuoteData(QUOTE_DATA)}function processNum(data,type){var num=data[type],unit="todayDealNum"==type?"手":"元";return num>1e8?(num/1e8).toFixed(2)+"亿"+unit:num>1e4?(num/1e4).toFixed(2)+"万"+unit:num+unit}if("您未报名"==initData)return void X.dialog.alert(initData,{notify:function(){$scope.$apply(function(){$location.url("/index")})}});if(null==initData)return void X.tip("初始化信息加载错误，请重试");var gameTimeStatus=initData.gameTimeStatus,strRisk=JSON.parse(initData.strategyRisk),defaultStock=strRisk.defaultStock.value,priceRisk=strRisk.priceRisk.value.split(","),holiday=SystemService.parseHoliday(initData.holidays),tradeTime=SystemService.parsePeriod(strRisk.tradingTimeLimit.value),isTrade="1"!=strRisk.bussmannSwitch.value;SystemService.setCurrentTime(initData.nowTime),SystemService.setCurrentCurrencyType("CNY"),SystemService.setHoliday(holiday),SystemService.setTradePeriod(tradeTime);var QUOTE_DATA,CACHE_KLINE,CACHE_WEEKKLINE,CACHE_MONTHKLINE,storage=window.localStorage,STOCKCODE="STOCKCODE",MINELIST="MINELIST",stockCodeFromIndex=$location.search().stock,stockCode=stockCodeFromIndex||storage.getItem(STOCKCODE)||defaultStock||"SH600570",mineListStr=storage.getItem(MINELIST)||"",isInTradeTime=!1,dataIsLoad=!0,riskStocks=[],slineChart=null,klineChart=null;$scope.uuid=SystemService.uuid(),$scope.isRiskStock=!1,$scope.showMenu=!1,$scope.mineType="add",$scope.actType="sline",$scope.stopTimer=!1,$scope.stock={},$scope.btn={className:"disabled",btnText:"数据加载中",disabled:!0},X.loading.show(),$q.all({trade:TradeService.getRiskStock(),info:StockService.getStockInfo(stockCode),simSpecial:SimulateService.simSpecial()}).then(function(res){var infoData=res.info.data,tradeData=res.trade.data,simSpecialData=res.simSpecial.data;100==tradeData.code&&100==infoData.code&&100==simSpecialData.code?(riskStocks=tradeData.data,$scope.simSpecial=simSpecialData.data,confirmMineType(),checkRiskStock(),processStockInfoData(infoData.data[stockCode]),init(),$scope.changeTab("sline")):100!=tradeData.code?X.tip(tradeData.resultMsg):100!=infoData.code?X.tip(infoData.resultMsg):100!=simSpecialData.code&&X.tip(simSpecialData.resultMsg),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")}),initSimAsset(),$scope.changeTab=function(current){$scope.actType=current,"sline"!=current||slineChart?("kline"!=current||CACHE_KLINE)&&("weekKline"!=current||CACHE_WEEKKLINE)?"monthKline"!=current||CACHE_MONTHKLINE||getStockKline(current):getStockKline(current):getStockSline(),"kline"==current&&CACHE_KLINE?drawKLine(CACHE_KLINE,current):"weekKline"==current&&CACHE_WEEKKLINE?drawKLine(CACHE_WEEKKLINE,current):"monthKline"==current&&CACHE_MONTHKLINE&&drawKLine(CACHE_MONTHKLINE,current)},$scope.toTrade=function(){if(1==$scope.simSpecial.gameStatus)return X.dialog.alert("比赛未开始"),!1;if(3==$scope.simSpecial.gameStatus)return X.dialog.alert("比赛已结束"),!1;if(!QUOTE_DATA)return!1;if(0==QUOTE_DATA.newPrice)return X.dialog.alert("停牌股暂时无法进行买卖"),!1;if($scope.isRiskStock)return X.dialog.alert("该股今日为禁买股，请选择其他股票交易"),!1;var currPrice=QUOTE_DATA.newPrice,closePrice=QUOTE_DATA.yesterdayPrice,diff=currPrice-closePrice,rote=(diff/closePrice*100).toFixed(2);return rote>X.toFloat(priceRisk[1])||rote<X.toFloat(priceRisk[0])?(X.dialog.alert("该股今日点买风险较高，暂无投资人接收交易合作"),!1):void $location.path("/simulateTradeBuy/"+stockCode)},$scope.addOrDelMine=function(stockCode,stockName){if(!stockCode||!stockName)return!1;var maxLen=20,mineListStr=storage.getItem(MINELIST)||"",mineArr=[];if(""==mineListStr||mineListStr.indexOf(stockCode)==-1){if(""!=mineListStr&&(mineArr=mineListStr.split(";")),mineArr.length>=maxLen)return void X.dialog.alert("自选最多添加"+maxLen+"条记录");mineArr.push(stockCode+","+stockName),storage.setItem(MINELIST,mineArr.join(";")),$scope.mineType="delete"}else{mineArr=mineListStr.split(";");for(var i=0;i<mineArr.length;i++)mineArr[i].indexOf(stockCode)!=-1&&mineArr.splice(i,1);storage.setItem(MINELIST,mineArr.join(";")),$scope.mineType="add"}},$scope.$on("$destroy",function(){X.engine.destroy()})}),myControllers.controller("SimulateTradeBuyCtrl",function($scope,$q,$routeParams,$location,TradeService,StockService,UserService,SystemService,SimulateService){function trade(){var postData={token:token,money:$scope.money,lever:lowRateList[$scope.lowIndex].value,quitLoss:$scope.lowMoney,quitGain:$scope.highMoney,principal:$scope.principal,serviceCharge:$scope.serviceCharge,stockCode:stockCode,volumeOrder:$scope.stockCount};$scope.btn={className:"disabled",btnText:"数据处理中",disabled:!0},X.loading.show(),SimulateService.createSimTrade(postData).then(function(res){var data=res.data;100==data.code?(X.tip("策略发起成功"),$location.path("/simulateTradeSell")):(token=data.data.token,X.tip(data.resultMsg),$scope.btn={className:"orange",btnText:"提交",disabled:!1}),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")})}function checkRiskStock(){for(var i=0;i<riskStocks.length;i++){var item=riskStocks[i];if(stockCode==item.stockCode)return!0}return!1}function processServiceCharge(money){$scope.serviceCharge=X.toFloat(money/1e4*serviceCharge)}function processStockCount(money){var count=money/($scope.stock.stockPrice*tradingCountRatio)/100|0;count=100*count,$scope.stockCount=count}function processHigh(money){$scope.highMoneyList=[],$.each(highRateList,function(i,item){$scope.highMoneyList.push(X.toInt(money*item))})}function processLow(money){$scope.lowMoneyList=[],$.each(lowRateList,function(i,obj){$scope.lowMoneyList.push(X.toInt(X.toInt(-money/obj.value)*obj.rote));
})}function initStockData(data){$scope.stock.stockCode=data.stockLabel,$scope.stock.stockName=data.stockName,$scope.stock.stockPrice=data.newPrice,$scope.stock.stockClose=data.lastClosePrice}function initTradeData(data){var buyCount=data.buyCount,balance=data.balance;isHoliday=data.isHoliday;var gameTimeStatus=data.gameTimeStatus,risk=JSON.parse(data.strategyRisk);maxStockCount=risk.maxStockCount.value,serviceCharge=risk.serviceCharge.value,deferCharge=risk.deferCharge.value,tradingCountRatio=risk.tradingCountRatio.value,maxMoneyOneStock=risk.maxMoneyOneStock.value,priceRisk=risk.priceRisk.value.split(","),token=data.token;var maxCountOneDay=risk.maxCountOneDay.value,tradingMoneyList=risk.tradingMoneyList.value,quitGainRatioList=risk.quitGainRatioList.value,levers=risk.levers.levers;$scope.risk=risk,$scope.balance=balance,$scope.isHoliday=isHoliday,$scope.canBuyCount=maxCountOneDay-buyCount>0?maxCountOneDay-buyCount:0,$scope.serviceChargeTips="交易综合费包含第一天的交易费，第二天的递延费，每万元点买金的交易综合费为"+serviceCharge+"元，每万元点买金的递延费"+deferCharge+"元/天。";var holiday=SystemService.parseHoliday(data.holidays),tradeTime=SystemService.parsePeriod(risk.tradingTimeLimit.value);isTrade="1"!=risk.bussmannSwitch.value,SystemService.setCurrentTime(data.nowTime),SystemService.setCurrentCurrencyType("CNY"),SystemService.setHoliday(holiday),SystemService.setTradePeriod(tradeTime),initTradeMoney(tradingMoneyList),initHighRate(quitGainRatioList),initLowRate(levers),1==gameTimeStatus?0==$scope.canBuyCount?$scope.btn={className:"disabled",btnText:"今日点买次数已用完",disabled:!0}:$scope.btn={className:"orange",btnText:"提交",disabled:!1}:$scope.btn={className:"disabled",btnText:"提交",disabled:!0}}function initTradeMoney(tradingMoneyStr){tradingMoneyStr&&($scope.tradeMoneyList=[],tradeMoneyList=tradingMoneyStr.split(","),$.each(tradeMoneyList,function(i,m){$scope.tradeMoneyList.push({value:m,text:X.sketchNumber(m)})}))}function initHighRate(quitGainRatioListStr){quitGainRatioListStr&&($scope.highMoneyList=[],highRateList=quitGainRatioListStr.split(","))}function initLowRate(levers){lowRateList=[],$.each(levers,function(i,item){var rote=item.quitLossLineRatio.value,value=item.value;lowRateList.push({rote:rote,value:value})})}var stockCode=$routeParams.stockCode,stockCodeReg=/^(SZ|SH)\d{6,}$/;if(!stockCode||!stockCodeReg.test(stockCode))return void $location.path("/simulateTrade");var stockBuyMoney,isTrade,token="",tradeMoneyList=[],highRateList=[],lowRateList=[],serviceCharge=0,deferCharge=0,priceRisk=[-8,8],maxMoneyOneStock=1e5,maxStockCount=1e4,tradingCountRatio=1,riskStocks=[],initTime=Date.now(),isHoliday=!0;$scope.stock={},$scope.trade={},$scope.risk={},$scope.currentIndex=0,$scope.highIndex=0,$scope.lowIndex=0,$scope.money=0,$scope.highMoney=0,$scope.lowMoney=0,$scope.tradeMoneyList=[],$scope.highMoneyList=[],$scope.lowMoneyList=[],$scope.principal=0,$scope.serviceCharge=0,$scope.stockCount=0,$scope.canBuyCount=0,$scope.isHoliday=!0,$scope.btn={className:"disabled",btnText:"数据加载中",disabled:!0},X.loading.show(),$q.all({simSpecial:SimulateService.simSpecial(),stock:StockService.getStockInfo(stockCode),trade:SimulateService.initSimTrade(),stockStatisticsInfo:SimulateService.getSimStockStatisticsInfo(stockCode),tradeRisk:TradeService.getRiskStock()}).then(function(res){var simSpecialData=res.simSpecial.data,stockData=res.stock.data,stockStatisticsInfoData=res.stockStatisticsInfo.data,tradeData=res.trade.data,tradeRiskData=res.tradeRisk.data;100==simSpecialData.code&&100==stockData.code&&100==tradeData.code&&100==stockStatisticsInfoData.code&&100==tradeRiskData.code?($scope.simSpecial=simSpecialData.data,riskStocks=tradeRiskData.data,stockBuyMoney=stockStatisticsInfoData.data.money||0,initStockData(stockData.data[stockCode]),initTradeData(tradeData.data),$scope.chooseMoney($scope.currentIndex,$scope.tradeMoneyList[$scope.currentIndex].value)):900==tradeData.code?X.dialog.alert(tradeData.resultMsg,{notify:function(){$scope.$apply(function(){$location.url("/index")})}}):100!=simSpecialData.code?X.tip(simSpecialData.resultMsg):100!=stockData.code?X.tip(stockData.resultMsg):100!=tradeData.code?X.tip(tradeData.resultMsg):100!=stockStatisticsInfoData.code?X.tip(stockStatisticsInfoData.resultMsg):100!=tradeRiskData.code&&X.tip(tradeRiskData.resultMsg),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")}),$scope.toTrade=function(){if(1==$scope.simSpecial.gameStatus)return X.dialog.alert("比赛未开始"),!1;if(3==$scope.simSpecial.gameStatus)return X.dialog.alert("比赛已结束"),!1;if(!isTrade)return X.dialog.alert("暂停交易"),!1;if(!SystemService.isInPeriod("STOCK","trade"))return X.dialog.alert("当前为非点买时段，无法发起策略"),!1;if(0==$scope.stock.stockPrice)return X.dialog.alert("停牌股无法进行交易<br>请更换其他能够正常交易的股票"),!1;if(checkRiskStock())return X.dialog.alert("【"+$scope.stock.stockName+"】今日点买风险较高，暂无投资人接收交易合作"),!1;var currPrice=$scope.stock.stockPrice,closePrice=$scope.stock.stockClose,diff=currPrice-closePrice,rote=(diff/closePrice*100).toFixed(2);if(rote>X.toFloat(priceRisk[1])||rote<X.toFloat(priceRisk[0]))return X.dialog.alert("该股今日点买风险较高，暂无投资人接收交易合作"),!1;var canBuyMoney=maxMoneyOneStock-stockBuyMoney;if(canBuyMoney<0&&(canBuyMoney=0),$scope.money>canBuyMoney)return X.dialog.alert("个股持仓累计金额最多"+maxMoneyOneStock+"元，当前还可点买"+canBuyMoney+"元"),!1;var now=Date.now(),min=1;if(now-initTime>60*min*1e3)return X.dialog.alert("由于股票价格实时变化，您未在"+60*min+"秒内发起策略，这将导致数据波动较大，请重新获取数据，尽快提交",{title:"系统提示",notify:function(){window.location.reload()}}),!1;if($scope.stockCount>maxStockCount)return X.dialog.alert("单股最高可购买数量为"+maxStockCount+"股"),!1;var needMoney=$scope.principal+$scope.serviceCharge;return $scope.balance<needMoney?(X.dialog.alert("您的模拟点买余额不足"),!1):void trade()},$scope.tips=function(title,msg){X.dialog.info(title,msg)},$scope.chooseMoney=function(index,money){$scope.currentIndex=index,$scope.money=money,processHigh(money),processLow(money),$scope.chooseHigh(0,$scope.highMoneyList[0]),$scope.chooseLow(0,$scope.lowMoneyList[0]),processServiceCharge(money),processStockCount(money)},$scope.chooseHigh=function(index,money){$scope.highIndex=index,$scope.highMoney=money},$scope.chooseLow=function(index,money){$scope.lowIndex=index,$scope.lowMoney=money,$scope.principal=X.toInt($scope.money/lowRateList[index].value)}}),myControllers.controller("SimulateTradeSellCtrl",function($scope,$q,$interval,$location,StockService,SimulateService,SystemService){function startTimer(){isOK=!0,getData(),timer=$interval(function(){X.log("点卖定时器运行中。。。"),$scope.isInTradeTime=SystemService.isInPeriod("STOCK","trade"),$scope.isInJJPeriod=SystemService.isInJJPeriod(),(first||!$scope.isHoliday&&$scope.isInTradeTime&&isOK)&&(isOK=!1,getData())},1e3)}function initTodayStartTime(serverTime){serverTime=serverTime||Date.now();var now=new Date(serverTime),yyyy=now.getFullYear(),MM=now.getMonth(),dd=now.getDate(),today=new Date(yyyy,MM,dd,0,0,0);$scope.todayStartTime=today.getTime()}function getData(){var http;http=first?SimulateService.getSimSaleStrategy():SimulateService.getSimSaleStrategyOfMemcache(),first=!1,http.then(function(res){var data=res.data;if(100==data.code){tradeData=data.data;var stocks=getNeedStocks(tradeData);""!=stocks&&stocks||(X.loading.hide(),$scope.dataList=[]),StockService.getStockInfo(stocks).then(function(res){var data=res.data;100==data.code?(quoteData=data.data,processData()):initNoDataQuote()})["catch"](function(){X.tip("服务器请求异常")})}else X.tip(data.resultMsg)})["catch"](function(){X.tip("服务器请求异常")})}function sale(tradeID){return $scope.isInTradeTime?(X.loading.show(),void SimulateService.closeSimStrategy(tradeID).then(function(res){var data=res.data;100==data.code?X.tip("点卖策略成功"):X.tip(data.resultMsg),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")})):void X.tip("非交易时间不能交易")}function initNoDataQuote(){$scope.dataIsLoad=!0,isOK=!0,X.loading.hide();var dataList=tradeData;$.each(dataList,function(i,item){item.quotePrice=0,item.lastClosePrice=0,item.profit=0}),$scope.dataList=dataList}function processData(){if($scope.dataIsLoad=!0,isOK=!0,X.loading.hide(),null==tradeData||null==quoteData)return void($scope.dataList=[]);var dataList=tradeData;$.each(dataList,function(i,item){var quote=quoteData[item.stockCode];item.quotePrice=quote?quote.newPrice:0,item.lastClosePrice=quote.lastClosePrice,0!=item.buyPriceDeal&&0!=item.quotePrice&&0!=item.volumeHold?item.profit=(item.quotePrice-item.buyPriceDeal)*item.volumeHold:item.profit=(item.lastClosePrice-item.buyPriceDeal)*item.volumeHold}),$scope.dataList=dataList}function getNeedStocks(dataList){var stocksObj={},stocks="",arr=[];$.each(dataList,function(i,item){stocksObj[item.stockCode]=item.stockCode});for(var key in stocksObj)arr.push(key);return stocks=arr.length>0?arr.join(","):""}function clearTimer(){timer&&($interval.cancel(timer),timer=void 0)}var timer,first=!0,tradeData=null,quoteData=null,isOK=!1;$scope.tradeState={1:"等待接单",2:"正在委托买入",3:"正在委托买入",4:"点卖",5:"正在委托卖出",6:"正在委托卖出",7:"正在清算",8:"已清算"},$scope.dataList=[],$scope.dataMap={},$scope.unHanldHoldDeferCharge=0,$scope.tradingDeferCharge=0,$scope.dataIsLoad=!1,$scope.isInTradeTime=!1,$scope.isInJJPeriod=!0,$scope.isInDYFShowTime=!1,$scope.isHoliday=!0,$scope.todayStartTime=0,$scope.showMenu=!1,X.loading.show(),$q.all({trade:SimulateService.initSimTrade(),simAsset:SimulateService.getSimAsset()}).then(function(res){var tradeData=res.trade.data,simAssetData=res.simAsset.data;if(100==tradeData.code&&100==simAssetData.code){var data=tradeData.data;$scope.simAsset=simAssetData.data.split(";"),"null"==$scope.simAsset[1]&&($scope.simAsset[1]=0);var strRisk=JSON.parse(data.strategyRisk);$scope.isHoliday=data.isHoliday;var holiday=SystemService.parseHoliday(data.holidays),tradeTime=SystemService.parsePeriod(strRisk.tradingTimeLimit.value);SystemService.setCurrentTime(data.nowTime),SystemService.setCurrentCurrencyType("CNY"),SystemService.setHoliday(holiday),SystemService.setTradePeriod(tradeTime),$scope.isInTradeTime=SystemService.isInPeriod("STOCK","trade"),$scope.isInJJPeriod=SystemService.isInJJPeriod(),initTodayStartTime(data.nowTime),startTimer()}else 900==tradeData.code?X.dialog.alert(tradeData.resultMsg,{notify:function(){$scope.$apply(function(){$location.url("/index")})}}):100!=tradeData.code?X.tip(tradeData.resultMsg):100!=simAssetData.code&&X.tip(simAssetData.resultMsg);X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")}),$scope.sale=function(trade){var html='<div class="mod-sale-confirm-wrap">';html+='<div class="item">股票名称:<span class="fr">'+trade.stockName+"</span></div>",html+='<div class="item">股票代码:<span class="fr">'+trade.stockCode.substr(-6)+"</span></div>",html+='<div class="item">委托价格:<span class="fr">市价</span></div>',html+='<div class="item">卖出数量:<span class="fr">'+trade.volumeHold+"股</span></div>",html+='<div class="item">持仓天数:<span class="fr">'+trade.holdDays+"天</span></div>",html+=trade.profit>0?'<div class="item">浮动盈亏:<span class="fr txt-red">+'+trade.profit.toFixed(2)+"元</span></div>":trade.profit<0?'<div class="item">浮动盈亏:<span class="fr txt-green">'+trade.profit.toFixed(2)+"元</span></div>":'<div class="item">浮动盈亏:<span class="fr">'+trade.profit.toFixed(2)+"元</span></div>",html+='<div class="item"><label><input id="agreeDefer" type="checkbox" checked> 是否递延指令</label></div>',html+='<div class="txt-grey txt-s12">注：点卖指令可能因跌停导致无法成交，默认至下一个交易日挂单交易。浮动盈亏仅供参考，具体以实际成交为准。</div>',html+="</div>",X.dialog.confirm(html,{title:"点卖确认",notify:function(nt){1==nt&&sale(trade.id)}})},$scope.showPartDeal=function(trade){var list=trade.tradingRecordList,volumeDeal=trade.volumeHold,table="";table+="<table>",table+='<tr><td>成交时间</td><td>数量</td><td class="txt-right">价格</td></tr>';for(var i=0;i<list.length;i++){var obj=list[i];table+="<tr><td>"+X.formatDate(new Date(obj.time),"Y-M-D")+"</td><td>"+obj.amount+'</td><td class="txt-right">'+obj.price.toFixed(2)+"</td></tr>",volumeDeal+=obj.amount}table+="</table>";var tipHtml='<div class="info">行情波动过大，造成部分成交，原持有数量'+volumeDeal+"股，现剩余"+trade.volumeHold+"股，请处理剩余数量，以便结算！</div>";X.dialog.alert('<div class="mod-part-deal-wrap">'+tipHtml+table+"</div>")},$scope.$on("$destroy",function(){clearTimer()})}),myControllers.controller("SimulateTradeResultCtrl",function($scope,$location,$q,SimulateService){$scope.settleList=[],X.loading.show(),$q.all({simSettleStrategy:SimulateService.getSimSettleStrategy(),simAsset:SimulateService.getSimAsset()}).then(function(res){var simSettleStrategyData=res.simSettleStrategy.data,simAssetData=res.simAsset.data;100==simSettleStrategyData.code&&100==simAssetData.code?($scope.settleList=simSettleStrategyData.data,$scope.simAsset=simAssetData.data.split(";"),"null"==$scope.simAsset[1]&&($scope.simAsset[1]=0)):900==simAssetData.code?X.dialog.alert(simAssetData.resultMsg,{notify:function(){$scope.$apply(function(){$location.url("/index")})}}):100!=simSettleStrategyData.code?X.tip(simSettleStrategyData.resultMsg):100!=simAssetData.code&&X.tip(simAssetData.resultMsg),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")}),$scope.toDetail=function(tradeID){$location.url("/simulateTradeDetail/"+tradeID)}}),myControllers.controller("SimulateTradeDetailCtrl",function($scope,$q,$routeParams,$location,SimulateService){var tradeId=$routeParams.tradeId;return/^\d+$/.test(tradeId)?($scope.trade={},X.loading.show(),void $q.all({tradeInfo:SimulateService.getSimAgreementStrategyById(tradeId)}).then(function(res){var tradeInfoData=res.tradeInfo.data;100==tradeInfoData.code?$scope.trade=tradeInfoData.data:X.tip(tradeInfoData.resultMsg),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")})):void $location.path("/index")}),myControllers.controller("AttentionCtrl",function($scope,$location){$scope.showHeader=!0;var source=$location.search().source;source&&"IOSAPP"==source&&($scope.showHeader=!1)}),myControllers.controller("ExtensionCtrl",function($scope,$q,$location,$anchorScroll,UserService){function init(data){var list=data.dataList;if($scope.pageIndex=data.pageIndex,$scope.totalPage=data.totalPage,$scope.tradeCount=data.tradeCount,$scope.totalUserCount=data.totalUserCount,0==$scope.totalPage)return $scope.showNoData=!0,!1;for(var i in list)list[i].registerTime=X.formatDate(list[i].registerTime);1==$scope.pageIndex?$scope.list=list:$scope.list=$scope.list.concat(list)}var pageSize=10;$scope.type="detail",$scope.showNoData=!1;var ratio=0;X.loading.show(),$q.all({getGeneralizeInfo:UserService.getGeneralizeInfo()}).then(function(res){var extenData=res.getGeneralizeInfo.data;100==extenData.code?($scope.extenInfo=extenData.data,ratio=$scope.extenInfo.ratio,$scope.codeInfo="/home/generalize/getQRcode.json?device=1",X.clipboard.init()):X.tip(extenData.resultMsg),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")}),$scope.getUsers=function(page){return $scope.type="user",0==ratio?void $location.url("/login?goURL=/extension"):(X.loading.show(),void UserService.getGeneralizeUsers(page,pageSize).then(function(res){var users=res.data;if(100==users.code){var usersData=users.data;init(usersData)}else X.tip(users.resultMsg);X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")}))},$scope.getList=function(page){page=page||1,getUsers(page)}}),myControllers.controller("PhoneBind1Ctrl",function($scope,$q,$location,$interval,UserService,SystemService){function timerFn(){timer=setInterval(function(){$scope.time>0?$scope.$apply(function(){$scope.time--}):timer&&clearTimeout(timer)},1e3)}function changeBtnTimer(){changeTimer=$interval(function(){$scope.btnState="disable",$scope.btnDisabled=!0,6==$scope.checkCode.length?($scope.btnState="orange",$scope.btnDisabled=!1):($scope.btnState="disable",$scope.btnDisabled=!0)},100)}function clearTimer(){$scope.time=0,timer&&clearTimeout(timer),changeTimer&&$interval.cancel(changeTimer),changeTimer=timer=null}var timer=null,changeTimer=null;$scope.user={},$scope.time=0,$scope.temptimes=Date.now(),$scope.checkCode="",$scope.imgCode="",$scope.showCodeDialog=!1,X.loading.show(),$q.all({userInfo:UserService.getUserInfo()}).then(function(res){var userInfoData=res.userInfo.data;100==userInfoData.code?$scope.user=userInfoData.data:X.tip(userInfoData.resultMsg),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")}),$scope.clickNumber=function(){$scope.cellPhone=SystemService.cellPhoneNumber()},$scope.toNext=function(){return/^\d{6}$/.test($scope.checkCode)?(X.loading.show(),void UserService.unbindMobile($scope.checkCode).then(function(res){var data=res.data;100==data.code?$location.path("/phoneBind2"):X.tip(data.resultMsg),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")})):(X.dialog.alert("验证码输入错误"),!1)},$scope.getImgCode=function(){$scope.showCodeDialog=!0},$scope.sendCode=function(){return""==$scope.imgCode?(X.tip("请输入图片验证码"),!1):/^\d{4}$/.test($scope.imgCode)?(X.loading.show(),void UserService.mobileUnbindCode($scope.imgCode).then(function(res){var data=res.data;100==data.code?(X.dialog.alert("验证码发送成功，请注意查收短信"),$scope.closeDialog(),$scope.time=60,timerFn()):101==data.code?(X.dialog.alert("验证码发送成功，请注意查收短信"),$scope.time=data.data.interval,$scope.closeDialog(),timerFn()):X.tip(data.resultMsg),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")})):(X.tip("图片验证码输入错误"),4==$scope.imgCode&&$scope.refreshCode(),!1)},$scope.refreshCode=function(){$scope.temptimes=Date.now()},$scope.closeDialog=function(){$scope.showCodeDialog=!1},$scope.$on("$destroy",function(){clearTimer()}),changeBtnTimer()}),myControllers.controller("PhoneBind2Ctrl",function($scope,$q,$routeParams,$location,$interval,UserService){function timerFn(){timer=setInterval(function(){$scope.time>0?$scope.$apply(function(){$scope.time--}):timer&&clearTimeout(timer)},1e3)}function changeBtnTimer(){changeTimer=$interval(function(){$scope.btnState="disable",$scope.btnDisabled=!0,11==$scope.mobile.length&&6==$scope.checkCode.length?($scope.btnState="orange",$scope.btnDisabled=!1):($scope.btnState="disable",$scope.btnDisabled=!0)},100)}function clearTimer(){$scope.time=0,timer&&clearTimeout(timer),changeTimer&&$interval.cancel(changeTimer),changeTimer=timer=null}var timer=null,changeTimer=null;$scope.mobile="",$scope.time=0,$scope.checkCode="",$scope.oldMobile="",$scope.temptimes=Date.now(),$scope.imgCode="",$scope.showCodeDialog=!1,X.loading.show(),$q.all({userInfo:UserService.getUserInfo()}).then(function(res){var userInfoData=res.userInfo.data;100==userInfoData.code?$scope.oldMobile=userInfoData.data.loginMobileNoHidden:X.tip(userInfoData.resultMsg),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")}),$scope.bind=function(){return X.isMobile($scope.mobile)?/^\d{6}$/.test($scope.checkCode)?(X.loading.show(),void UserService.bindMobile($scope.checkCode,$scope.mobile).then(function(res){var data=res.data;100==data.code?X.dialog.alert("手机绑定成功",{notify:function(){$location.path("myHome")}}):X.tip(data.resultMsg),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")})):(X.dialog.alert("验证码输入错误"),!1):(X.dialog.alert("手机号码输入错误"),!1)},$scope.getImgCode=function(){return""==$scope.mobile?(X.tip("请输入手机号码"),!1):X.isMobile($scope.mobile)?void($scope.showCodeDialog=!0):(X.tip("手机号码输入错误"),!1)},$scope.sendCode=function(){return""==$scope.mobile?(X.tip("请输入手机号码"),!1):X.isMobile($scope.mobile)?""==$scope.imgCode?(X.tip("请输入图片验证码"),!1):/^\d{4}$/.test($scope.imgCode)?$scope.mobile==$scope.oldMobile?(X.tip("新手机号码不能和旧手机号相同"),$scope.closeDialog(),$scope.refreshCode(),!1):(X.loading.show(),void UserService.mobileBindCode($scope.imgCode,$scope.mobile).then(function(res){var data=res.data;100==data.code?($scope.closeDialog(),X.tip("验证码已发送至手机，请注意查收"),$scope.time=60,timerFn()):101==data.code?($scope.closeDialog(),X.tip("验证码已发送至手机，请注意查收"),$scope.time=data.data.interval,timerFn()):(X.tip(data.resultMsg),$scope.closeDialog(),$scope.refreshCode()),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")})):(X.tip("图片验证码输入错误"),4==$scope.imgCode&&$scope.refreshCode(),!1):(X.tip("手机号码输入错误"),!1)},$scope.closeDialog=function(){$scope.showCodeDialog=!1,$scope.imgCode=""},$scope.refreshCode=function(){$scope.temptimes=Date.now()},$scope.sendCode=function(){return""==$scope.mobile?(X.tip("请输入手机号码"),!1):X.isMobile($scope.mobile)?""==$scope.imgCode?(X.tip("请输入图片验证码"),!1):/^\d{4}$/.test($scope.imgCode)?$scope.mobile==$scope.oldMobile?(X.tip("新手机号码不能和旧手机号相同"),$scope.closeDialog(),$scope.refreshCode(),!1):(X.loading.show(),void UserService.mobileBindCode($scope.imgCode,$scope.mobile).then(function(res){var data=res.data;100==data.code?(X.dialog.alert("验证码发送成功，请注意查收短信"),$scope.closeDialog(),$scope.time=60,timerFn()):101==data.code?(X.dialog.alert("验证码发送成功，请注意查收短信"),$scope.closeDialog(),$scope.time=data.data.interval,timerFn()):(X.dialog.alert(data.resultMsg),$scope.closeDialog(),$scope.refreshCode()),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")})):(X.tip("图片验证码输入错误"),4==$scope.imgCode&&$scope.refreshCode(),!1):(X.tip("手机号码输入错误"),!1)},$scope.$on("$destroy",function(){clearTimer()}),changeBtnTimer()}),myControllers.controller("DiscoverCtrl",function($scope,$sce,NoticeService){var pageSize=10,id=0;$scope.currPage=1,$scope.totalPage=1,$scope.currNoticeIndex=0,$scope.getNoticeList=function(page){NoticeService.getNotices(page,pageSize).then(function(res){var noticeList,noticeData,data=res.data;noticeData=data.data,$scope.currPage=data.data.pageIndex,$scope.totalPage=data.data.totalPage,100==data.code?(noticeList=data.data.items,1==page?$scope.noticeList=noticeList:$scope.noticeList=$scope.noticeList.concat(noticeList)):X.tip(data.resultMsg);for(var i in $scope.noticeList)$scope.noticeList[i].noticeContent=$sce.trustAsHtml('<p style="word-break: break-all">'+$scope.noticeList[i].noticeContent+"</p>"),$scope.noticeList[i].id=id,id++})["catch"](function(){X.tip("服务器请求异常")})},$scope.getNoticeList($scope.currPage),$scope.showCurrNotice=function(currId){$scope.currNoticeIndex==currId?$scope.currNoticeIndex=-1:$scope.currNoticeIndex=currId}}),myControllers.controller("DayGainListCtrl",function($scope,$sce,$location,RankService){function getRankData(type){RankService.getRank(type).then(function(res){var data=res.data;100==data.code?$scope.rankList=data.data:X.tip(data.resultMsg)})["catch"](function(){X.tip("服务器请求异常")})}var type=$location.search().type||"month";$scope.type=type,$scope.txtObj={day:{title:"昨日盈利榜",gainTxt:"盈利(元)"},month:{title:"佣金收入榜",gainTxt:"总收入(元)"}},$scope.rankList=[],"day"==type?getRankData(type):"month"==type&&getRankData(type)}),myControllers.controller("ActivityCenterCtrl",function($scope,$q,$location,$anchorScroll,ActivityService){$scope.activityList=[],ActivityService.getActivityListData().then(function(res){var data=res.data;100==data.code&&data.data?(data.data.forEach(function(item){item.bannerUrl=item.bannerUrl.split(",")}),$scope.activityList=data.data):$scope.activityList=[]})["catch"](function(){X.tip("服务器请求异常")}),$scope.goURL=function(id){$location.url("/actPacket?activityId="+id)}}),myControllers.controller("ActPacketCtrl",function($scope,$location,$swipe,StockService,PacketService){function TipInfo(id){X.loading.show(),PacketService.getPacketInfoData(id).then(function(res){var data=res.data;100==data.code?actPacketData(data.data):X.tip(data.resultMsg),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")})}function actPacketData(data){data.forEach(function(item){$scope.TipInfo[item.title]=item})}var activityId=$location.search().activityId;$scope.TipInfo={},$scope.receivePacket=function(item){if(1!=item.status)return!1;X.loading.show();var params={title:item.title,money:item.value,awardLogId:item.awardLogId};PacketService.receivePacketData(params).then(function(res){var data=res.data;100==data.code?(X.tip("领取成功"),TipInfo(activityId)):X.tip(data.resultMsg),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")})},$scope.goURL=function(name,status){if("ZCHB"==name&&0==status)$location.url("/register1?backURL=#/actPacket?activityId="+activityId);else if("MNJY"==name&&0==status)$location.url("/simulateStock?backURL=#/actPacket?activityId="+activityId);else if("SCCZ"==name&&0==status)$location.url("/payType?backURL=#/actPacket?activityId="+activityId);else if("SPJY"==name&&0==status)$location.url("/trade?backURL=#/actPacket?activityId="+activityId);else{if("SMRZ"!=name||0!=status)return;$location.url("/identification?backURL=#/actPacket?activityId="+activityId)}},TipInfo(activityId)}),myControllers.controller("MyPacketCtrl",function($scope,$rootScope,$q,$location,LoginService,UserService,AuthService,PacketService){$scope.packetFund={},$scope.packetRecord=[],$scope.packetTitle={ZCHB:["新注册用户送红包"],MNJY:["完成模拟交易5次送红包"],SCCZ:["首次充值送红包"],SPJY:["实盘交易送红包"],SMRZ:["完成实名认证送红包"],JYZHF:["实盘交易综合费返还","实盘交易综合费抵扣"]},$scope.pageIndex=1,$scope.totalPage=1,X.loading.show(),$q.all({packetFund:PacketService.getPacketFundInfoData()}).then(function(res){var packetFund=res.packetFund.data;100==packetFund.code?($scope.packetFund=packetFund.data,$scope.getPacketRecordList($scope.pageIndex)):100!=packetFund.code&&X.tip(packetFund.resultMsg),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")}),$scope.getPacketRecordList=function(){X.loading.show(),PacketService.getPacketRecordListData().then(function(res){var data=res.data;100==data.code?$scope.items=data.data.items:X.tip(data.resultMsg),X.loading.hide()})["catch"](function(){X.tip("服务器请求异常")})}});var myServices=angular.module("myServices",[]);myServices.factory("URLService",function(){var baseHost="",urls={login:"/sso/yztz_user_login_check.json",logout:"/sso/j_spring_security_logout.json",getUserInfo:"/user/userInfo/getUserInfo.json",getIndexData:"/index/getIndexData.json",getServerTime:"/home/currentTime.json",stockServer:"/stock/servlet/StockServlet.htm",checkMobile:"/sso/register/checkMobile.json",regNextStep:"/sso/register/goNextStep.json",getRegisterCode:"/sso/register/getRegisterCode.json",doRegister:"/sso/register/doRegisterNew.json",resetForgetPassword:"/sso/forget/resetForgetPassword.json",forgetCheckLogin:"/sso/forget/checkLogin.json",getRiskStock:"/home/getRiskStock.json",initTrade:"/home/strategy/index.json",getStockStatisticsInfo:"/trade/strategy/getStockStatisticsInfo.json",createTrade:"/trade/strategy/create.json",getSaleStrategyByPage:"/trade/strategy/getSaleStrategyByPage.json",getSaleStrategyOfMemcache:"/trade/strategy/getSaleStrategyOfMemcache.json",getSaleStrategyById:"/trade/strategy/getSaleStrategyById.json",getSettleStrategyByPage:"/trade/strategy/getSettleStrategyByPage.json",getSettleStrategyById:"/trade/strategy/getSettleStrategyById.json",closeStrategy:"/trade/strategy/closeStrategy.json",getMsgPage:"/user/messager/getMsgPage.json",postMsg:"/user/messager/postMsg.json",signAgreement:"/user/userInfo/signAgreement.json",getAgreementStrategyById:"/trade/strategy/getAgreementStrategyById.json",getBalance:"/pay/global/assets/getBalance.json",getDelayBalance:"/trade/strategy/getPayableDeferCharge.json",getBankInfo:"/home/getBankInfo.json",getBankCards:"/pay/bankCard/getBankCards.json",getBankCardInfo:"/pay/bankCard/getBankCardInfo.json",bindBankCard:"/pay/bankCard/bindBankCard.json",delBankCard:"/pay/bankCard/deleteCard.json",setDefaultBankCard:"/pay/bankCard/setDefaultCard.json",updateCardInfo:"/pay/bankCard/updateCardInfo.json",getBankCardById:"/pay/bankCard/getBankCardById.json",sendForgetCode:"/sso/forget/sendForgetCode.json",doWithdraw:"/pay/withdraw/doWithdraw.json",updateRealname:"/user/security/updateRealname.json",loginPwdModify:"/user/security/loginPwdModify.json",withdrawPwdSet:"/user/security/withdrawPwdSet.json",withdrawPwdModify:"/user/security/withdrawPwdModify.json",getSubBank:"/pay/bankCard/getSubBank.json",getFundDetail:"/pay/user/fundDetail/getFundDetail.json",getFundAll:"/pay/user/fundDetail/getFundAll.json",getNoticeList:"/index/getNoticeList.json",forgetWithdrawPasswordCode:"/user/security/forgetWithdrawPasswordCode.json",resetWithdrawPwd:"/user/security/resetWithdrawPwd.json",getNoticeById:"/index/getNoticeById.json",h5FirstPayUrl:"/pay/payGateway/h5FirstPayUrl.json",h5PayUrl:"/pay/payGateway/h5PayUrl.json",payGateway:"/pay/payGateway/getHCPayUrl.json",alipay:"/pay/alipay.json",getHeader:"/home/header.json",initTDTrade:"/home/scheme/index.json",createTDTrade:"/trade/scheme/create.json",strategyCreate:"/trade/scheme/strategyCreate.json",TDGetSaleStrategy:"/trade/scheme/getSaleStrategy.json",TDGetSettleStrategyByPage:"/trade/scheme/getSettleStrategyByPage.json",getHistorySchemes:"/trade/scheme/getHistorySchemes.json",schemeAddMoneyInitiate:"/trade/scheme/schemeAddMoneyInitiate.json",addMoney:"/trade/scheme/addMoney.json",addPrincipal:"/trade/scheme/addPrincipal.json",applicationLiquidationScheme:"/trade/scheme/applicationLiquidationScheme.json",extendSchemeInitiate:"/trade/scheme/extendSchemeInitiate.json",extendScheme:"/trade/scheme/extendScheme.json",getTakeOverStrategy:"/trade/strategy/getTakeOverStrategy.json",getHoldingScheme:"/trade/scheme/getHoldingScheme.json",getStrategyMarketValue:"/scheme/getStrategyMarketValue.json",TDGetSaleStrategyOfMemcache:"/trade/scheme/getSaleStrategyOfMemcache.json",takeOverStrategy:"/trade/strategy/takeOverStrategy.json",TDCloseStrategy:"/trade/scheme/closeStrategy.json",takeOverInitiate:"/trade/strategy/takeOverInitiate.json",initOneyuan:"/home/experience/strategy/index.json",oneYuanCreate:"/trade/experience/strategy/create.json",oneYuanCloseStrategy:"/trade/strategy/closeStrategy.json",oneYuanGetSaleStrategy:"/trade/experience/strategy/getSaleStrategy.json",oneYuanGetSaleStrategyByMemca:"/trade/experience/strategy/getSaleStrategyByMemca.json",oneYuanGetSettleStrategy:"/trade/experience/strategy/getSettleStrategy.json",oneYuanGetSettleStrategyById:"/trade/strategy/getSettleStrategyById.json",oneYuanGetAgreementStrategyById:"/trade/strategy/getAgreementStrategyById.json",bindingAlipayAccount:"/user/security/bindingAlipayAccount.json",simSpecial:"/simstrategy/special.json",getUserRanks:"/simstrategy/getUserRanks.json",getMatchInfo:"/simstrategy/getMatchInfo.json",joinStrategyComp:"/trade/simstrategy/joinStrategyComp.json",getSimAsset:"/trade/simstrategy/getSimAsset.json",simIndex:"/trade/simstrategy/index.json",getUserDetailInfo:"/simstrategy/getUserDetailInfo.json",initSimTrade:"/trade/simstrategy/index.json",createSimTrade:"/trade/simstrategy/create.json",getSimSaleStrategy:"/trade/simstrategy/getSaleStrategy.json",closeSimStrategy:"/trade/simstrategy/closeStrategy.json",getSimSaleStrategyOfMemcache:"/trade/simstrategy/getSaleStrategyOfMemcache.json",getSimSettleStrategy:"/trade/simstrategy/getSettleStrategy.json",getSimAgreementStrategyById:"/trade/simstrategy/getAgreementStrategyById.json",getSimStockStatisticsInfo:"/trade/simstrategy/getStockStatisticsInfo.json",getGeneralizeInfo:"/home/generalize/getGeneralizeInfo.json",getGeneralizeUsers:"/home/generalize/getGeneralizeUsers.json",getQRcode:"/home/generalize/getQRcode.json",getTradingInfo:"/index/getTradingStrategies.json",mobileUnbindCode:"/user/security/mobileUnbindCode.json",unbindMobile:"/user/security/unbindMobile.json",mobileBindCode:"/user/security/mobileBindCode.json",bindMobile:"/user/security/bindMobile.json",cancelWithdraw:"/pay/withdraw/cancelWithdraw.json",getNotices:"/index/getNotices.json",getStrategyWeekData:"/index/getStrategyWeekData.json",getUserRank:"/index/getUserRank.json",getUnionRank:"/union/getUnionRank.json",getPacketInfo:"/activity/getActAwardSetInfo.json",receivePacket:"/tip/receiveTipByActivity.json",getPacketRecordList:"/tip/getTipRecord.json",getPacketFundInfo:"/tip/getTipFundInfo.json",getNewsList:"/index/getFuturesNews.json",getActivityList:"/activity/getActivityInfo.json",getWaitPayDeferForRemind:"/trade/strategy/getWaitPayDeferForRemind.json"};return{getURL:function(method){return baseHost+urls[method]}}}),myServices.factory("IndexService",function($http,URLService){return{indexData:function(){var params={device:1};return $http({method:"GET",url:URLService.getURL("getIndexData"),params:params})},getTradingInfo:function(){var params={device:1};return $http({method:"GET",url:URLService.getURL("getTradingInfo"),params:params})},getStrategyWeekData:function(){var params={device:1};return $http({method:"GET",url:URLService.getURL("getStrategyWeekData"),params:params})}}}),myServices.factory("LoginService",function($http,$httpParamSerializerJQLike,URLService){
return{login:function(username,password){var data={authencationType:"AJAX",device:1,remeber:!0,entrance:"",username:username,password:password};return $http({method:"POST",url:URLService.getURL("login"),data:$httpParamSerializerJQLike(data)})},logout:function(){var data={device:1};return $http({method:"POST",url:URLService.getURL("logout"),data:$httpParamSerializerJQLike(data)})}}}),myServices.factory("RegisterService",function($http,$httpParamSerializerJQLike,URLService){return{checkMobile:function(mobile){var data={device:1,mobile:mobile};return $http({method:"POST",url:URLService.getURL("checkMobile"),data:$httpParamSerializerJQLike(data)})},regNextStep:function(mobile,checkCode){var data={device:1,mobile:mobile,checkCode:checkCode};return $http({method:"POST",url:URLService.getURL("regNextStep"),data:$httpParamSerializerJQLike(data)})},doRegister:function(mobile,username,password){var data={device:1,type:1,password:password,mobile:mobile,username:username};return $http({method:"POST",url:URLService.getURL("doRegister"),data:$httpParamSerializerJQLike(data)})},getRegisterCode:function(mobile,checkCode){var data={device:1,type:2,mobile:mobile,checkCode:checkCode};return $http({method:"POST",url:URLService.getURL("getRegisterCode"),data:$httpParamSerializerJQLike(data)})}}}),myServices.factory("PasswordService",function($http,$httpParamSerializerJQLike,URLService){return{resetForgetPassword:function(mobile,checkCode,password){var data={device:1,mobile:mobile,checkCode:checkCode,password:password};return $http({method:"POST",url:URLService.getURL("resetForgetPassword"),data:$httpParamSerializerJQLike(data)})},sendForgetCode:function(mobile,checkCode){var data={device:1,type:2,mobile:mobile,checkCode:checkCode};return $http({method:"POST",url:URLService.getURL("sendForgetCode"),data:$httpParamSerializerJQLike(data)})},loginPwdModify:function(oldPassword,newPassword){var data={device:1,newPassword:newPassword,oldPassword:oldPassword};return $http({method:"POST",url:URLService.getURL("loginPwdModify"),data:$httpParamSerializerJQLike(data)})},PwdSet:function(password){var data={device:1,password:password};return $http({method:"POST",url:URLService.getURL("withdrawPwdSet"),data:$httpParamSerializerJQLike(data)})},PwdModify:function(newPwd,oldPwd){var data={device:1,newPassword:newPwd,oldPassword:oldPwd};return $http({method:"POST",url:URLService.getURL("withdrawPwdModify"),data:$httpParamSerializerJQLike(data)})},resetWithdrawPwd:function(password,checkCode){var data={device:1,password:password,checkCode:checkCode};return $http({method:"POST",url:URLService.getURL("resetWithdrawPwd"),data:$httpParamSerializerJQLike(data)})},sendPasswordCode:function(){var data={device:1,useVoice:!1};return $http({method:"POST",url:URLService.getURL("forgetWithdrawPasswordCode"),data:$httpParamSerializerJQLike(data)})}}}),myServices.factory("UserService",function($http,$httpParamSerializerJQLike,$q,URLService){return{getUserInfo:function(){var data={device:1};return $http({method:"POST",url:URLService.getURL("getUserInfo"),data:$httpParamSerializerJQLike(data)})},getBalance:function(){var data={device:1};return $http({method:"POST",url:URLService.getURL("getBalance"),data:$httpParamSerializerJQLike(data)})},getDelayBalance:function(){var params={device:1};return $http({method:"GET",url:URLService.getURL("getDelayBalance"),params:params})},bindingAlipayAccount:function(alipayAccount,tradeAmount,tradeNo){var data={device:1,alipayAccount:alipayAccount,tradeNo:tradeNo,tradeAmount:tradeAmount};return $http({method:"POST",url:URLService.getURL("bindingAlipayAccount"),data:$httpParamSerializerJQLike(data)})},getStrategyMarketValue:function(){var params={device:1};return $http({method:"GET",url:URLService.getURL("getStrategyMarketValue"),params:params})},getBankInfo:function(){var params={device:1};return $http({method:"GET",url:URLService.getURL("getBankInfo"),params:params})},getBankCardInfo:function(){var data={device:1};return $http({method:"POST",url:URLService.getURL("getBankCardInfo"),data:$httpParamSerializerJQLike(data)})},getBankCards:function(){var data={device:1};return $http({method:"POST",url:URLService.getURL("getBankCards"),data:$httpParamSerializerJQLike(data)})},getBankCardById:function(bankCardId){var data={device:1,cardId:bankCardId};return $http({method:"POST",url:URLService.getURL("getBankCardById"),data:$httpParamSerializerJQLike(data)})},bindBankCard:function(bank,province,city,branch,bankCard){var data={device:1,bank:bank,province:province,city:city,branch:branch,bankCard:bankCard};return $http({method:"POST",url:URLService.getURL("bindBankCard"),data:$httpParamSerializerJQLike(data)})},updateCardInfo:function(id,bank,province,city,branch){var data={device:1,bank:bank,province:province,city:city,branch:branch,id:id};return $http({method:"POST",url:URLService.getURL("updateCardInfo"),data:$httpParamSerializerJQLike(data)})},setDefaultBankCard:function(bankCardId){var data={device:1,cardId:bankCardId};return $http({method:"POST",url:URLService.getURL("setDefaultBankCard"),data:$httpParamSerializerJQLike(data)})},delBankCard:function(bankCardId){var data={device:1,cardId:bankCardId};return $http({method:"POST",url:URLService.getURL("delBankCard"),data:$httpParamSerializerJQLike(data)})},getSubBank:function(bank,province,city){var data={device:1,bankName:bank,province:province,city:city};return $http({method:"POST",url:URLService.getURL("getSubBank"),data:$httpParamSerializerJQLike(data)})},realName:function(name,IDNum){var data={device:1,name:name,idNumber:IDNum};return $http({method:"POST",url:URLService.getURL("updateRealname"),data:$httpParamSerializerJQLike(data)})},getMsgPage:function(page,pageSize){var data={device:1,page:page||1,pageSize:pageSize||10};return $http({method:"POST",url:URLService.getURL("getMsgPage"),data:$httpParamSerializerJQLike(data)})},postMsg:function(type,contact,content){var data={device:1,type:type,contact:contact,content:content};return $http({method:"POST",url:URLService.getURL("postMsg"),data:$httpParamSerializerJQLike(data)})},signAgreement:function(){var data={device:1};return $http({method:"POST",url:URLService.getURL("signAgreement"),data:$httpParamSerializerJQLike(data)})},getHeader:function(){var params={device:1};return $http({method:"GET",url:URLService.getURL("getHeader"),params:params})},getGeneralizeInfo:function(){var data={device:1};return $http({method:"POST",url:URLService.getURL("getGeneralizeInfo"),data:$httpParamSerializerJQLike(data)})},getGeneralizeUsers:function(page,pageSize){var data={device:1,page:page,pageSize:pageSize};return $http({method:"POST",url:URLService.getURL("getGeneralizeUsers"),data:$httpParamSerializerJQLike(data)})},mobileUnbindCode:function(checkCode){var data={device:1,checkCode:checkCode};return $http({method:"POST",url:URLService.getURL("mobileUnbindCode"),data:$httpParamSerializerJQLike(data)})},unbindMobile:function(code){var data={device:1,checkCode:code};return $http({method:"POST",url:URLService.getURL("unbindMobile"),data:$httpParamSerializerJQLike(data)})},mobileBindCode:function(checkCode,mobile){var data={device:1,mobile:mobile,checkCode:checkCode};return $http({method:"POST",url:URLService.getURL("mobileBindCode"),data:$httpParamSerializerJQLike(data)})},bindMobile:function(code,mobile){var data={device:1,checkCode:code,mobile:mobile};return $http({method:"POST",url:URLService.getURL("bindMobile"),data:$httpParamSerializerJQLike(data)})}}}),myServices.factory("PayService",function($http,$httpParamSerializerJQLike,URLService){return{getFundDetail:function(action,explain,page,pageSize){var data={device:1,action:action,timeStart:"1year",explain:explain,page:page||1,pageSize:pageSize||20};return $http({method:"POST",url:URLService.getURL("getFundDetail"),data:$httpParamSerializerJQLike(data)})},getFundAll:function(action,page,pageSize){var data={device:1,action:action,timeStart:"1year",page:page||1,pageSize:pageSize||20};return $http({method:"POST",url:URLService.getURL("getFundAll"),data:$httpParamSerializerJQLike(data)})},h5FirstPayUrl:function(bankCode,money,card,charge){var data={device:1,bankCode:bankCode,money:money,bankCard:card,charge:charge};return $http({method:"POST",url:URLService.getURL("h5FirstPayUrl"),data:$httpParamSerializerJQLike(data)})},h5PayUrl:function(cardId,money,charge){var data={device:1,cardId:cardId,money:money,charge:charge};return $http({method:"POST",url:URLService.getURL("h5PayUrl"),data:$httpParamSerializerJQLike(data)})},payGateway:function(money){var data={device:1,money:money};return $http({method:"POST",url:URLService.getURL("payGateway"),data:$httpParamSerializerJQLike(data)})},alipay:function(money,account){var data={device:1,alipayName:account,money:money,charge:0};return $http({method:"POST",url:URLService.getURL("alipay"),data:$httpParamSerializerJQLike(data)})},doWithdraw:function(cardId,money,password){var data={device:1,cardId:cardId,money:money,password:password};return $http({method:"POST",url:URLService.getURL("doWithdraw"),data:$httpParamSerializerJQLike(data)})},cancelWithdraw:function(id){var data={device:1,id:id};return $http({method:"POST",url:URLService.getURL("cancelWithdraw"),data:$httpParamSerializerJQLike(data)})}}}),myServices.factory("NoticeService",function($http,$httpParamSerializerJQLike,URLService){return{getNoticeList:function(page,pageSize){var params={device:1,page:page||1,pageSize:pageSize||10};return $http({method:"GET",url:URLService.getURL("getNoticeList"),params:params})},getNoticeById:function(noticeId){var params={device:1,noticeId:noticeId};return $http({method:"GET",url:URLService.getURL("getNoticeById"),params:params})},getNotices:function(page,pageSize){var params={device:1,page:page||1,pageSize:pageSize||10};return $http({method:"GET",url:URLService.getURL("getNotices"),params:params})}}}),myServices.factory("TradeService",function($http,$httpParamSerializerJQLike,URLService){return{getRiskStock:function(){var params={device:1};return $http({method:"GET",url:URLService.getURL("getRiskStock"),cache:!0,params:params})},getWaitPayDeferForRemind:function(){var params={device:1};return $http({method:"GET",url:URLService.getURL("getWaitPayDeferForRemind"),params:params})},getInitTrade:function(){var data={device:1};return $http({method:"POST",url:URLService.getURL("initTrade"),data:$httpParamSerializerJQLike(data)})},createTrade:function(data){return data.device=1,$http({method:"POST",url:URLService.getURL("createTrade"),data:$httpParamSerializerJQLike(data)})},getSaleStrategyByPage:function(){var data={device:1,page:1,pageSize:100};return $http({method:"POST",url:URLService.getURL("getSaleStrategyByPage"),data:$httpParamSerializerJQLike(data)})},TDGetSaleStrategy:function(){var params={device:1};return $http({method:"GET",url:URLService.getURL("TDGetSaleStrategy"),params:params})},takeOverInitiate:function(id){var params={device:1,id:id};return $http({method:"GET",url:URLService.getURL("takeOverInitiate"),params:params})},TDGetSaleStrategyOfMemcache:function(){var params={device:1};return $http({method:"GET",url:URLService.getURL("TDGetSaleStrategyOfMemcache"),params:params})},getHoldingScheme:function(){var params={device:1};return $http({method:"GET",url:URLService.getURL("getHoldingScheme"),params:params})},strategyCreate:function(schemeId,money,serviceCharge,stockCode,volumeOrder,useTip){var data={device:1,schemeId:schemeId,money:money,serviceCharge:serviceCharge,stockCode:stockCode,volumeOrder:volumeOrder,useTip:useTip};return $http({method:"POST",url:URLService.getURL("strategyCreate"),data:$httpParamSerializerJQLike(data)})},TDGetSettleStrategyByPage:function(page,pageSize,schemeId){var params={device:1,page:page,pageSize:pageSize,schemeId:schemeId};return $http({method:"GET",url:URLService.getURL("TDGetSettleStrategyByPage"),params:params})},TDCloseStrategy:function(strategyId,isAlwaysClose){var data={device:1,strategyId:strategyId,isAlwaysClose:isAlwaysClose};return $http({method:"POST",url:URLService.getURL("TDCloseStrategy"),data:$httpParamSerializerJQLike(data)})},takeOverStrategy:function(tradeID,isTakeOver,lossPrincipal){var data={device:1,id:tradeID,isTakeOver:isTakeOver,lossPrincipal:lossPrincipal};return $http({method:"POST",url:URLService.getURL("takeOverStrategy"),data:$httpParamSerializerJQLike(data)})},getTakeOverStrategy:function(){var params={device:1};return $http({method:"GET",url:URLService.getURL("getTakeOverStrategy"),params:params})},getStrategyMarketValue:function(){var params={device:1};return $http({method:"GET",url:URLService.getURL("getStrategyMarketValue"),params:params})},getSaleStrategyOfMemcache:function(){var params={device:1};return $http({method:"POST",url:URLService.getURL("getSaleStrategyOfMemcache"),params:params})},closeStrategy:function(tradeID,isAlwaysClose){var data={device:1,id:tradeID,isAlwaysClose:isAlwaysClose};return $http({method:"POST",url:URLService.getURL("closeStrategy"),data:$httpParamSerializerJQLike(data)})},getSettleStrategyByPage:function(page,pageSize){var data={device:1,page:page||1,pageSize:pageSize||10};return $http({method:"POST",url:URLService.getURL("getSettleStrategyByPage"),data:$httpParamSerializerJQLike(data)})},getSettleStrategyById:function(tradeID){var data={device:1,strategyId:tradeID};return $http({method:"POST",url:URLService.getURL("getSettleStrategyById"),data:$httpParamSerializerJQLike(data)})},getSaleStrategyById:function(tradeID){var data={device:1,strategyId:tradeID};return $http({method:"POST",url:URLService.getURL("getSaleStrategyById"),data:$httpParamSerializerJQLike(data)})},getAgreementStrategyById:function(tradeID){var data={device:1,strategyId:tradeID};return $http({method:"POST",url:URLService.getURL("getAgreementStrategyById"),data:$httpParamSerializerJQLike(data)})},getStockStatisticsInfo:function(stockCode){var params={device:1,stockCode:stockCode};return $http({method:"GET",url:URLService.getURL("getStockStatisticsInfo"),params:params})},initTDTrade:function(){var data={device:1};return $http({method:"POST",url:URLService.getURL("initTDTrade"),data:$httpParamSerializerJQLike(data)})},createTDTrade:function(data){return data.device=1,$http({method:"POST",url:URLService.getURL("createTDTrade"),data:$httpParamSerializerJQLike(data)})},getHistorySchemes:function(page,pageSize){var params={device:1,page:page,pageSize:pageSize};return $http({method:"GET",url:URLService.getURL("getHistorySchemes"),params:params})},addPrincipal:function(id,lossPrincipal){var data={device:1,id:id,lossPrincipal:lossPrincipal};return $http({method:"POST",url:URLService.getURL("addPrincipal"),data:$httpParamSerializerJQLike(data)})},applyFinish:function(id){var data={device:1,schemeId:id};return $http({method:"POST",url:URLService.getURL("applicationLiquidationScheme"),data:$httpParamSerializerJQLike(data)})},schemeAddMoneyInitiate:function(id,money){var data={device:1,id:id,money:money};return $http({method:"POST",url:URLService.getURL("schemeAddMoneyInitiate"),data:$httpParamSerializerJQLike(data)})},addMoney:function(id,lossPrincipal,money,deferCharge){var data={deferCharge:deferCharge,device:1,id:id,lossPrincipal:lossPrincipal,money:money};return $http({method:"POST",url:URLService.getURL("addMoney"),data:$httpParamSerializerJQLike(data)})},extendSchemeInitiate:function(id,holdDays){var data={device:1,holdDays:holdDays,id:id};return $http({method:"POST",url:URLService.getURL("extendSchemeInitiate"),data:$httpParamSerializerJQLike(data)})},extendScheme:function(id,holdDays,lossPrincipal,diffBalance,deferCharge){var data={device:1,holdDays:holdDays,id:id,lossPrincipal:lossPrincipal,diffBalance:diffBalance,deferCharge:deferCharge};return $http({method:"POST",url:URLService.getURL("extendScheme"),data:$httpParamSerializerJQLike(data)})},initOneyuan:function(){var data={device:1};return $http({method:"POST",url:URLService.getURL("initOneyuan"),data:$httpParamSerializerJQLike(data)})},oneYuanCreate:function(stockCode,volumeOrder,token){var data={device:1,stockCode:stockCode,volumeOrder:volumeOrder,token:token};return $http({method:"POST",url:URLService.getURL("oneYuanCreate"),data:$httpParamSerializerJQLike(data)})},oneYuanCloseStrategy:function(id,isAlwaysClose){var data={device:1,id:id,isAlwaysClose:isAlwaysClose};return $http({method:"POST",url:URLService.getURL("oneYuanCloseStrategy"),data:$httpParamSerializerJQLike(data)})},oneYuanGetSaleStrategy:function(){var data={device:1};return $http({method:"POST",url:URLService.getURL("oneYuanGetSaleStrategy"),data:$httpParamSerializerJQLike(data)})},oneYuanGetSaleStrategyByMemca:function(){var data={device:1};return $http({method:"POST",url:URLService.getURL("oneYuanGetSaleStrategyByMemca"),data:$httpParamSerializerJQLike(data)})},oneYuanGetSettleStrategy:function(){var data={device:1};return $http({method:"POST",url:URLService.getURL("oneYuanGetSettleStrategy"),data:$httpParamSerializerJQLike(data)})},oneYuanGetSettleStrategyById:function(strategyId){var data={device:1,strategyId:strategyId};return $http({method:"POST",url:URLService.getURL("oneYuanGetSettleStrategyById"),data:$httpParamSerializerJQLike(data)})},oneYuanGetAgreementStrategyById:function(strategyId){var data={device:1,strategyId:strategyId};return $http({method:"POST",url:URLService.getURL("oneYuanGetAgreementStrategyById"),data:$httpParamSerializerJQLike(data)})}}}),myServices.factory("SimulateService",function($http,$httpParamSerializerJQLike,URLService){return{simSpecial:function(){var params={device:1};return $http({method:"GET",url:URLService.getURL("simSpecial"),params:params})},getUserRanks:function(){var params={device:1};return $http({method:"GET",url:URLService.getURL("getUserRanks"),params:params})},getMatchInfo:function(){var params={device:1};return $http({method:"GET",url:URLService.getURL("getMatchInfo"),params:params})},joinStrategyComp:function(operateType){var data={device:1,operateType:operateType};return $http({method:"POST",url:URLService.getURL("joinStrategyComp"),data:$httpParamSerializerJQLike(data)})},getSimAsset:function(){var params={device:1};return $http({method:"GET",url:URLService.getURL("getSimAsset"),params:params})},simIndex:function(){var params={device:1};return $http({method:"GET",url:URLService.getURL("simIndex"),params:params})},getUserDetailInfo:function(id){var params={device:1,userId:id};return $http({method:"GET",url:URLService.getURL("getUserDetailInfo"),params:params})},initSimTrade:function(){var params={device:1};return $http({method:"GET",url:URLService.getURL("initSimTrade"),params:params})},createSimTrade:function(data){return data.device=1,$http({method:"POST",url:URLService.getURL("createSimTrade"),data:$httpParamSerializerJQLike(data)})},getSimSaleStrategy:function(){var params={device:1};return $http({method:"GET",url:URLService.getURL("getSimSaleStrategy"),params:params})},closeSimStrategy:function(id,isAlwaysClose){var data={device:1,id:id,operateType:isAlwaysClose};return $http({method:"POST",url:URLService.getURL("closeSimStrategy"),data:$httpParamSerializerJQLike(data)})},getSimSaleStrategyOfMemcache:function(){var params={device:1};return $http({method:"GET",url:URLService.getURL("getSimSaleStrategyOfMemcache"),params:params})},getSimSettleStrategy:function(){var params={device:1};return $http({method:"GET",url:URLService.getURL("getSimSettleStrategy"),params:params})},getSimAgreementStrategyById:function(id){var params={device:1,strategyId:id};return $http({method:"GET",url:URLService.getURL("getSimAgreementStrategyById"),params:params})},getSimStockStatisticsInfo:function(code){var params={device:1,stockCode:code};return $http({method:"GET",url:URLService.getURL("getSimStockStatisticsInfo"),params:params})}}}),myServices.factory("StockService",function($http,SystemService,URLService){return{getAllStockList:function(){var params={type:"appAll",callback:"JSON_CALLBACK"};return $http({url:URLService.getURL("stockServer"),method:"JSONP",params:params})},getSLine:function(stockCode){var params={type:"sline",stockCode:stockCode,callback:"JSON_CALLBACK"};return $http({url:URLService.getURL("stockServer"),method:"JSONP",params:params})},getKLine:function(stockCode){var timeGe=Date.now(),timeLe=timeGe-7776e6,params={type:"kline",stockCode:stockCode,timeGe:timeGe,timeLe:timeLe,callback:"JSON_CALLBACK"};return $http({url:URLService.getURL("stockServer"),method:"JSONP",params:params})},getStockInfo:function(stockCode){var params={type:"info",stockCode:stockCode,callback:"JSON_CALLBACK"};return $http({url:URLService.getURL("stockServer"),method:"JSONP",params:params})},getWMKline:function(stockCode,type){var params={stockCode:stockCode,type:type};return $http({url:URLService.getURL("stockServer"),method:"GET",params:params})}}}),myServices.factory("SystemService",function($http,URLService){var holidays={CNY:{}},TRADEPERIOD={},PERIOD={DEFER:[["09:30","15:30"]],STOCK:[["09:30","11:30"],["13:00","15:00"]]},systemTime=Date.now(),currencyType="CNY";return window.setInterval(function(){systemTime+=1e3},1e3),{getServerTime:function(){return $http({url:URLService.getURL("getServerTime"),method:"GET"})},getCurrentTime:function(){return systemTime},setCurrentTime:function(time){var hour=(new Date).getTimezoneOffset();systemTime=time+6e4*(480+hour)},setCurrentCurrencyType:function(type){currencyType=type},setHoliday:function(holiday){holidays[currencyType]=holiday},setTradePeriod:function(period){TRADEPERIOD=period},isHoliday:function(time){time&&!X.isDate(time)&&(time=new Date(time));var holiday=holidays[currencyType],now=time||new Date(systemTime),year=holiday[now.getFullYear()];if(!year)return!1;var month=year[now.getMonth()+1];if(!month)return!1;var date=now.getDate();return month.indexOf(date)!=-1},isWeekend:function(time){time=time||new Date(systemTime),time=X.isDate(time)?time:new Date(time);var t=time.getDay();return 0===t||6===t},parseHoliday:function(str){if(str){var h={},arr=str.split(",");return arr.forEach(function(dateStr){var dateArr=dateStr.split("-"),year=dateArr[0]-0,month=dateArr[1]-0,day=dateArr[2]-0;h[year]?h[year][month]?h[year][month].push(day):h[year][month]=[day]:(h[year]={},h[year][month]=[day])}),h}},parsePeriod:function(strPeriod){if(strPeriod){var outer=strPeriod.split(";"),retOuter=[];return outer.forEach(function(str){var inner=str.split("|"),retInner=[];inner.forEach(function(time){var times=time.split(",");4==times[0].length&&(times[0]="0"+times[0]),4==times[1].length&&(times[1]="0"+times[1]),retInner.push(times)}),retOuter.push(retInner)}),1==retOuter.length&&(retOuter=retOuter[0]),retOuter}},getQueryPeriod:function(commNo,type){return"trade"==type?TRADEPERIOD:PERIOD[commNo]},getRealPeriod:function(commNo,time,type){var period=this.getQueryPeriod(commNo,type);if(X.isArray(period[0][0])){var bp=period[0],ep=period[1],bbt=bp[0][0].replace(":","")-0,ebt=ep[0][0].replace(":","")-0;period=time>=bbt&&time<ebt?bp:ep}return period},isInPeriod:function(commNo,type){var now=new Date(systemTime),day=now.getDay(),isIn=!1;if(0==day)return isIn;var prevDay=new Date(systemTime).setDate(now.getDate()-1),prevIsHoliday=this.isHoliday(prevDay),isHoliday=this.isHoliday(),time=X.formatDate(now,"h:m"),period=this.getRealPeriod(commNo,time.replace(":","")-0,type);return period.forEach(function(t){var bTime=t[0],eTime=t[1];"00:00"===bTime&&time>=bTime&&time<eTime?prevIsHoliday||1==day||(isIn=!0):6!=day&&time>=bTime&&time<eTime&&(isIn=!isHoliday)}),isIn},isInJJPeriod:function(){var now=new Date(systemTime),time=X.formatDate(now,"h:m"),period=["09:00","09:30"];return time>=period[0]&&time<=period[1]},isInDYTipPeriod:function(){var now=new Date(systemTime),time=X.formatDate(now,"h:m"),period=["14:30","14:50"];return time>=period[0]&&time<=period[1]},cellPhoneNumber:function(){var now=new Date(systemTime),time=X.formatDate(now,"h:m"),period=["17:30","21:00"],obj={cellPhone:"057128834670",cellPhoneATag:"tel:057128834670"};return time>=period[0]&&time<=period[1]&&(obj.cellPhone="15575990597",obj.cellPhoneATag="tel:15575990597"),obj},getTipsForNextTime:function(commNo){function nextTradeDay(){var day=0;do day++,now.setDate(now.getDate()+1);while(t.isWeekend(now)||t.isHoliday(now));nextTime=beginTime,nextDay=day<=1?"明天":X.formatDate(now,"M月D日")}var t=this,now=new Date(systemTime),time=X.formatDate(now,"h:m"),period=this.getQueryPeriod(commNo,"trade");X.isArray(period[0][0])&&(period=period[0].slice().concat(period[1]));var i,nextTime,len=period.length;for(i=0;i<len;i++){var timePeriod=period[i],bt=timePeriod[0];if("00:00"!==bt&&time<bt){nextTime=bt;break}}var beginTime=period[0][0],endTime=period[period.length-1][1],nextDay="今天";return(t.isWeekend(now)||t.isHoliday(now)||endTime>beginTime&&time>=endTime)&&nextTradeDay(),"下次交易时间为"+nextDay+nextTime},getTipsForTradeStopTime:function(commNo){var now=new Date(systemTime),time=X.formatDate(now,"h:m"),period=this.getRealPeriod(commNo,time.replace(":","")-0,"trade"),stopTime=period[period.length-1][1];return"持仓时间至"+stopTime},uuid:function(len){var r="0Aa1Bb2Cc3Dd4Ee5Ff6Gg7Hh8Ii9Jj0Kk1Ll2Mm3Nn4Oo5Pp6Qq7Rr8Ss9Tt0Uu1Vv2Ww3Xx4Yy5Zz6789",l=r.length,ret="";for(len=len||20;len--;)ret+=r.charAt(Math.random()*l|0);return ret},getProvince:function(){var province=[["1","北京市"],["2","天津市"],["3","河北省"],["4","山西省"],["5","内蒙古自治区"],["6","辽宁省"],["7","吉林省"],["8","黑龙江省"],["9","上海市"],["10","江苏省"],["11","浙江省"],["12","安徽省"],["13","福建省"],["14","江西省"],["15","山东省"],["16","河南省"],["17","湖北省"],["18","湖南省"],["19","广东省"],["20","广西壮族自治区"],["21","海南省"],["22","重庆市"],["23","四川省"],["24","贵州省"],["25","云南省"],["26","西藏自治区"],["27","陕西省"],["28","甘肃省"],["29","青海省"],["30","宁夏回族自治区"],["31","新疆维吾尔自治区"],["32","香港特别行政区"],["33","澳门特别行政区"],["34","台湾省"]];return province},getCities:function(){var cities=[["1","1","北京市","100000"],["2","2","天津市","100000"],["3","3","石家庄市","050000"],["3","4","唐山市","063000"],["3","5","秦皇岛市","066000"],["3","6","邯郸市","056000"],["3","7","邢台市","054000"],["3","8","保定市","071000"],["3","9","张家口市","075000"],["3","10","承德市","067000"],["3","11","沧州市","061000"],["3","12","廊坊市","065000"],["3","13","衡水市","053000"],["4","14","太原市","030000"],["4","15","大同市","037000"],["4","16","阳泉市","045000"],["4","17","长治市","046000"],["4","18","晋城市","048000"],["4","19","朔州市","036000"],["4","20","晋中市","030600"],["4","21","运城市","044000"],["4","22","忻州市","034000"],["4","23","临汾市","041000"],["4","24","吕梁市","030500"],["5","25","呼和浩特市","010000"],["5","26","包头市","014000"],["5","27","乌海市","016000"],["5","28","赤峰市","024000"],["5","29","通辽市","028000"],["5","30","鄂尔多斯市","010300"],["5","31","呼伦贝尔市","021000"],["5","32","巴彦淖尔市","014400"],["5","33","乌兰察布市","011800"],["5","34","兴安盟","137500"],["5","35","锡林郭勒盟","011100"],["5","36","阿拉善盟","016000"],["6","37","沈阳市","110000"],["6","38","大连市","116000"],["6","39","鞍山市","114000"],["6","40","抚顺市","113000"],["6","41","本溪市","117000"],["6","42","丹东市","118000"],["6","43","锦州市","121000"],["6","44","营口市","115000"],["6","45","阜新市","123000"],["6","46","辽阳市","111000"],["6","47","盘锦市","124000"],["6","48","铁岭市","112000"],["6","49","朝阳市","122000"],["6","50","葫芦岛市","125000"],["7","51","长春市","130000"],["7","52","吉林市","132000"],["7","53","四平市","136000"],["7","54","辽源市","136200"],["7","55","通化市","134000"],["7","56","白山市","134300"],["7","57","松原市","131100"],["7","58","白城市","137000"],["7","59","延边州","133000"],["8","60","哈尔滨市","150000"],["8","61","齐齐哈尔市","161000"],["8","62","鸡西市","158100"],["8","63","鹤岗市","154100"],["8","64","双鸭山市","155100"],["8","65","大庆市","163000"],["8","66","伊春市","152300"],["8","67","佳木斯市","154000"],["8","68","七台河市","154600"],["8","69","牡丹江市","157000"],["8","70","黑河市","164300"],["8","71","绥化市","152000"],["8","72","大兴安岭地区","165000"],["9","73","上海市","200000"],["10","74","南京市","210000"],["10","75","无锡市","214000"],["10","76","徐州市","221000"],["10","77","常州市","213000"],["10","78","苏州市","215000"],["10","79","南通市","226000"],["10","80","连云港市","222000"],["10","81","淮安市","223200"],["10","82","盐城市","224000"],["10","83","扬州市","225000"],["10","84","镇江市","212000"],["10","85","泰州市","225300"],["10","86","宿迁市","223800"],["11","87","杭州市","310000"],["11","88","宁波市","315000"],["11","89","温州市","325000"],["11","90","嘉兴市","314000"],["11","91","湖州市","313000"],["11","92","绍兴市","312000"],["11","93","金华市","321000"],["11","94","衢州市","324000"],["11","95","舟山市","316000"],["11","96","台州市","318000"],["11","97","丽水市","323000"],["12","98","合肥市","230000"],["12","99","芜湖市","241000"],["12","100","蚌埠市","233000"],["12","101","淮南市","232000"],["12","102","马鞍山市","243000"],["12","103","淮北市","235000"],["12","104","铜陵市","244000"],["12","105","安庆市","246000"],["12","106","黄山市","242700"],["12","107","滁州市","239000"],["12","108","阜阳市","236100"],["12","109","宿州市","234100"],["12","110","巢湖市","238000"],["12","111","六安市","237000"],["12","112","亳州市","236800"],["12","113","池州市","247100"],["12","114","宣城市","366000"],["13","115","福州市","350000"],["13","116","厦门市","361000"],["13","117","莆田市","351100"],["13","118","三明市","365000"],["13","119","泉州市","362000"],["13","120","漳州市","363000"],["13","121","南平市","353000"],["13","122","龙岩市","364000"],["13","123","宁德市","352100"],["14","124","南昌市","330000"],["14","125","景德镇市","333000"],["14","126","萍乡市","337000"],["14","127","九江市","332000"],["14","128","新余市","338000"],["14","129","鹰潭市","335000"],["14","130","赣州市","341000"],["14","131","吉安市","343000"],["14","132","宜春市","336000"],["14","133","抚州市","332900"],["14","134","上饶市","334000"],["15","135","济南市","250000"],["15","136","青岛市","266000"],["15","137","淄博市","255000"],["15","138","枣庄市","277100"],["15","139","东营市","257000"],["15","140","烟台市","264000"],["15","141","潍坊市","261000"],["15","142","济宁市","272100"],["15","143","泰安市","271000"],["15","144","威海市","265700"],["15","145","日照市","276800"],["15","146","莱芜市","271100"],["15","147","临沂市","276000"],["15","148","德州市","253000"],["15","149","聊城市","252000"],["15","150","滨州市","256600"],["15","151","菏泽市","255000"],["16","152","郑州市","450000"],["16","153","开封市","475000"],["16","154","洛阳市","471000"],["16","155","平顶山市","467000"],["16","156","安阳市","454900"],["16","157","鹤壁市","456600"],["16","158","新乡市","453000"],["16","159","焦作市","454100"],["16","160","濮阳市","457000"],["16","161","许昌市","461000"],["16","162","漯河市","462000"],["16","163","三门峡市","472000"],["16","164","南阳市","473000"],["16","165","商丘市","476000"],["16","166","信阳市","464000"],["16","167","周口市","466000"],["16","168","驻马店市","463000"],["17","169","武汉市","430000"],["17","170","黄石市","435000"],["17","171","十堰市","442000"],["17","172","宜昌市","443000"],["17","173","襄樊市","441000"],["17","174","鄂州市","436000"],["17","175","荆门市","448000"],["17","176","孝感市","432100"],["17","177","荆州市","434000"],["17","178","黄冈市","438000"],["17","179","咸宁市","437000"],["17","180","随州市","441300"],["17","181","恩施州","445000"],["17","182","神农架","442400"],["18","183","长沙市","410000"],["18","184","株洲市","412000"],["18","185","湘潭市","411100"],["18","186","衡阳市","421000"],["18","187","邵阳市","422000"],["18","188","岳阳市","414000"],["18","189","常德市","415000"],["18","190","张家界市","427000"],["18","191","益阳市","413000"],["18","192","郴州市","423000"],["18","193","永州市","425000"],["18","194","怀化市","418000"],["18","195","娄底市","417000"],["18","196","湘西土家族苗族自治州","416000"],["19","197","广州市","510000"],["19","198","韶关市","521000"],["19","199","深圳市","518000"],["19","200","珠海市","519000"],["19","201","汕头市","515000"],["19","202","佛山市","528000"],["19","203","江门市","529000"],["19","204","湛江市","524000"],["19","205","茂名市","525000"],["19","206","肇庆市","526000"],["19","207","惠州市","516000"],["19","208","梅州市","514000"],["19","209","汕尾市","516600"],["19","210","河源市","517000"],["19","211","阳江市","529500"],["19","212","清远市","511500"],["19","213","东莞市","511700"],["19","214","中山市","528400"],["19","215","潮州市","515600"],["19","216","揭阳市","522000"],["19","217","云浮市","527300"],["20","218","南宁市","530000"],["20","219","柳州市","545000"],["20","220","桂林市","541000"],["20","221","梧州市","543000"],["20","222","北海市","536000"],["20","223","防城港市","538000"],["20","224","钦州市","535000"],["20","225","贵港市","537100"],["20","226","玉林市","537000"],["20","227","百色市","533000"],["20","228","贺州市","542800"],["20","229","河池市","547000"],["20","230","来宾市","546100"],["20","231","崇左市","532200"],["21","232","海口市","570000"],["21","233","三亚市","572000"],["22","234","重庆市","400000"],["23","235","成都市","610000"],["23","236","自贡市","643000"],["23","237","攀枝花市","617000"],["23","238","泸州市","646100"],["23","239","德阳市","618000"],["23","240","绵阳市","621000"],["23","241","广元市","628000"],["23","242","遂宁市","629000"],["23","243","内江市","641000"],["23","244","乐山市","614000"],["23","245","南充市","637000"],["23","246","眉山市","612100"],["23","247","宜宾市","644000"],["23","248","广安市","638000"],["23","249","达州市","635000"],["23","250","雅安市","625000"],["23","251","巴中市","635500"],["23","252","资阳市","641300"],["23","253","阿坝藏族羌族自治州","624600"],["23","254","甘孜藏族自治州","626000"],["23","255","凉山州","615000"],["24","256","贵阳市","55000"],["24","257","六盘水市","553000"],["24","258","遵义市","563000"],["24","259","安顺市","561000"],["24","260","铜仁地区","554300"],["24","261","黔西南州","551500"],["24","262","毕节地区","551700"],["24","263","黔东南州","551500"],["24","264","黔南州","550100"],["25","265","昆明市","650000"],["25","266","曲靖市","655000"],["25","267","玉溪市","653100"],["25","268","保山市","678000"],["25","269","昭通市","657000"],["25","270","丽江市","674100"],["25","271","思茅市","665000"],["25","272","临沧市","677000"],["25","273","楚雄州","675000"],["25","274","红河州","654400"],["25","275","文山州","663000"],["25","276","西双版纳州","666200"],["25","277","大理州","671000"],["25","278","德宏州","678400"],["25","279","怒江州","671400"],["25","280","迪庆州","674400"],["26","281","拉萨市","850000"],["26","282","昌都地区","854000"],["26","283","山南地区","856000"],["26","284","日喀则地区","857000"],["26","285","那曲地区","852000"],["26","286","阿里地区","859100"],["26","287","林芝地区","860100"],["27","288","西安市","710000"],["27","289","铜川市","727000"],["27","290","宝鸡市","721000"],["27","291","咸阳市","712000"],["27","292","渭南市","714000"],["27","293","延安市","716000"],["27","294","汉中市","723000"],["27","295","榆林市","719000"],["27","296","安康市","725000"],["27","297","商洛市","711500"],["28","298","兰州市","730000"],["28","299","嘉峪关市","735100"],["28","300","金昌市","737100"],["28","301","白银市","730900"],["28","302","天水市","741000"],["28","303","武威市","733000"],["28","304","张掖市","734000"],["28","305","平凉市","744000"],["28","306","酒泉市","735000"],["28","307","庆阳市","744500"],["28","308","定西市","743000"],["28","309","陇南市","742100"],["28","310","临夏回族自治州","731100"],["28","311","甘南藏族自治州","747000"],["29","312","西宁市","810000"],["29","313","海东地区","810600"],["29","314","海北藏族自治州","810300"],["29","315","黄南藏族自治州","811300"],["29","316","海南藏族自治州","813000"],["29","317","果洛藏族自治州","814000"],["29","318","玉树藏族自治州","815000"],["29","319","海西蒙古族藏族自治州","817000"],["30","320","银川市","750000"],["30","321","石嘴山市","753000"],["30","322","吴忠市","751100"],["30","323","固原市","756000"],["30","324","中卫市","751700"],["31","325","乌鲁木齐市","830000"],["31","326","克拉玛依市","834000"],["31","327","吐鲁番地区","838000"],["31","328","哈密地区","839000"],["31","329","昌吉回族自治州","831100"],["31","330","博尔塔拉蒙古自治州","833400"],["31","331","巴音郭楞蒙古自治州","841000"],["31","332","阿克苏地区","843000"],["31","333","克孜勒苏柯尔克孜自治州","835600"],["31","334","喀什地区","844000"],["31","335","和田地区","848000"],["31","336","伊犁哈萨克自治州","833200"],["31","337","塔城地区","834700"],["31","338","阿勒泰地区","836500"],["31","339","石河子市","832000"],["31","340","阿拉尔市","843300"],["31","341","图木舒克市","843900"],["31","342","五家渠市","831300"],["32","343","香港特别行政区","000000"],["33","344","澳门特别行政区","000000"],["34","345","台湾省","000000"]];
return cities}}}),myServices.factory("AuthService",function(){var sessionStorage=window.sessionStorage;return{auth:function(){var session=sessionStorage.getItem("sessionID"),now=Date.now(),timeOut=72e5;if(!session)return!1;var sessionArr=session.split("#"),lastLoginTime=sessionArr[1];return now-lastLoginTime>timeOut?(sessionStorage.removeItem("sessionID"),!1):(sessionArr[1]=now,sessionStorage.setItem("sessionID",sessionArr.join("#")),!0)},signIn:function(userID){var authStr=[userID,Date.now()].join("#");sessionStorage.setItem("sessionID",authStr)},signOut:function(){sessionStorage.removeItem("sessionID")}}}),myServices.factory("myInterceptor",function($location,AuthService){var interceptor={request:function(config){return config},response:function(response){return"GET"==response.config.method&&"/trade/scheme/getHoldingScheme.json"==response.config.url?response:(X.isObject(response.data)&&(100==response.data.code?AuthService.auth():405==response.data.code&&(AuthService.signOut(),$location.path("/login").replace())),response)},requestError:function(rejection){return rejection},responseError:function(rejection){return rejection}};return interceptor}),myServices.factory("RankService",function($http,$httpParamSerializerJQLike,URLService){return{getRank:function(type){var url="day"==type?URLService.getURL("getUserRank"):URLService.getURL("getUnionRank"),params={device:1};return $http({method:"GET",url:url,params:params})}}}),myServices.factory("PacketService",function($http,$httpParamSerializerJQLike,URLService){return{getPacketInfoData:function(activityId){var params={device:1,agentCode:"yztz",activityId:activityId};return $http({method:"GET",url:URLService.getURL("getPacketInfo"),params:params})},receivePacketData:function(params){return params.device=1,params.agentCode="YZTZ",$http({method:"POST",url:URLService.getURL("receivePacket"),params:params})},getPacketFundInfoData:function(){var params={device:1};return $http({method:"GET",url:URLService.getURL("getPacketFundInfo"),params:params})},getPacketRecordListData:function(){var params={device:1};return $http({method:"GET",url:URLService.getURL("getPacketRecordList"),params:params})}}}),myServices.factory("ActivityService",function($http,$httpParamSerializerJQLike,URLService){return{getActivityListData:function(){var params={device:1,agentCode:"yztz"};return $http({method:"GET",url:URLService.getURL("getActivityList"),params:params})}}});var myDirectives=angular.module("myDirectives",[]);myDirectives.directive("commonTitle",function(){return{restrict:"EA",replace:!0,template:function(){var html="";return html+="<h3>",html+='<span ng-click="showMenu=!showMenu">{{stockType}}点买A股',html+=' <i ng-if="!showMenu" class="iconfont">&#xe608;</i><i ng-if="showMenu" class="iconfont">&#xe609;</i>',html+="</span>",html+="</h3>"}}}),myDirectives.directive("commonMenu",function(){return{restrict:"EA",replace:!0,template:function(){var html="";return html+='<div ng-show="showMenu" ng-click="showMenu=false;" class="mod-stockType-list db-bg" style="z-index: 99;">',html+='<div class="wrap">',html+='<a ng-repeat="(key, value) in stockTypes" href="#/{{key}}" ng-if="value != stockType">{{value}}点买A股</a>',html+="</div>",html+="</div>"}}}),myDirectives.directive("dialog",function(){return{restrict:"EA",replace:!0,transclude:!0,template:'<div class="db-bg" ng-transclude style="z-index: 10000"></div>'}}),myDirectives.directive("call",function(SystemService){return{restrict:"EA",replace:!0,transclude:!0,template:'<a ng-click="getTime()" href={{cellPhone.cellPhoneATag}} ng-transclude class="nav-right"><i class="icon-tel"></i></a>',link:function($scope){$scope.getTime=function(){$scope.cellPhone=SystemService.cellPhoneNumber()},$scope.getTime()}}}),myDirectives.directive("slide",function($timeout){return{restrict:"EA",replace:!0,transclude:!0,template:'<div class="mod-slide" ng-transclude  ng-swipe-right="swipeRight();" ng-swipe-left="swipeLeft();"></div>',link:function($scope,$el){function swipe(dir){clearTimer();var next="L"==dir?index+1:index-1;next=next<0?len-1:next>len-1?0:next,li.eq(index).animate({left:"L"==dir?"-100%":"100%"}),menu.removeClass("curr"),menu.eq(next).addClass("curr"),li.eq(next).css({left:"L"==dir?"100%":"-100%"}).animate({left:"0"},function(){index=next}),timer=$timeout(function(){$scope.swipeLeft()},3e3)}function createMenu(){for(var menu='<ul class="slide-menu">',i=0;i<len;i++)menu+="<li></li>";menu+="</ul>",$el.append(menu)}function clearTimer(){timer&&$timeout.cancel(timer),timer=null}var timer,index=0,li=$el.find("ul.slide-wrap > li"),len=li.length;if(createMenu(),!(len<2)){var menu=$el.find("ul.slide-menu > li");li.css("left","100%"),li.eq(0).css("left",0),menu.eq(0).addClass("curr"),$scope.swipeRight=function(){swipe("R")},$scope.swipeLeft=function(){swipe("L")},timer=$timeout(function(){$scope.swipeLeft()},3e3),$scope.$on("$destroy",function(){clearTimer()})}}}}),myDirectives.directive("backMenu",function($location){return{restrict:"EA",replace:!0,template:function(){var backURL=$location.search().backURL,historyLen=window.history.length;return historyLen<2&&(backURL="/index"),backURL?'<a href="#'+backURL+'" class="nav-left"><i class="icon-back"></i></a>':'<a href="javascript:window.history.back();" class="nav-left"><i class="icon-back"></i></a>'}}});